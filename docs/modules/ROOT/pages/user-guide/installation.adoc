= Installation et Déploiement

Ce guide décrit comment installer les prérequis et déployer l'application EXAI sur votre machine locale en utilisant Minikube.

== Prérequis

Avant de commencer, assurez-vous d'avoir les outils suivants installés et fonctionnels :

*   **Docker Desktop**: Pour la gestion des conteneurs.
*   **kubectl**: L'outil en ligne de commande pour interagir avec Kubernetes.
*   **Minikube**: Pour créer un cluster Kubernetes local.
*   **Terminal Bash**: Recommandé pour exécuter les commandes (Git Bash sous Windows, ou terminal natif sous macOS/Linux).

=== Installation des outils (Minikube & kubectl)

*   **Windows (avec Chocolatey)**:

[source,powershell]
----
choco install minikube
choco install kubernetes-cli
----

*   **macOS (avec Homebrew)**:

[source,bash]
----
brew install minikube
brew install kubectl
----

*   **Linux (Debian/Ubuntu)**:

[source,bash]
----
# Installer Minikube
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
sudo install minikube-linux-amd64 /usr/local/bin/minikube

# Installer kubectl
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
----

== Déploiement Complet avec Minikube

C'est la méthode recommandée pour tester l'architecture microservices complète.

.   **Démarrer Minikube**:

Ouvrez votre terminal et lancez :

[source,bash]
----
minikube start
# Optionnel : spécifier le driver si nécessaire
# minikube start --driver=docker
----

Vérifiez que le cluster est bien démarré :

[source,bash]
----
minikube status
kubectl get nodes
----

.   **Créer le Namespace `exai`**:

Nous isolons les ressources Kubernetes dans un namespace dédié.

[source,bash]
----
kubectl create namespace exai
----

NOTE: Si le namespace existe déjà, une erreur s'affichera, ce qui est normal.

.   **Déployer PostgreSQL**:

La base de données est la première dépendance.

[source,bash]
----
kubectl apply -f k8s/postgres/ -n exai
----

Vérifiez le démarrage du pod PostgreSQL (il doit passer en statut `Running`) :

[source,bash]
----
kubectl get pods -n exai
----

.   **Initialiser la Base de Données PostgreSQL**:

Une fois le pod PostgreSQL lancé (`Running`), exécutez le script d'initialisation.

*   Trouvez le nom exact du pod PostgreSQL :

[source,bash]
----
kubectl get pods -n exai | grep postgresql
# Copiez le nom complet du pod (ex: postgresql-deployment-xxxxx-yyyyy)
----

*   Copiez le script SQL dans le pod :

[source,bash]
----
kubectl cp k8s/postgres/init-db.sql <NOM_DU_POD_POSTGRES>:/tmp/init-db.sql -n exai
# Remplacez <NOM_DU_POD_POSTGRES> par le nom copié
----

*   Exécutez le script copié :

[source,bash]
----
kubectl exec -n exai <NOM_DU_POD_POSTGRES> -- psql -U exai_user -d exai_db -f /tmp/init-db.sql
# Remplacez <NOM_DU_POD_POSTGRES> par le nom copié
----

.   **Déployer les Microservices (API Gateway, Service Sélection, ...)**:

Pour chaque microservice (ex: `api-gateway`, `service-selection`) :

*   Configurez votre terminal pour utiliser le Docker de Minikube :

[source,bash]
----
# Pour Linux/macOS (Bash/Zsh)
eval $(minikube -p minikube docker-env)

# Pour Windows PowerShell
# minikube -p minikube docker-env | Invoke-Expression
----

*   Naviguez vers le dossier du service :

[source,bash]
----
cd <nom-du-service>
# ex: cd api-gateway
----

*   Construisez l'image Docker :

[source,bash]
----
docker build -t <nom-image>:<tag> .
# ex: docker build -t exai-api-gateway:latest .
----

*   Appliquez les manifestes Kubernetes :

Assurez-vous que le champ `image:` dans `deployment.yaml` correspond bien à `<nom-image>:<tag>` et que `imagePullPolicy` est `IfNotPresent` ou `Never`.

[source,bash]
----
kubectl apply -f deployment.yaml -n exai
kubectl apply -f service.yaml -n exai
----

*   Vérifiez le déploiement :

[source,bash]
----
kubectl get pods -n exai
kubectl get services -n exai
----

*   Revenez au répertoire racine :

[source,bash]
----
cd ..
----

Répétez ces étapes (les sous-étapes marquées par `*`, depuis la navigation vers le dossier jusqu'au retour à la racine) pour tous les microservices requis.

.   **Accéder aux Services**:

Une fois tous les services déployés, vous pouvez obtenir leur URL d'accès. Voir la section xref:user-guide/api.adoc[Utilisation API] pour plus de détails (notamment `minikube service ...`). 