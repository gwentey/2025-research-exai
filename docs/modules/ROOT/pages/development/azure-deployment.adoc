= Configuration Initiale de l'Infrastructure Azure (Compte Personnel)

Ce guide décrit les étapes pour mettre en place l'environnement Microsoft Azure en utilisant un compte personnel (Pay-As-You-Go) afin d'accueillir l'application EXAI. Cette approche est recommandée pour éviter les limitations potentielles des comptes étudiants sur Azure AD / Entra ID.

== Objectif

Mettre en place les fondations nécessaires sur Azure (Groupe de Ressources, Registre de Conteneurs, Cluster Kubernetes) et configurer l'authentification pour les déploiements automatisés via GitHub Actions.

== Prérequis

*   Un compte Microsoft personnel (non-étudiant) avec un abonnement Azure actif de type "Paiement à l'utilisation" (Pay-As-You-Go).
*   L'outil en ligne de commande Azure CLI installé sur votre machine.

== Étapes de Configuration

=== 1. Connexion et Sélection de l'Abonnement

Assurez-vous d'être connecté à Azure CLI avec votre compte personnel et que votre abonnement Pay-As-You-Go est sélectionné.

[source,bash]
----
az login
az account show # Vérifiez l'abonnement actif
# Si nécessaire, sélectionnez le bon abonnement :
# az account set --subscription "<NOM_OU_ID_ABONNEMENT_PAYG>"
----

=== 2. Création du Groupe de Ressources (Resource Group)

*   **Rôle :** Conteneur logique pour toutes les ressources Azure du projet.
*   **Commande :**
[source,bash]
----
az group create --name exai-perso-rg --location francecentral
----

=== 3. Création du Registre de Conteneurs Azure (ACR)

*   **Rôle :** Stockage privé et sécurisé pour les images Docker des microservices.
*   **Commande :** (Choisissez un nom globalement unique pour `<VOTRE_ACR_NAME>`. Ex: `exaipersoacr`)
[source,bash]
----
az acr create --resource-group exai-perso-rg --name <VOTRE_ACR_NAME> --sku Standard --location francecentral
----
*   Notez le nom du serveur de connexion : `<VOTRE_ACR_NAME>.azurecr.io`.

=== 4. Création du Cluster Kubernetes Azure (AKS)

*   **Rôle :** Orchestrateur pour l'exécution des microservices conteneurisés.
*   **Commande :** (Assurez-vous de remplacer `<VOTRE_ACR_NAME>` par le nom choisi à l'étape précédente)
[source,bash]
----
az aks create --resource-group exai-perso-rg --name exai-perso-aks --node-count 1 --node-vm-size Standard_B2s --location francecentral --attach-acr <VOTRE_ACR_NAME> --enable-managed-identity --enable-addons monitoring --generate-ssh-keys
----

=== 5. Création du Service Principal pour GitHub Actions

*   **Rôle :** Permettre à GitHub Actions de s'authentifier sur Azure pour déployer.
*   **Commande :** (Remplacez `<ID_DE_VOTRE_ABONNEMENT_PAYG>` par l'ID de votre abonnement personnel)
[source,bash]
----
az ad sp create-for-rbac --name "exai-perso-github-sp" --role "Contributor" --scopes "/subscriptions/<ID_DE_VOTRE_ABONNEMENT_PAYG>"
----
*   **Action Cruciale :** Copiez **intégralement** le bloc JSON affiché en sortie. Vous en aurez besoin à l'étape suivante.

=== 6. Configuration du Secret GitHub `AZURE_CREDENTIALS`

*   Allez dans les paramètres de votre dépôt GitHub > Secrets and variables > Actions.
*   Créez ou mettez à jour un secret nommé `AZURE_CREDENTIALS`.
*   Collez le **JSON complet** obtenu à l'étape 5 comme valeur pour ce secret.

=== 7. Configuration de `kubectl` Localement

*   **Rôle :** Permettre à votre outil `kubectl` local de communiquer avec le nouveau cluster AKS.
*   **Commande :**
[source,bash]
----
az aks get-credentials --resource-group exai-perso-rg --name exai-perso-aks --overwrite-existing
----

== Déploiement Automatisé avec GitHub Actions

Avec l'infrastructure et l'authentification en place, le déploiement est géré par le workflow défini dans `.github/workflows/deploy-production.yml`.

Ce workflow va automatiquement :

1.  Builder les images Docker pour chaque service.
2.  Pousser les images vers votre ACR (`<VOTRE_ACR_NAME>.azurecr.io`).
3.  S'authentifier sur Azure en utilisant le secret `AZURE_CREDENTIALS`.
4.  Configurer `kubectl` pour cibler votre cluster AKS.
5.  Exécuter le Job de migration de base de données Alembic.
6.  Attendre la fin du Job de migration.
7.  Déployer les applications (API Gateway, Frontend, etc.) sur AKS en utilisant Skaffold avec le profil `azure`.

Assurez-vous que les variables d'environnement dans le fichier de workflow (comme `AZURE_RESOURCE_GROUP`, `AKS_CLUSTER_NAME`, `AZURE_CONTAINER_REGISTRY`) correspondent aux noms que vous avez utilisés lors de la création des ressources.

== Prochaines Étapes

L'infrastructure de base et le pipeline de déploiement étant fonctionnels, les prochaines étapes peuvent inclure :

*   Configuration avancée du réseau (Ingress Controller, règles de pare-feu).
*   Mise en place de stratégies de monitoring et d'alerting plus détaillées.
*   Optimisation des coûts et des ressources. 