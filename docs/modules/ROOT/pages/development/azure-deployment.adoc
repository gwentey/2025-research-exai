= DÃ©ploiement AutomatisÃ© de l'Infrastructure Azure IBIS-X

Ce guide dÃ©crit le processus de dÃ©ploiement automatisÃ© complet de l'application IBIS-X sur Microsoft Azure en utilisant les scripts Terraform optimisÃ©s et les outils d'orchestration Kubernetes.

== ğŸš€ Nouvelle Approche : DÃ©ploiement 100% AutomatisÃ© et Robuste

Nous avons dÃ©veloppÃ© un script de dÃ©ploiement entiÃ¨rement automatisÃ© qui gÃ¨re :

- âœ… **Installation automatique de Helm** si non prÃ©sent
- âœ… **CrÃ©ation de l'infrastructure Azure** via Terraform
- âœ… **Installation de NGINX Ingress Controller** via Helm
- âœ… **Installation de Cert-Manager** pour les certificats SSL/TLS automatiques
- âœ… **Configuration des rÃ¨gles de sÃ©curitÃ© rÃ©seau** (ports 80, 443, 22)
- âœ… **DÃ©ploiement des applications** avec Kustomize
- âœ… **ExÃ©cution des migrations de base de donnÃ©es**
- ğŸ†• **Import robuste des datasets Kaggle** avec gestion des timeouts
- ğŸ†• **Retry automatique** pour builds Docker et opÃ©rations Kubernetes
- ğŸ†• **Diagnostic automatique** et fallback intelligent en cas de problÃ¨me
- ğŸ†• **Continuation du dÃ©ploiement** mÃªme en cas de timeout des jobs longs

== Objectif

DÃ©ployer rapidement et de maniÃ¨re reproductible l'ensemble de l'infrastructure et des applications IBIS-X sur Azure avec une seule commande.

== PrÃ©requis

* Un compte Microsoft Azure avec un abonnement Pay-As-You-Go actif
* Azure CLI installÃ© et configurÃ©
* Docker installÃ© et en cours d'exÃ©cution
* AccÃ¨s en Ã©criture au repository Git du projet

== ğŸ”§ PrÃ©paration du DÃ©ploiement

=== 1. Nettoyage de l'Infrastructure Existante (si nÃ©cessaire)

Si vous avez dÃ©jÃ  dÃ©ployÃ© manuellement des ressources IBIS-X, commencez par les nettoyer :

[source,bash]
----
# Nettoyer l'infrastructure existante
./scripts/destroy-azure-infrastructure.sh
----

âš ï¸ **ATTENTION**: Cette commande supprime DÃ‰FINITIVEMENT toutes les ressources Azure existantes. Sauvegardez vos donnÃ©es importantes avant de continuer.

=== 2. Configuration des Variables Terraform

Le script va automatiquement crÃ©er le fichier `terraform.tfvars` s'il n'existe pas, mais vous pouvez le prÃ©parer :

[source,bash]
----
cd terraform/azure-infrastructure/
cp terraform.tfvars.example terraform.tfvars
----

Ã‰ditez le fichier selon vos besoins. Les valeurs par dÃ©faut sont optimisÃ©es pour IBIS-X :

[source,terraform]
----
project_name = "ibis-x"
environment  = "prod"
location     = "East US"
aks_node_count = 2
aks_node_vm_size = "Standard_D2s_v3"
----

== ğŸš€ DÃ©ploiement Automatique

=== Lancement du DÃ©ploiement Complet

Une seule commande pour tout dÃ©ployer :

[source,bash]
----
./scripts/deploy-to-azure.sh
----

== ğŸ“‹ Processus de DÃ©ploiement DÃ©taillÃ©

Le script automatisÃ© exÃ©cute les Ã©tapes suivantes :

=== 1. **VÃ©rification des PrÃ©requis**
- VÃ©rifie la prÃ©sence d'Azure CLI, Terraform, kubectl, Docker
- Installe automatiquement Helm si nÃ©cessaire

=== 2. **Configuration Azure**
- VÃ©rifie la connexion Ã  Azure
- Affiche l'abonnement actuel

=== 3. **Infrastructure Terraform**
- Initialise Terraform
- GÃ©nÃ¨re et affiche le plan de dÃ©ploiement
- CrÃ©e toutes les ressources Azure :
  * Groupe de ressources
  * Cluster AKS avec rÃ©seau virtuel
  * Azure Container Registry
  * Compte de stockage Azure
  * IP publique
  * RÃ¨gles de sÃ©curitÃ© rÃ©seau (ports 80, 443, 22)
  * Log Analytics et Application Insights

=== 4. **Configuration Kubernetes**
- Configure kubectl pour le cluster AKS
- Installe NGINX Ingress Controller via Helm
- Installe Cert-Manager via Helm pour les certificats SSL automatiques

=== 5. **Construction et Push des Images**
- Construit les images Docker pour :
  * `ibis-x-api-gateway`
  * `ibis-x-service-selection`
  * `ibis-x-frontend`
- Les pousse vers Azure Container Registry

=== 6. **DÃ©ploiement des Applications**
- Met Ã  jour automatiquement tous les noms de projet (IBIS-X â†’ IBIS-X)
- DÃ©ploie les applications via Kustomize
- Attend que tous les pods soient prÃªts

=== 7. **Migrations de Base de DonnÃ©es**
- ExÃ©cute les jobs de migration Alembic
- VÃ©rifie la complÃ©tion des migrations

=== 8. **Import Robuste des Datasets Kaggle**
- Lance le job d'import avec timeouts Ã©tendus (60 minutes)
- Surveille l'exÃ©cution avec logs en temps rÃ©el
- GÃ¨re automatiquement les timeouts avec fallback intelligent
- Continue le dÃ©ploiement mÃªme si l'import prend du temps
- Fournit les commandes pour suivi/relance manuel si nÃ©cessaire

== ğŸ“Š Informations Post-DÃ©ploiement

Ã€ la fin du dÃ©ploiement, le script affiche :

[source,text]
----
ğŸ‰ DÃ©ploiement IBIS-X terminÃ© avec succÃ¨s !

ğŸ“‹ Informations de l'application :
==================================
ğŸŒ URL de l'application: https://ibisx.fr
ğŸŒ URL de l'API: https://api.ibisx.fr
ğŸŒ URL HTTP (temporaire): http://<IP_PUBLIQUE>
ğŸ—„ï¸  Storage Account: <nom_compte>
ğŸ³ Container Registry: <nom_acr>.azurecr.io
â˜¸ï¸  Cluster AKS: <nom_cluster>
ğŸ“¦ Resource Group: <nom_groupe_ressources>
----

== ğŸ” VÃ©rification du DÃ©ploiement

=== VÃ©rifier les Pods
[source,bash]
----
kubectl get pods -n ibis-x
----

=== VÃ©rifier l'Ingress et les Certificats SSL
[source,bash]
----
kubectl get ingress -n ibis-x
kubectl get certificates -n ibis-x
----

=== VÃ©rifier les Services
[source,bash]
----
kubectl get services -n ibis-x
kubectl get services -n ingress-nginx
----

== ğŸŒ Configuration DNS

Pour activer les certificats SSL automatiques, configurez vos enregistrements DNS :

[source,text]
----
A    ibisx.fr        -> <IP_PUBLIQUE>
A    api.ibisx.fr    -> <IP_PUBLIQUE>
----

Les certificats Let's Encrypt se gÃ©nÃ¨reront automatiquement une fois les DNS configurÃ©s.

== ğŸ”§ Maintenance et Debugging

=== Voir les Logs
[source,bash]
----
# Logs des applications
kubectl logs -f deployment/api-gateway -n ibis-x
kubectl logs -f deployment/service-selection -n ibis-x
kubectl logs -f deployment/frontend -n ibis-x

# Logs de l'Ingress Controller
kubectl logs -f deployment/ingress-nginx-controller -n ingress-nginx

# Logs de Cert-Manager
kubectl logs -f deployment/cert-manager -n cert-manager
----

=== RedÃ©marrer les Services
[source,bash]
----
kubectl rollout restart deployment/api-gateway -n ibis-x
kubectl rollout restart deployment/service-selection -n ibis-x
kubectl rollout restart deployment/frontend -n ibis-x
----

== ğŸ—‘ï¸ Nettoyage et Reconstruction

Pour nettoyer complÃ¨tement l'infrastructure et redÃ©ployer :

[source,bash]
----
# 1. Supprimer toute l'infrastructure
./scripts/destroy-azure-infrastructure.sh

# 2. RedÃ©ployer
./scripts/deploy-to-azure.sh
----

== âš ï¸ RÃ©solution des ProblÃ¨mes Courants

=== ProblÃ¨me : Certificats SSL non gÃ©nÃ©rÃ©s
**Solution** : VÃ©rifiez que vos enregistrements DNS pointent vers la bonne IP publique

=== ProblÃ¨me : Pods en Ã©tat "Pending"
**Solution** : VÃ©rifiez les ressources du cluster AKS
[source,bash]
----
kubectl describe nodes
kubectl get events -n ibis-x
----

=== ProblÃ¨me : Images Docker non trouvÃ©es
**Solution** : VÃ©rifiez que les images ont Ã©tÃ© correctement poussÃ©es vers ACR
[source,bash]
----
az acr repository list --name <nom_acr>
----

=== ğŸ†• ProblÃ¨me : Job Kaggle timeout ou Ã©chec
**Solution** : Le script gÃ¨re automatiquement ces cas

[NOTE]
====
**Le dÃ©ploiement continue automatiquement** mÃªme si le job Kaggle prend du temps ou Ã©choue temporairement.
====

[source,bash]
----
# VÃ©rifier le statut du job Kaggle
kubectl get jobs -n ibis-x
kubectl get pods -n ibis-x -l job-name=kaggle-dataset-import-job

# Suivre les logs du job en cours
kubectl logs -f <kaggle-pod-name> -n ibis-x

# Relancer l'import manuellement si nÃ©cessaire
kubectl exec -n ibis-x deployment/service-selection -- python kaggle-import/main.py --force-refresh

# VÃ©rifier les datasets importÃ©s
kubectl exec -n ibis-x deployment/service-selection -- ls -la /app/datasets/
----

=== ğŸ†• ProblÃ¨me : Build Docker Ã©choue
**Solution** : Le script retry automatiquement

[source,bash]
----
# Si le retry automatique Ã©choue, nettoyer Docker manuellement
docker system prune -f
docker builder prune -f

# Puis relancer le script
./scripts/deploy-to-azure.sh
----

== ğŸ¯ Avantages du Nouveau Processus

1. **ReproductibilitÃ©** : DÃ©ploiement identique Ã  chaque fois
2. **RapiditÃ©** : DÃ©ploiement complet en ~15-20 minutes
3. **SÃ©curitÃ©** : Certificats SSL automatiques
4. **Maintenance** : Scripts de nettoyage automatisÃ©s
5. **Monitoring** : IntÃ©gration complÃ¨te avec Azure Monitor
6. ğŸ†• **Robustesse** : Gestion automatique des timeouts et erreurs
7. ğŸ†• **RÃ©silience** : Retry automatique et fallback intelligent
8. ğŸ†• **FiabilitÃ©** : Continue mÃªme en cas de problÃ¨mes temporaires
9. ğŸ†• **Diagnostic** : Logs dÃ©taillÃ©s et instructions de rÃ©cupÃ©ration automatiques

== Prochaines Ã‰tapes

Une fois le dÃ©ploiement terminÃ©, vous pouvez :

1. Configurer le monitoring avancÃ© avec Azure Application Insights
2. Mettre en place des stratÃ©gies de sauvegarde automatisÃ©es
3. Optimiser les performances selon vos besoins spÃ©cifiques
4. Configurer des environnements de staging supplÃ©mentaires 
