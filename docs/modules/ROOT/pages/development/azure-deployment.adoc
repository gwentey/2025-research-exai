= D√©ploiement Automatis√© de l'Infrastructure Azure IBIS-X

Ce guide d√©crit le processus de d√©ploiement automatis√© complet de l'application IBIS-X sur Microsoft Azure en utilisant les scripts Terraform optimis√©s et les outils d'orchestration Kubernetes.

== üöÄ Nouvelle Approche : D√©ploiement 100% Automatis√©

Nous avons d√©velopp√© un script de d√©ploiement enti√®rement automatis√© qui g√®re :

- ‚úÖ **Installation automatique de Helm** si non pr√©sent
- ‚úÖ **Cr√©ation de l'infrastructure Azure** via Terraform
- ‚úÖ **Installation de NGINX Ingress Controller** via Helm
- ‚úÖ **Installation de Cert-Manager** pour les certificats SSL/TLS automatiques
- ‚úÖ **Configuration des r√®gles de s√©curit√© r√©seau** (ports 80, 443, 22)
- ‚úÖ **D√©ploiement des applications** avec Kustomize
- ‚úÖ **Ex√©cution des migrations de base de donn√©es**
- ‚úÖ **Changement de nom du projet** : IBIS-X ‚Üí IBIS-X

== Objectif

D√©ployer rapidement et de mani√®re reproductible l'ensemble de l'infrastructure et des applications IBIS-X sur Azure avec une seule commande.

== Pr√©requis

* Un compte Microsoft Azure avec un abonnement Pay-As-You-Go actif
* Azure CLI install√© et configur√©
* Docker install√© et en cours d'ex√©cution
* Acc√®s en √©criture au repository Git du projet

== üîß Pr√©paration du D√©ploiement

=== 1. Nettoyage de l'Infrastructure Existante (si n√©cessaire)

Si vous avez d√©j√† d√©ploy√© manuellement des ressources IBIS-X, commencez par les nettoyer :

[source,bash]
----
# Nettoyer l'infrastructure existante
./scripts/destroy-azure-infrastructure.sh
----

‚ö†Ô∏è **ATTENTION**: Cette commande supprime D√âFINITIVEMENT toutes les ressources Azure existantes. Sauvegardez vos donn√©es importantes avant de continuer.

=== 2. Configuration des Variables Terraform

Le script va automatiquement cr√©er le fichier `terraform.tfvars` s'il n'existe pas, mais vous pouvez le pr√©parer :

[source,bash]
----
cd terraform/azure-infrastructure/
cp terraform.tfvars.example terraform.tfvars
----

√âditez le fichier selon vos besoins. Les valeurs par d√©faut sont optimis√©es pour IBIS-X :

[source,terraform]
----
project_name = "ibis-x"
environment  = "prod"
location     = "East US"
aks_node_count = 2
aks_node_vm_size = "Standard_D2s_v3"
----

== üöÄ D√©ploiement Automatique

=== Lancement du D√©ploiement Complet

Une seule commande pour tout d√©ployer :

[source,bash]
----
./scripts/deploy-to-azure.sh
----

== üìã Processus de D√©ploiement D√©taill√©

Le script automatis√© ex√©cute les √©tapes suivantes :

=== 1. **V√©rification des Pr√©requis**
- V√©rifie la pr√©sence d'Azure CLI, Terraform, kubectl, Docker
- Installe automatiquement Helm si n√©cessaire

=== 2. **Configuration Azure**
- V√©rifie la connexion √† Azure
- Affiche l'abonnement actuel

=== 3. **Infrastructure Terraform**
- Initialise Terraform
- G√©n√®re et affiche le plan de d√©ploiement
- Cr√©e toutes les ressources Azure :
  * Groupe de ressources
  * Cluster AKS avec r√©seau virtuel
  * Azure Container Registry
  * Compte de stockage Azure
  * IP publique
  * R√®gles de s√©curit√© r√©seau (ports 80, 443, 22)
  * Log Analytics et Application Insights

=== 4. **Configuration Kubernetes**
- Configure kubectl pour le cluster AKS
- Installe NGINX Ingress Controller via Helm
- Installe Cert-Manager via Helm pour les certificats SSL automatiques

=== 5. **Construction et Push des Images**
- Construit les images Docker pour :
  * `ibis-x-api-gateway`
  * `ibis-x-service-selection`
  * `ibis-x-frontend`
- Les pousse vers Azure Container Registry

=== 6. **D√©ploiement des Applications**
- Met √† jour automatiquement tous les noms de projet (IBIS-X ‚Üí IBIS-X)
- D√©ploie les applications via Kustomize
- Attend que tous les pods soient pr√™ts

=== 7. **Migrations de Base de Donn√©es**
- Ex√©cute les jobs de migration Alembic
- V√©rifie la compl√©tion des migrations

== üìä Informations Post-D√©ploiement

√Ä la fin du d√©ploiement, le script affiche :

[source,text]
----
üéâ D√©ploiement IBIS-X termin√© avec succ√®s !

üìã Informations de l'application :
==================================
üåê URL de l'application: https://ibisx.fr
üåê URL de l'API: https://api.ibisx.fr
üåê URL HTTP (temporaire): http://<IP_PUBLIQUE>
üóÑÔ∏è  Storage Account: <nom_compte>
üê≥ Container Registry: <nom_acr>.azurecr.io
‚ò∏Ô∏è  Cluster AKS: <nom_cluster>
üì¶ Resource Group: <nom_groupe_ressources>
----

== üîç V√©rification du D√©ploiement

=== V√©rifier les Pods
[source,bash]
----
kubectl get pods -n ibis-x
----

=== V√©rifier l'Ingress et les Certificats SSL
[source,bash]
----
kubectl get ingress -n ibis-x
kubectl get certificates -n ibis-x
----

=== V√©rifier les Services
[source,bash]
----
kubectl get services -n ibis-x
kubectl get services -n ingress-nginx
----

== üåê Configuration DNS

Pour activer les certificats SSL automatiques, configurez vos enregistrements DNS :

[source,text]
----
A    ibisx.fr        -> <IP_PUBLIQUE>
A    api.ibisx.fr    -> <IP_PUBLIQUE>
----

Les certificats Let's Encrypt se g√©n√®reront automatiquement une fois les DNS configur√©s.

== üîß Maintenance et Debugging

=== Voir les Logs
[source,bash]
----
# Logs des applications
kubectl logs -f deployment/api-gateway -n ibis-x
kubectl logs -f deployment/service-selection -n ibis-x
kubectl logs -f deployment/frontend -n ibis-x

# Logs de l'Ingress Controller
kubectl logs -f deployment/ingress-nginx-controller -n ingress-nginx

# Logs de Cert-Manager
kubectl logs -f deployment/cert-manager -n cert-manager
----

=== Red√©marrer les Services
[source,bash]
----
kubectl rollout restart deployment/api-gateway -n ibis-x
kubectl rollout restart deployment/service-selection -n ibis-x
kubectl rollout restart deployment/frontend -n ibis-x
----

== üóëÔ∏è Nettoyage et Reconstruction

Pour nettoyer compl√®tement l'infrastructure et red√©ployer :

[source,bash]
----
# 1. Supprimer toute l'infrastructure
./scripts/destroy-azure-infrastructure.sh

# 2. Red√©ployer
./scripts/deploy-to-azure.sh
----

== ‚ö†Ô∏è R√©solution des Probl√®mes Courants

=== Probl√®me : Certificats SSL non g√©n√©r√©s
**Solution** : V√©rifiez que vos enregistrements DNS pointent vers la bonne IP publique

=== Probl√®me : Pods en √©tat "Pending"
**Solution** : V√©rifiez les ressources du cluster AKS
[source,bash]
----
kubectl describe nodes
kubectl get events -n ibis-x
----

=== Probl√®me : Images Docker non trouv√©es
**Solution** : V√©rifiez que les images ont √©t√© correctement pouss√©es vers ACR
[source,bash]
----
az acr repository list --name <nom_acr>
----

== üéØ Avantages du Nouveau Processus

1. **Reproductibilit√©** : D√©ploiement identique √† chaque fois
2. **Rapidit√©** : D√©ploiement complet en ~15-20 minutes
3. **S√©curit√©** : Certificats SSL automatiques
4. **Maintenance** : Scripts de nettoyage automatis√©s
5. **Monitoring** : Int√©gration compl√®te avec Azure Monitor

== Prochaines √âtapes

Une fois le d√©ploiement termin√©, vous pouvez :

1. Configurer le monitoring avanc√© avec Azure Application Insights
2. Mettre en place des strat√©gies de sauvegarde automatis√©es
3. Optimiser les performances selon vos besoins sp√©cifiques
4. Configurer des environnements de staging suppl√©mentaires 
