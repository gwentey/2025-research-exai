= üöÄ Installation et D√©marrage d'EXAI

== Pr√©requis

Installez les outils suivants:

[cols="1,3", options="header"]
|===
| Outil | Description
| Docker Desktop | Moteur de conteneurisation - https://www.docker.com/products/docker-desktop/[T√©l√©charger]
| Minikube | Kubernetes local - `choco install minikube` (Windows) ou `brew install minikube` (macOS)
| kubectl | CLI Kubernetes - `choco install kubernetes-cli` (Windows) ou `brew install kubectl` (macOS)
| Skaffold | Workflow Kubernetes - `choco install skaffold` (Windows) ou `brew install skaffold` (macOS)
| Python 3.8+ | Avec le package python-dotenv - `pip install python-dotenv`
|===

=== Lancement rapide

**IMPORTANT:** Le Makefile utilise des commandes Unix et permet de remplacer l'ensemble des commandesq si dessous.

[source,bash]
----
# Utiliser Git Bash au lieu de PowerShell
# Dans Git Bash
make dev
----

====  Commandes manuelles (PowerShell)
Si vous ne pouvez pas utiliser WSL/Git Bash, utilisez les commandes d√©taill√©es ci-dessous.

Pour Linux (Debian/Ubuntu):
[source,bash]
----
# Minikube
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
sudo install minikube-linux-amd64 /usr/local/bin/minikube

# kubectl
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl

# Skaffold
curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64
sudo install skaffold /usr/local/bin/

# Python-dotenv
pip install python-dotenv
----

== Configuration des Secrets

Pour le d√©veloppement local et les d√©ploiements, EXAI utilise un fichier `.env` √† la racine et des scripts Python pour g√©rer les secrets Kubernetes.

=== 1. Cr√©er un fichier `.env`

Cr√©ez un fichier `.env` √† la racine du projet avec les variables suivantes :

[source,properties]
----
# Cl√© secr√®te pour JWT (doit √™tre identique √† celle utilis√©e pour g√©n√©rer les tokens)
JWT_SECRET_KEY=09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7

# URL Base de donn√©es (g√©n√©ralement pointant vers le service K8s)
DATABASE_URL=postgresql+asyncpg://exai_user:password@postgresql-service.exai.svc.cluster.local:5432/exai_db

# Identifiants Google OAuth
GOOGLE_CLIENT_ID=votre-client-id-google
GOOGLE_CLIENT_SECRET=votre-client-secret-google

# URL de redirection OAuth (FRONTEND) pour le d√©veloppement LOCAL
# Cette valeur sera utilis√©e par d√©faut par l'API Gateway.
# Elle sera surcharg√©e en production par un secret GitHub Actions.
# Utilis√©e par k8s/base/api-gateway/gateway-secrets.yaml (placeholder: REPLACE_WITH_OAUTH_REDIRECT_URL)
OAUTH_REDIRECT_URL=http://localhost:8080/authentication/callback
----

NOTE: Le fichier `.env` est d√©j√† ajout√© √† `.gitignore` pour √©viter de commiter des secrets. Adaptez les valeurs √† votre propre configuration, notamment les identifiants Google.

=== 2. Mettre √† jour les secrets Kubernetes

Avant de d√©marrer l'application avec Skaffold ou de g√©n√©rer les manifestes finaux, ex√©cutez :

[source,bash]
----
# Met √† jour les placeholders dans les fichiers secrets avec les valeurs du .env (encod√©es en base64)
python -m scripts.update-local-secrets
----

Ce script (`scripts/update_local_secrets.py`) lit le fichier `.env` et remplace les placeholders correspondants dans les fichiers YAML de Kubernetes :
- Il met √† jour `k8s/base/api-gateway/gateway-secrets.yaml` avec les valeurs de `JWT_SECRET_KEY`, `DATABASE_URL`, `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`, et `OAUTH_REDIRECT_URL` (via `REPLACE_WITH_...`).
- Il *ne modifie plus* de patch sp√©cifique pour l'URL de redirection en production.

IMPORTANT: Ex√©cutez ce script chaque fois que vous modifiez le fichier `.env`.

=== 3. Restaurer les placeholders avant de commiter

Avant de pousser votre code vers le d√©p√¥t Git, il est recommand√© d'ex√©cuter le script inverse pour remettre les placeholders g√©n√©riques dans les fichiers YAML. Cela √©vite de commiter accidentellement des valeurs sp√©cifiques √† votre environnement local.

[source,bash]
----
# Restaure les placeholders g√©n√©riques (REPLACE_WITH_...) dans les fichiers de secrets
python -m scripts.reset-placeholders
----

== üöÄ D√©marrage Ultra-Rapide

[NOTE]
====
**Linux/macOS/WSL/Git Bash:** Toutes les √©tapes ci-dessous peuvent √™tre r√©alis√©es en une seule commande :
[source,bash]
----
make dev
----
Cette commande d√©marre Minikube, d√©ploie l'application, ex√©cute les migrations et affiche les logs.

**Windows PowerShell:** Utilisez les commandes d√©taill√©es ci-dessous.
====

== ü™ü D√©marrage Manuel (Windows PowerShell)

Si vous ne pouvez pas utiliser WSL/Git Bash, voici les √©tapes d√©taill√©es :

=== 1. V√©rification des pr√©requis
[source,powershell]
----
# V√©rifier que les outils sont install√©s
docker --version
minikube version
kubectl version --client
skaffold version
python --version

# V√©rifier le fichier .env
if (Test-Path .env) { "‚úÖ Fichier .env trouv√©" } else { "‚ùå Fichier .env manquant" }
----

=== 2. D√©marrage de Minikube
[source,powershell]
----
# D√©marrer Minikube
minikube start --memory 4096 --cpus 2 --disk-size 20g
minikube addons enable ingress
minikube addons enable storage-provisioner
----

=== 3. Configuration
[source,powershell]
----
# Cr√©er le namespace
kubectl create namespace exai

# Mettre √† jour les secrets
python -m scripts.update-local-secrets

# Configurer Docker pour Minikube
& minikube -p minikube docker-env --shell powershell | Invoke-Expression
----

=== 4. D√©ploiement
[source,powershell]
----
# D√©ployer l'application
skaffold run --profile=local --namespace=exai
----

=== 5. Attendre que les services soient pr√™ts
[source,powershell]
----
# Attendre PostgreSQL
kubectl wait --for=condition=ready pod -l app=postgresql -n exai --timeout=300s

# Attendre API Gateway
kubectl wait --for=condition=ready pod -l app=api-gateway -n exai --timeout=300s

# Attendre Service Selection
kubectl wait --for=condition=ready pod -l app=service-selection -n exai --timeout=300s
----

=== 6. Migrations
[source,powershell]
----
# Supprimer les anciens jobs
kubectl delete job api-gateway-migration-job -n exai --ignore-not-found=true
kubectl delete job service-selection-migration-job -n exai --ignore-not-found=true

# Lancer les migrations
kubectl apply -f k8s/base/jobs/api-gateway-migration-job.yaml -n exai
kubectl wait --for=condition=complete job/api-gateway-migration-job -n exai --timeout=300s

kubectl apply -f k8s/base/jobs/service-selection-migration-job.yaml -n exai
kubectl wait --for=condition=complete job/service-selection-migration-job -n exai --timeout=300s
----

=== 7. Acc√®s aux services
[source,powershell]
----
# D√©marrer les logs et redirections de port
skaffold dev --profile=local --namespace=exai
----

**Acc√®s aux services :**
- **Frontend:** http://localhost:8080
- **API Gateway:** http://localhost:9000
- **Documentation API:** http://localhost:9000/docs

== D√©ploiement Local avec Minikube et Skaffold

1.  **Cloner le d√©p√¥t** (si pas d√©j√† fait):
+
[source,bash]
----
git clone <URL_DU_DEPOT_GIT_EXAI>
cd <NOM_DU_DOSSIER_PROJET_EXAI>
----

2.  **D√©marrer Minikube**:
+
[source,bash]
----
minikube start
# Pour plus de ressources: minikube start --memory 4096 --cpus 2
----
+
[NOTE]
====
Assurez-vous que l'addon `ingress` est activ√© si vous comptez tester le d√©ploiement avec Ingress plus tard (bien que non utilis√© pour l'acc√®s local par d√©faut d√©crit ici). L'addon `storage-provisioner` est √©galement n√©cessaire et g√©n√©ralement activ√© par d√©faut.
====

3.  **Cr√©er le namespace** (si pas d√©j√† fait):
+
[source,bash]
----
kubectl create namespace exai
# Ignorez l'erreur si le namespace existe d√©j√†.
----

4.  **Mettre √† jour les secrets Kubernetes** (voir section pr√©c√©dente) :
+
[source,bash]
----
python -m scripts.update-local-secrets
----

5.  **Configurer l'environnement Docker** :
+
[source,bash]
----
# Linux/macOS
eval $(minikube docker-env)

# Windows (PowerShell)
& minikube -p minikube docker-env --shell powershell | Invoke-Expression

# Windows (cmd.exe)
@FOR /f "tokens=*" %i IN ('minikube -p minikube docker-env --shell cmd') DO @%i
----

6. **D√©ployer avec Skaffold**:
+
[source,bash]
----
# Pour le mode local (d√©veloppement)
skaffold dev --profile=local

----
+
Skaffold va :
+
--
* D√©tecter le contexte Minikube et utiliser son environnement Docker.
* Construire les images Docker n√©cessaires (si le code a chang√©).
* D√©ployer les manifestes Kubernetes d√©finis dans `skaffold.yaml` pour le profil `local` (Base de donn√©es, API Gateway, Service Selection, Frontend) dans le namespace `exai`.
* Mettre en place des redirections de port automatiques (voir section Acc√®s).
* Surveiller les changements de code et red√©ployer automatiquement.
* Afficher les logs des conteneurs en temps r√©el dans la console.
--
+
[IMPORTANT]
====
Le premier d√©ploiement peut prendre plusieurs minutes. Attendez que Skaffold indique `Deployments stabilized` ou que tous les pods principaux (`postgresql`, `api-gateway`, `service-selection`, `frontend`) passent √† l'√©tat `Running` (vous pouvez v√©rifier avec `kubectl get pods -n exai`).
====

=== Initialisation de la Base de Donn√©es

L'architecture EXAI utilise une base de donn√©es PostgreSQL partag√©e par tous les microservices, chaque service g√©rant ses migrations sp√©cifiques.

Ex√©cutez les migrations depuis les pods Kubernetes :

==== Service de S√©lection
[source,bash]
----
# 1. Identifier le pod
kubectl get pods -n exai -l app=service-selection

# 2. Ex√©cuter la migration (remplacer <pod-name>)
kubectl exec -it <pod-name> -n exai -- bash -c "cd /app && DATABASE_URL='postgresql+asyncpg://exai_user:password@postgresql-service:5432/exai_db' alembic upgrade head"
----

==== API Gateway
[source,bash]
----
# Identifier le pod et ex√©cuter la migration
kubectl get pods -n exai -l app=api-gateway
kubectl exec -it <pod-name> -n exai -- bash -c "cd /app && DATABASE_URL='postgresql+asyncpg://exai_user:password@postgresql-service:5432/exai_db' alembic upgrade head"
----

[NOTE]
====
Ces commandes ex√©cutent les migrations Alembic directement √† l'int√©rieur des pods. Cela √©vite les probl√®mes de connectivit√© et assure que la configuration est identique √† celle utilis√©e par l'application.

Chaque service utilise sa propre table de version Alembic (`alembic_version_gateway` et `alembic_version_selection`) pour suivre ses migrations dans la base de donn√©es partag√©e.
====

=== Acc√©der √† l'Application

Avec le profil `local`, Skaffold configure automatiquement des redirections de port (`port-forward`) pour faciliter l'acc√®s. **Il n'est PAS n√©cessaire d'utiliser `minikube service` ou `minikube tunnel` pour ce workflow local par d√©faut.**

Les services sont accessibles directement sur `localhost` via les ports suivants (tant que `skaffold dev --profile=local` est actif) :

*   **Frontend :** `http://localhost:8080`
*   **API Gateway :** `http://localhost:9000`
    **Documentation API (Swagger UI) :** `http://localhost:9000/docs`
    **Documentation API (ReDoc) :** `http://localhost:9000/redoc`

[NOTE]
====
Le frontend est configur√© (via `frontend/src/environments/environment.ts`) pour appeler l'API Gateway sur `http://localhost:9000`.
====

== Workflow de D√©veloppement

=== Structure des Fichiers Kubernetes

Le projet utilise Kustomize pour g√©rer les configurations Kubernetes de mani√®re structur√©e :

```
k8s/
‚îú‚îÄ‚îÄ base/                      # Configurations communes √† tous les environnements
‚îÇ   ‚îú‚îÄ‚îÄ api-gateway/           # Manifestes pour l'API Gateway (Deployment, Service, Secrets...)
‚îÇ   ‚îú‚îÄ‚îÄ frontend/              # Manifestes pour le Frontend
‚îÇ   ‚îú‚îÄ‚îÄ postgres/              # Manifestes pour PostgreSQL (StatefulSet, Service, PVC...)
‚îÇ   ‚îú‚îÄ‚îÄ service-selection/     # Manifestes pour le Service Selection
‚îÇ   ‚îî‚îÄ‚îÄ kustomization.yaml     # R√©f√©rence toutes les ressources de la base
‚îî‚îÄ‚îÄ overlays/                  # Surcouches pour des environnements sp√©cifiques
    ‚îú‚îÄ‚îÄ minikube/              # Configurations pour le d√©veloppement local (Minikube)
    ‚îÇ   ‚îú‚îÄ‚îÄ kustomization.yaml # R√©f√©rence la base et applique des patches sp√©cifiques (ex: type Service)
    ‚îÇ   ‚îî‚îÄ‚îÄ ... (patches si n√©cessaire)
    ‚îî‚îÄ‚îÄ azure/                 # Configurations pour le d√©ploiement en production (Azure)
        ‚îú‚îÄ‚îÄ kustomization.yaml # R√©f√©rence la base et applique des patches (ex: Ingress)
        ‚îî‚îÄ‚îÄ ... (autres patches ou ressources sp√©cifiques)
```

Cette structure permet de :
- D√©finir les ressources principales une seule fois dans `base/`.
- Personnaliser la configuration pour chaque environnement (local, production) dans `overlays/` en utilisant des patches ou des ressources suppl√©mentaires.
- Pour la production (Azure), les secrets sensibles comme l'URL de la base de donn√©es ou l'URL de redirection OAuth sont inject√©s via le pipeline CI/CD (GitHub Actions) qui modifie directement les manifestes de base avant le d√©ploiement par Skaffold/Kustomize.

=== Cycle de D√©veloppement avec Skaffold
1. Modifiez votre code dans l'un des microservices (frontend, api-gateway, service-selection)
2. Skaffold d√©tecte automatiquement les changements
3. Reconstruction et red√©ploiement automatiques des images Docker affect√©es
4. Services red√©marr√©s avec le nouveau code
5. Visualisez les logs en temps r√©el dans la console Skaffold

[TIP]
Pour un workflow plus fluide, utilisez des outils comme **Lens**, **k9s** ou le **Kubernetes Dashboard** (`minikube dashboard`).

== D√©pannage

=== Probl√®mes Courants
* *Minikube ne d√©marre pas* : V√©rifiez Docker Desktop, essayez `minikube delete` puis `minikube start`
* *Pod bloqu√© en `Pending`* : Augmentez les ressources (`minikube stop && minikube config set memory 4096 && minikube start`)
* *Pod en `CrashLoopBackOff`* : V√©rifiez les logs avec `kubectl logs -n exai <pod-name>`
* *Services inaccessibles* : V√©rifiez que `skaffold dev --profile=local` est en cours d'ex√©cution et qu'aucun autre programme n'utilise les ports locaux `8080` ou `9000`. V√©rifiez les logs Skaffold pour des erreurs de port-forwarding. Assurez-vous que les pods sont `Running` (`kubectl get pods -n exai`).
* *Pod PostgreSQL bloqu√© en `Pending`* : V√©rifiez les PVC (`kubectl get pvc -n exai`) et la StorageClass (`kubectl get sc`). Assurez-vous que la configuration du volume dans `k8s/base/postgres/postgresql-statefulset.yaml` utilise la bonne `storageClassName` (`standard` pour Minikube par d√©faut).
* *Erreurs "MIME type" sur le frontend* : Assurez-vous que la configuration Nginx (`frontend/nginx.conf`), le Dockerfile (`frontend/Dockerfile`), et le `baseHref` dans `angular.json` sont coh√©rents pour un service √† la racine (`/`).
* *Secrets incorrects* : Si vous rencontrez des erreurs d'authentification, v√©rifiez que vous avez bien ex√©cut√© `python -m scripts.update-local-secrets` apr√®s avoir mis √† jour votre fichier `.env`.

=== √âtapes de Diagnostic
1. Logs Skaffold
2. √âtat des pods : `kubectl get pods -n exai`
3. D√©tails d'un pod : `kubectl describe pod <pod-name> -n exai`
4. Logs d'un pod : `kubectl logs -n exai <pod-name>`
5. Logs Minikube : `minikube logs`

== Arr√™ter l'environnement
[source,bash]
----
# Arr√™ter Skaffold : Ctrl+C

# Arr√™ter Minikube
minikube stop

# Supprimer compl√®tement Minikube (supprime les donn√©es)
minikube delete
----