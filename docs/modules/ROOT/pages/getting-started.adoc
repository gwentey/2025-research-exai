= üöÄ Installation et D√©marrage d'EXAI

== Pr√©requis

Installez les outils suivants:

[cols="1,3", options="header"]
|===
| Outil | Description
| Docker Desktop | Moteur de conteneurisation - https://www.docker.com/products/docker-desktop/[T√©l√©charger]
| Minikube | Kubernetes local - `choco install minikube` (Windows) ou `brew install minikube` (macOS)
| kubectl | CLI Kubernetes - `choco install kubernetes-cli` (Windows) ou `brew install kubectl` (macOS)
| Skaffold | Workflow Kubernetes - `choco install skaffold` (Windows) ou `brew install skaffold` (macOS)
|===

Pour Linux (Debian/Ubuntu):
[source,bash]
----
# Minikube
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
sudo install minikube-linux-amd64 /usr/local/bin/minikube

# kubectl
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl

# Skaffold
curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64
sudo install skaffold /usr/local/bin/
----

== D√©ploiement Local avec Minikube et Skaffold

1.  **Cloner le d√©p√¥t** (si pas d√©j√† fait):
+
[source,bash]
----
git clone <URL_DU_DEPOT_GIT_EXAI>
cd <NOM_DU_DOSSIER_PROJET_EXAI>
----

2.  **D√©marrer Minikube**:
+
[source,bash]
----
minikube start
# Pour plus de ressources: minikube start --memory 4096 --cpus 2
----
+
[NOTE]
====
Assurez-vous que l'addon `ingress` est activ√© si vous comptez tester le d√©ploiement avec Ingress plus tard (bien que non utilis√© pour l'acc√®s local par d√©faut d√©crit ici). L'addon `storage-provisioner` est √©galement n√©cessaire et g√©n√©ralement activ√© par d√©faut.
====

3.  **Cr√©er le namespace** (si pas d√©j√† fait):
+
[source,bash]
----
kubectl create namespace exai
# Ignorez l'erreur si le namespace existe d√©j√†.
----

4.  **D√©ployer avec Skaffold**:
+
[source,bash]
----
# Linux/macOS
eval $(minikube docker-env)

# Windows (PowerShell)
& minikube -p minikube docker-env --shell powershell | Invoke-Expression

# Windows (cmd.exe)
@FOR /f "tokens=*" %i IN ('minikube -p minikube docker-env --shell cmd') DO @%i
----

5. **D√©ployer avec Skaffold**:
+
[source,bash]
----
# Pour le mode local (d√©veloppement)
skaffold dev --profile=local

----
+
Skaffold va :
+
--
* D√©tecter le contexte Minikube et utiliser son environnement Docker.
* Construire les images Docker n√©cessaires (si le code a chang√©).
* D√©ployer les manifestes Kubernetes d√©finis dans `skaffold.yaml` pour le profil `local` (Base de donn√©es, API Gateway, Service Selection, Frontend) dans le namespace `exai`.
* Mettre en place des redirections de port automatiques (voir section Acc√®s).
* Surveiller les changements de code et red√©ployer automatiquement.
* Afficher les logs des conteneurs en temps r√©el dans la console.
--
+
[IMPORTANT]
====
Le premier d√©ploiement peut prendre plusieurs minutes. Attendez que Skaffold indique `Deployments stabilized` ou que tous les pods principaux (`postgresql`, `api-gateway`, `service-selection`, `frontend`) passent √† l'√©tat `Running` (vous pouvez v√©rifier avec `kubectl get pods -n exai`).
====

=== Initialisation de la Base de Donn√©es

L'architecture EXAI utilise une base de donn√©es PostgreSQL partag√©e par tous les microservices, chaque service g√©rant ses migrations sp√©cifiques.

Ex√©cutez les migrations depuis les pods Kubernetes :

==== Service de S√©lection
[source,bash]
----
# 1. Identifier le pod
kubectl get pods -n exai -l app=service-selection

# 2. Ex√©cuter la migration (remplacer <pod-name>)
kubectl exec -it <pod-name> -n exai -- bash -c "cd /app && DATABASE_URL='postgresql+asyncpg://exai_user:password@postgresql-service:5432/exai_db' alembic upgrade head"
----

==== API Gateway
[source,bash]
----
# Identifier le pod et ex√©cuter la migration
kubectl get pods -n exai -l app=api-gateway
kubectl exec -it <pod-name> -n exai -- bash -c "cd /app && DATABASE_URL='postgresql+asyncpg://exai_user:password@postgresql-service:5432/exai_db' alembic upgrade head"
----

[NOTE]
====
Ces commandes ex√©cutent les migrations Alembic directement √† l'int√©rieur des pods. Cela √©vite les probl√®mes de connectivit√© et assure que la configuration est identique √† celle utilis√©e par l'application.

Chaque service utilise sa propre table de version Alembic (`alembic_version_gateway` et `alembic_version_selection`) pour suivre ses migrations dans la base de donn√©es partag√©e.
====

=== Acc√©der √† l'Application

Avec le profil `local`, Skaffold configure automatiquement des redirections de port (`port-forward`) pour faciliter l'acc√®s. **Il n'est PAS n√©cessaire d'utiliser `minikube service` ou `minikube tunnel` pour ce workflow local par d√©faut.**

Les services sont accessibles directement sur `localhost` via les ports suivants (tant que `skaffold dev --profile=local` est actif) :

*   **Frontend :** `http://localhost:8080`
*   **API Gateway :** `http://localhost:9000`
    **Documentation API (Swagger UI) :** `http://localhost:9000/docs`
    **Documentation API (ReDoc) :** `http://localhost:9000/redoc`

[NOTE]
====
Le frontend est configur√© (via `frontend/src/environments/environment.ts`) pour appeler l'API Gateway sur `http://localhost:9000`.
====

== Workflow de D√©veloppement

=== Structure des Fichiers Kubernetes

Le projet utilise maintenant une organisation centralis√©e des fichiers Kubernetes :

```
k8s/
‚îú‚îÄ‚îÄ base/                      # Configurations de base communes
‚îÇ   ‚îú‚îÄ‚îÄ api-gateway/           # API Gateway
‚îÇ   ‚îú‚îÄ‚îÄ frontend/              # Frontend
‚îÇ   ‚îú‚îÄ‚îÄ postgres/              # Base de donn√©es PostgreSQL
‚îÇ   ‚îú‚îÄ‚îÄ service-selection/     # Service de s√©lection de datasets
‚îÇ   ‚îî‚îÄ‚îÄ kustomization.yaml     # Fichier d√©clarant toutes les ressources
‚îî‚îÄ‚îÄ overlays/                  # Surcouches pour diff√©rents environnements
    ‚îî‚îÄ‚îÄ azure/                 # Configuration sp√©cifique √† Azure
```

Cette structure suit les principes de Kustomize :
- Le dossier `base/` contient les configurations communes √† tous les environnements
- Le dossier `overlays/` contient des surcouches sp√©cifiques √† chaque environnement (comme Azure)

=== Cycle de D√©veloppement avec Skaffold
1. Modifiez votre code dans l'un des microservices (frontend, api-gateway, service-selection)
2. Skaffold d√©tecte automatiquement les changements
3. Reconstruction et red√©ploiement automatiques des images Docker affect√©es
4. Services red√©marr√©s avec le nouveau code
5. Visualisez les logs en temps r√©el dans la console Skaffold

[TIP]
Pour un workflow plus fluide, utilisez des outils comme **Lens**, **k9s** ou le **Kubernetes Dashboard** (`minikube dashboard`).

== D√©pannage

=== Probl√®mes Courants
* *Minikube ne d√©marre pas* : V√©rifiez Docker Desktop, essayez `minikube delete` puis `minikube start`
* *Pod bloqu√© en `Pending`* : Augmentez les ressources (`minikube stop && minikube config set memory 4096 && minikube start`)
* *Pod en `CrashLoopBackOff`* : V√©rifiez les logs avec `kubectl logs -n exai <pod-name>`
* *Services inaccessibles* : V√©rifiez que `skaffold dev --profile=local` est en cours d'ex√©cution et qu'aucun autre programme n'utilise les ports locaux `8080` ou `9000`. V√©rifiez les logs Skaffold pour des erreurs de port-forwarding. Assurez-vous que les pods sont `Running` (`kubectl get pods -n exai`).
* *Pod PostgreSQL bloqu√© en `Pending`* : V√©rifiez les PVC (`kubectl get pvc -n exai`) et la StorageClass (`kubectl get sc`). Assurez-vous que la configuration du volume dans `k8s/base/postgres/postgresql-statefulset.yaml` utilise la bonne `storageClassName` (`standard` pour Minikube par d√©faut).
* *Erreurs "MIME type" sur le frontend* : Assurez-vous que la configuration Nginx (`frontend/nginx.conf`), le Dockerfile (`frontend/Dockerfile`), et le `baseHref` dans `angular.json` sont coh√©rents pour un service √† la racine (`/`).

=== √âtapes de Diagnostic
1. Logs Skaffold
2. √âtat des pods : `kubectl get pods -n exai`
3. D√©tails d'un pod : `kubectl describe pod <pod-name> -n exai`
4. Logs d'un pod : `kubectl logs -n exai <pod-name>`
5. Logs Minikube : `minikube logs`

== Arr√™ter l'environnement
[source,bash]
----
# Arr√™ter Skaffold : Ctrl+C

# Arr√™ter Minikube
minikube stop

# Supprimer compl√®tement Minikube (supprime les donn√©es)
minikube delete
----