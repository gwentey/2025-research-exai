= üöÄ Installation et D√©marrage Rapide d'EXAI

Bienvenue dans le guide de d√©marrage du projet EXAI !

Ce document vous explique comment installer les outils n√©cessaires et d√©ployer l'application EXAI sur votre ordinateur personnel en utilisant Minikube et Skaffold. Minikube nous permet de simuler un environnement Kubernetes (l'outil utilis√© pour orchestrer nos microservices) localement pour le d√©veloppement et les tests, tandis que Skaffold automatise le workflow de d√©veloppement.

Suivez attentivement ces √©tapes pour avoir une instance fonctionnelle d'EXAI.

== √âtape 1 : Pr√©parer votre Environnement de D√©veloppement

Avant de pouvoir d√©ployer EXAI, vous devez installer quelques outils essentiels sur votre machine.

=== Pr√©requis Logiciels

Assurez-vous d'avoir les logiciels suivants install√©s :

1.  **Docker Desktop** : C'est le moteur qui g√®re nos conteneurs logiciels. Minikube l'utilise en arri√®re-plan.
    *   *Installation :* Suivez les instructions sur le site officiel de https://www.docker.com/products/docker-desktop/[Docker Desktop^].
    *   *V√©rification :* Ouvrez un terminal et tapez `docker --version`. Vous devriez voir une version s'afficher.

2.  **Minikube** : L'outil pour ex√©cuter un cluster Kubernetes √† n≈ìud unique sur votre machine.
    *   *Installation :* Voir les commandes ci-dessous pour votre syst√®me d'exploitation ou consultez la https://minikube.sigs.k8s.io/docs/start/[documentation officielle de Minikube^].
    *   *V√©rification :* Apr√®s installation, tapez `minikube version` dans votre terminal.

3.  **kubectl** : L'outil en ligne de commande pour interagir avec votre cluster Kubernetes (local ou distant).
    *   *Installation :* Voir les commandes ci-dessous ou consultez la https://kubernetes.io/docs/tasks/tools/install-kubectl/[documentation officielle de kubectl^].
    *   *V√©rification :* Apr√®s installation, tapez `kubectl version --client` dans votre terminal.

4.  **Skaffold** : L'outil qui automatise le workflow de d√©veloppement sur Kubernetes.
    *   *Installation :* Voir les commandes ci-dessous ou consultez la https://skaffold.dev/docs/install/[documentation officielle de Skaffold^].
    *   *V√©rification :* Apr√®s installation, tapez `skaffold version` dans votre terminal.

5.  **Terminal Bash (Recommand√©)** : Pour ex√©cuter les commandes de ce guide.
    *   *Windows :* Utilisez https://gitforwindows.org/[Git Bash^] (inclus avec Git pour Windows) ou WSL (Windows Subsystem for Linux).
    *   *macOS/Linux :* Utilisez le terminal int√©gr√©.

6.  **(Optionnel mais recommand√©) Gestionnaire de paquets :**
    *   *Windows :* https://chocolatey.org/install[Chocolatey^]
    *   *macOS :* https://brew.sh/[Homebrew^]

=== Commandes d'Installation (Minikube, kubectl & Skaffold)

Choisissez les commandes correspondant √† votre syst√®me :

*   **Windows (avec Chocolatey)** :
    Ouvrez PowerShell en tant qu'administrateur :
[source,powershell]
----
choco install minikube
choco install kubernetes-cli
choco install skaffold
----

*   **Windows (Installation manuelle de Skaffold)** :
    Si Chocolatey ne fonctionne pas, vous pouvez t√©l√©charger Skaffold manuellement :
[source,powershell]
----
# Cr√©er un dossier pour Skaffold
mkdir -p $HOME/skaffold
# T√©l√©charger le binaire Skaffold
Invoke-WebRequest -Uri "https://storage.googleapis.com/skaffold/releases/latest/skaffold-windows-amd64.exe" -OutFile "$HOME/skaffold/skaffold.exe"
# Ajouter au PATH (temporaire pour la session actuelle)
$env:PATH += ";$HOME\skaffold"
# Vous pouvez aussi ajouter le chemin √† votre PATH permanent via les propri√©t√©s syst√®me
----

*   **macOS (avec Homebrew)** :
    Ouvrez votre Terminal :
[source,bash]
----
brew install minikube
brew install kubectl
brew install skaffold
----

*   **Linux (Debian/Ubuntu)** :
    Ouvrez votre Terminal :
[source,bash]
----
# Installer Minikube
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
sudo install minikube-linux-amd64 /usr/local/bin/minikube
rm minikube-linux-amd64

# Installer kubectl
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
rm kubectl

# Installer Skaffold
curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64
sudo install skaffold /usr/local/bin/
rm skaffold
----

Apr√®s l'installation, v√©rifiez que les outils fonctionnent avec les commandes `minikube version`, `kubectl version --client` et `skaffold version`.

== √âtape 2 : Cloner le D√©p√¥t du Projet

Si ce n'est pas d√©j√† fait, r√©cup√©rez le code source du projet EXAI depuis son d√©p√¥t Git.

[source,bash]
----
git clone <URL_DU_DEPOT_GIT_EXAI>
cd <NOM_DU_DOSSIER_PROJET_EXAI>
----
IMPORTANT: Ex√©cutez toutes les commandes suivantes depuis la racine de ce dossier projet clon√©.

== √âtape 3 : D√©ployer l'Application EXAI avec Skaffold

Maintenant que les outils sont pr√™ts, nous allons d√©marrer notre cluster local et y d√©ployer les composants d'EXAI en utilisant Skaffold pour automatiser le processus.

=== 3.1 D√©marrer Minikube

Minikube va cr√©er une machine virtuelle (ou utiliser un conteneur Docker) pour h√©berger votre cluster Kubernetes.

. Ouvrez votre terminal (√† la racine du projet EXAI).
. Lancez la commande suivante :

[source,bash]
----
minikube start
# Astuce: Si vous avez plusieurs Go de RAM, vous pouvez allouer plus de ressources:
# minikube start --memory 4096 --cpus 2
----

Le premier d√©marrage peut prendre quelques minutes car Minikube t√©l√©charge les images n√©cessaires.

. Une fois termin√©, v√©rifiez que le cluster est bien d√©marr√© :

[source,bash]
----
minikube status
----

Vous devriez voir des informations indiquant que `minikube`, `apiserver`, et `kubeconfig` sont `Running` ou `Configured`.

=== 3.2 Cr√©er un Espace de Noms (Namespace)

Pour garder notre application organis√©e et isol√©e des autres composants syst√®me de Kubernetes, nous cr√©ons un "namespace" appel√© `exai`.

[source,bash]
----
kubectl create namespace exai
----

NOTE: Si vous voyez une erreur indiquant que le namespace existe d√©j√† (`Error from server (AlreadyExists)`), ce n'est pas grave, vous pouvez continuer.

=== 3.3 D√©ployer les Composants EXAI avec Skaffold

Skaffold simplifie consid√©rablement le d√©ploiement et le d√©veloppement en automatisant tout le workflow : construction des images Docker, d√©ploiement des manifestes Kubernetes, et red√©ploiement automatique lorsque vous modifiez le code.

[TIP]
====
Un fichier `skaffold.yaml` est d√©j√† configur√© √† la racine du projet. Il d√©finit les composants √† construire et √† d√©ployer, ainsi que les ports √† transf√©rer pour acc√©der facilement aux services.
====

. *Configurer Docker pour Minikube* (n√©cessaire seulement la premi√®re fois) :
+
[source,bash]
----
# Sur Linux/macOS
eval $(minikube docker-env)

# Sur Windows (PowerShell)
& minikube -p minikube docker-env --shell powershell | Invoke-Expression
----

. *D√©marrer le d√©veloppement avec Skaffold* :
+
Depuis la racine du projet EXAI, lancez Skaffold en mode d√©veloppement :
+
[source,bash]
----
skaffold dev
----
+
Skaffold va :
+
--
* Construire automatiquement les images Docker pour `api-gateway` et `service-selection`
* D√©ployer tous les manifestes Kubernetes (PostgreSQL, API Gateway, Service Selection)
* Configurer des redirections de port pour acc√©der facilement aux services
* Surveiller les changements de code et red√©ployer automatiquement lorsque n√©cessaire
* Afficher les logs de tous les services en temps r√©el
--
+
[IMPORTANT]
====
Le premier d√©ploiement peut prendre quelques minutes. Attendez que tous les pods passent √† l'√©tat `Running`. 

Les services seront automatiquement accessibles via les URLs locales affich√©es dans la console, g√©n√©ralement :
* API Gateway : http://localhost:8080
* Service Selection : http://localhost:8081
====

. *Laisser Skaffold tourner* :
+
Laissez le terminal avec Skaffold ouvert pendant que vous d√©veloppez. Il surveillera les changements et red√©ploiera automatiquement.
+
[TIP]
====
Pour arr√™ter Skaffold, appuyez sur `Ctrl+C` dans le terminal o√π il s'ex√©cute. Cela n'arr√™tera pas Minikube, mais seulement le processus de surveillance et de red√©ploiement automatique.
====

=== 3.4 Initialisation de la Base de Donn√©es

L'architecture EXAI utilise une base de donn√©es PostgreSQL unique et partag√©e par tous les microservices. Chaque service poss√®de sa propre configuration Alembic pour g√©rer ses migrations sp√©cifiques dans cette base de donn√©es commune.

=== 3.4.1 Pr√©paration G√©n√©rale

[source,bash]
----
# Port-forwarding vers PostgreSQL depuis Kubernetes
kubectl port-forward service/postgresql-service -n exai 5432:5432
----

=== 3.4.2 Initialisation par Service

Chaque microservice doit ex√©cuter ses propres migrations dans la base de donn√©es partag√©e. Ex√©cutez ces commandes dans des terminaux s√©par√©s.

==== Service de S√©lection (service-selection)

[source,bash]
----
# 1. D√©finir la variable d'environnement pour la connexion
$env:DATABASE_URL = 'postgresql+asyncpg://exai_user:password@localhost:5432/exai_db'

# 2. Acc√©der au r√©pertoire du service
cd service-selection

# 3. Ex√©cuter la migration
alembic upgrade head
----


==== API Gateway

[source,bash]
----
# 1. D√©finir la variable d'environnement pour la connexion
$env:DATABASE_URL = 'postgresql+asyncpg://exai_user:password@localhost:5432/exai_db'

# 2. Acc√©der au r√©pertoire du service
cd api-gateway

# 3. Ex√©cuter la migration
alembic upgrade head
----


=== 3.5 Acc√©der √† l'Application

Avec Skaffold en cours d'ex√©cution, les services sont automatiquement accessibles via les ports configur√©s dans le fichier `skaffold.yaml`.

. *Acc√©der √† l'API Gateway :*
+
Ouvrez simplement votre navigateur √† l'adresse : http://localhost:8080

. *Acc√©der au Service de S√©lection :*
+
Ouvrez simplement votre navigateur √† l'adresse : http://localhost:8081

. *Acc√©der √† la documentation API (Swagger UI)* :
+
Ajoutez `/docs` aux URLs ci-dessus :
+
- API Gateway Swagger : http://localhost:8080/docs
- Service Selection Swagger : http://localhost:8081/docs

[TIP]
====
Si les ports par d√©faut ne fonctionnent pas, consultez les URLs affich√©es dans le terminal o√π Skaffold s'ex√©cute. Skaffold affiche les redirections de port actives au d√©marrage.
====

== Workflow de D√©veloppement avec Skaffold

=== Avantages de Skaffold

Skaffold simplifie consid√©rablement le workflow de d√©veloppement sur Kubernetes :

* **D√©veloppement continu** : Modifiez votre code, sauvegardez, et Skaffold reconstruira et red√©ploiera automatiquement
* **Logs en temps r√©el** : Tous les logs de vos services sont affich√©s dans le terminal Skaffold
* **Port-forwarding automatique** : Acc√©dez facilement √† vos services via localhost
* **Pas de commandes manuelles** : Fini les `docker build`, `kubectl delete pod`, etc.

=== Comment fonctionne Skaffold

1. Vous modifiez le code source
2. Skaffold d√©tecte les changements
3. Skaffold reconstruit automatiquement les images Docker affect√©es
4. Skaffold red√©ploie les composants modifi√©s sur Kubernetes
5. Les services red√©marrent avec le nouveau code

[TIP]
====
Pour un workflow encore plus fluide, vous pouvez utiliser d'autres outils compl√©mentaires :

* **Lens** ou **k9s** : Interfaces utilisateur pour Kubernetes
* **Kubernetes Dashboard** : Interface web officielle pour Kubernetes (`minikube dashboard`)
====

== (Optionnel) D√©pannage

Cette section pr√©sente les solutions aux probl√®mes les plus courants que vous pourriez rencontrer.

=== Probl√®mes li√©s √† Minikube

*   **Minikube ne d√©marre pas :** V√©rifiez que Docker Desktop est lanc√©. Essayez `minikube delete` puis `minikube start`. V√©rifiez les logs avec `minikube logs`. Assurez-vous que la virtualisation est activ√©e dans le BIOS/UEFI de votre machine si vous n'utilisez pas le driver Docker.

*   **Probl√®mes de connexion avec Minikube :** Si vous rencontrez des probl√®mes de connexion avec Minikube, essayez de red√©marrer Minikube avec la commande `minikube stop` suivie de `minikube start`.

=== Probl√®mes li√©s √† Skaffold

*   **Skaffold ne d√©tecte pas les changements :** Assurez-vous que vous √™tes dans le bon r√©pertoire. Red√©marrez Skaffold.

*   **Erreurs de construction d'image :** V√©rifiez les logs dans le terminal Skaffold. Assurez-vous que tous les fichiers n√©cessaires sont pr√©sents.

*   **Probl√®mes de port-forwarding :** V√©rifiez qu'aucun autre service n'utilise les m√™mes ports locaux. Vous pouvez modifier les ports dans `skaffold.yaml`.

=== Probl√®mes li√©s aux pods Kubernetes

*   **Pod bloqu√© en `Pending` :** 
    ** Manque de ressources (CPU/M√©moire) ? Essayez d'allouer plus de ressources √† Minikube (`minikube stop`, `minikube config set memory 4096`, `minikube start`).
    ** Probl√®me de r√©seau ? V√©rifiez la sortie de `kubectl describe pod <nom-du-pod> -n exai`.

*   **Pod en √©tat `CrashLoopBackOff` ou erreur d'ex√©cution :**
    ** Consultez les logs du pod avec `kubectl logs -n exai <nom-du-pod>` pour identifier l'erreur.
    ** Pour l'API Gateway, v√©rifiez les probl√®mes courants comme les chemins d'importation et la configuration de FastAPI.

=== Comment diagnostiquer un probl√®me

Pour diagnostiquer un probl√®me, suivez ces √©tapes :

1. Consultez les logs dans le terminal Skaffold
2. V√©rifiez l'√©tat des pods : `kubectl get pods -n exai`
3. Pour un pod probl√©matique, consultez les d√©tails : `kubectl describe pod <nom-du-pod> -n exai`
4. Examinez les logs du pod : `kubectl logs -n exai <nom-du-pod>`
5. Consultez les logs de Minikube : `minikube logs`

== Arr√™ter l'environnement

Pour arr√™ter Skaffold : Appuyez sur `Ctrl+C` dans le terminal o√π il s'ex√©cute.

Pour arr√™ter Minikube et lib√©rer les ressources :

[source,bash]
----
minikube stop
----

Pour supprimer compl√®tement le cluster Minikube (attention, supprime toutes les donn√©es) :
[source,bash]
----
minikube delete
----