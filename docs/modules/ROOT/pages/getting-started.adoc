= üöÄ Installation et D√©marrage d'EXAI

== Pr√©requis

Installez les outils suivants:

[cols="1,3", options="header"]
|===
| Outil | Description
| Docker Desktop | Moteur de conteneurisation - https://www.docker.com/products/docker-desktop/[T√©l√©charger]
| Minikube | Kubernetes local - `choco install minikube` (Windows) ou `brew install minikube` (macOS)
| kubectl | CLI Kubernetes - `choco install kubernetes-cli` (Windows) ou `brew install kubectl` (macOS)
| Skaffold | Workflow Kubernetes - `choco install skaffold` (Windows) ou `brew install skaffold` (macOS)
|===

Pour Linux (Debian/Ubuntu):
[source,bash]
----
# Minikube
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
sudo install minikube-linux-amd64 /usr/local/bin/minikube

# kubectl
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl

# Skaffold
curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64
sudo install skaffold /usr/local/bin/
----

== D√©ploiement

1. **Cloner le d√©p√¥t**:
+
[source,bash]
----
git clone <URL_DU_DEPOT_GIT_EXAI>
cd <NOM_DU_DOSSIER_PROJET_EXAI>
----

2. **D√©marrer Minikube**:
+
[source,bash]
----
minikube start
# Pour plus de ressources: minikube start --memory 4096 --cpus 2
----

3. **Cr√©er le namespace**:
+
[source,bash]
----
kubectl create namespace exai
----

4. **Configurer Docker pour Minikube**:
+
[source,bash]
----
# Linux/macOS
eval $(minikube docker-env)

# Windows (PowerShell)
& minikube -p minikube docker-env --shell powershell | Invoke-Expression
----

5. **D√©ployer avec Skaffold**:
+
[source,bash]
----
skaffold dev
----
+
Skaffold va :
+
--
* Construire les images Docker pour `api-gateway` et `service-selection`
* D√©ployer les manifestes Kubernetes (PostgreSQL, API Gateway, Service Selection)
* Configurer des redirections de port
* Surveiller les changements de code et red√©ployer automatiquement
* Afficher les logs en temps r√©el
--
+
[IMPORTANT]
====
Le premier d√©ploiement peut prendre plusieurs minutes. Attendez que tous les pods passent √† l'√©tat `Running`.

[.underline]#*ATTENTION*# : Contrairement √† ce qui pourrait √™tre affich√© dans la console Skaffold, les services ne sont *PAS* directement accessibles via localhost. Vous devez utiliser les commandes `minikube service` d√©crites dans la section suivante.
====

=== Initialisation de la Base de Donn√©es

L'architecture EXAI utilise une base de donn√©es PostgreSQL partag√©e par tous les microservices, chaque service g√©rant ses migrations sp√©cifiques.

Ex√©cutez les migrations depuis les pods Kubernetes :

==== Service de S√©lection
[source,bash]
----
# 1. Identifier le pod
kubectl get pods -n exai -l app=service-selection

# 2. Ex√©cuter la migration (remplacer <pod-name>)
kubectl exec -it <pod-name> -n exai -- bash -c "cd /app && DATABASE_URL='postgresql+asyncpg://exai_user:password@postgresql-service:5432/exai_db' alembic upgrade head"
----

==== API Gateway
[source,bash]
----
# Identifier le pod et ex√©cuter la migration
kubectl get pods -n exai -l app=api-gateway
kubectl exec -it <pod-name> -n exai -- bash -c "cd /app && DATABASE_URL='postgresql+asyncpg://exai_user:password@postgresql-service:5432/exai_db' alembic upgrade head"
----

[NOTE]
====
Ces commandes ex√©cutent les migrations Alembic directement √† l'int√©rieur des pods. Cela √©vite les probl√®mes de connectivit√© et assure que la configuration est identique √† celle utilis√©e par l'application.

Chaque service utilise sa propre table de version Alembic (`alembic_version_gateway` et `alembic_version_selection`) pour suivre ses migrations dans la base de donn√©es partag√©e.
====

=== Acc√©der √† l'Application

[.underline]#*IMPORTANT*# : Les services dans Minikube ne sont accessibles QUE via les commandes suivantes :

[source,bash]
----
# Acc√©der au Service de S√©lection
minikube service service-selection-service -n exai

# Acc√©der √† l'API Gateway
minikube service api-gateway-service -n exai

# Pour obtenir seulement l'URL (sans ouvrir le navigateur)
minikube service service-selection-service -n exai --url
----

[IMPORTANT]
====
Sur Windows avec le driver Docker, gardez la fen√™tre du terminal ouverte pendant l'utilisation du service (elle maintient le tunnel actif).
====

[TIP]
====
Pour obtenir uniquement l'URL sans ouvrir de navigateur, ajoutez le flag `--url` :
`minikube service service-selection-service -n exai --url`
====

== Workflow de D√©veloppement

=== Cycle de D√©veloppement avec Skaffold
1. Modifiez votre code
2. Skaffold d√©tecte les changements
3. Reconstruction et red√©ploiement automatiques
4. Services red√©marr√©s avec le nouveau code

[TIP]
Pour un workflow plus fluide, utilisez des outils comme **Lens**, **k9s** ou le **Kubernetes Dashboard** (`minikube dashboard`).

== D√©pannage

=== Probl√®mes Courants
* *Minikube ne d√©marre pas* : V√©rifiez Docker Desktop, essayez `minikube delete` puis `minikube start`
* *Pod bloqu√© en `Pending`* : Augmentez les ressources (`minikube stop && minikube config set memory 4096 && minikube start`)
* *Pod en `CrashLoopBackOff`* : V√©rifiez les logs avec `kubectl logs -n exai <pod-name>`

=== √âtapes de Diagnostic
1. Logs Skaffold
2. √âtat des pods : `kubectl get pods -n exai`
3. D√©tails d'un pod : `kubectl describe pod <pod-name> -n exai`
4. Logs d'un pod : `kubectl logs -n exai <pod-name>`
5. Logs Minikube : `minikube logs`

== Arr√™ter l'environnement
[source,bash]
----
# Arr√™ter Skaffold : Ctrl+C

# Arr√™ter Minikube
minikube stop

# Supprimer compl√®tement Minikube (supprime les donn√©es)
minikube delete
----