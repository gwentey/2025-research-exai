= üöÄ Installation et D√©marrage Rapide d'EXAI

Bienvenue dans le guide de d√©marrage du projet EXAI !

Ce document vous explique comment installer les outils n√©cessaires et d√©ployer l'application EXAI sur votre ordinateur personnel en utilisant Minikube. Minikube nous permet de simuler un environnement Kubernetes (l'outil utilis√© pour orchestrer nos microservices) localement pour le d√©veloppement et les tests.

Suivez attentivement ces √©tapes pour avoir une instance fonctionnelle d'EXAI.

== √âtape 1 : Pr√©parer votre Environnement de D√©veloppement

Avant de pouvoir d√©ployer EXAI, vous devez installer quelques outils essentiels sur votre machine.

=== Pr√©requis Logiciels

Assurez-vous d'avoir les logiciels suivants install√©s :

1.  **Docker Desktop** : C'est le moteur qui g√®re nos conteneurs logiciels. Minikube l'utilise en arri√®re-plan.
    *   *Installation :* Suivez les instructions sur le site officiel de https://www.docker.com/products/docker-desktop/[Docker Desktop^].
    *   *V√©rification :* Ouvrez un terminal et tapez `docker --version`. Vous devriez voir une version s'afficher.

2.  **Minikube** : L'outil pour ex√©cuter un cluster Kubernetes √† n≈ìud unique sur votre machine.
    *   *Installation :* Voir les commandes ci-dessous pour votre syst√®me d'exploitation ou consultez la https://minikube.sigs.k8s.io/docs/start/[documentation officielle de Minikube^].
    *   *V√©rification :* Apr√®s installation, tapez `minikube version` dans votre terminal.

3.  **kubectl** : L'outil en ligne de commande pour interagir avec votre cluster Kubernetes (local ou distant).
    *   *Installation :* Voir les commandes ci-dessous ou consultez la https://kubernetes.io/docs/tasks/tools/install-kubectl/[documentation officielle de kubectl^].
    *   *V√©rification :* Apr√®s installation, tapez `kubectl version --client` dans votre terminal.

4.  **Terminal Bash (Recommand√©)** : Pour ex√©cuter les commandes de ce guide.
    *   *Windows :* Utilisez https://gitforwindows.org/[Git Bash^] (inclus avec Git pour Windows) ou WSL (Windows Subsystem for Linux).
    *   *macOS/Linux :* Utilisez le terminal int√©gr√©.

5.  **(Optionnel mais recommand√©) Gestionnaire de paquets :**
    *   *Windows :* https://chocolatey.org/install[Chocolatey^]
    *   *macOS :* https://brew.sh/[Homebrew^]

=== Commandes d'Installation (Minikube & kubectl)

Choisissez les commandes correspondant √† votre syst√®me :

*   **Windows (avec Chocolatey)** :
    Ouvrez PowerShell en tant qu'administrateur :
[source,powershell]
----
choco install minikube
choco install kubernetes-cli
----

*   **macOS (avec Homebrew)** :
    Ouvrez votre Terminal :
[source,bash]
----
brew install minikube
brew install kubectl
----

*   **Linux (Debian/Ubuntu)** :
    Ouvrez votre Terminal :
[source,bash]
----
# Installer Minikube
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
sudo install minikube-linux-amd64 /usr/local/bin/minikube
rm minikube-linux-amd64

# Installer kubectl
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
rm kubectl
----

Apr√®s l'installation, v√©rifiez que les outils fonctionnent avec les commandes `minikube version` et `kubectl version --client`.

== √âtape 2 : Cloner le D√©p√¥t du Projet

Si ce n'est pas d√©j√† fait, r√©cup√©rez le code source du projet EXAI depuis son d√©p√¥t Git.

[source,bash]
----
git clone <URL_DU_DEPOT_GIT_EXAI>
cd <NOM_DU_DOSSIER_PROJET_EXAI>
----
IMPORTANT: Ex√©cutez toutes les commandes suivantes depuis la racine de ce dossier projet clon√©.

== √âtape 3 : D√©ployer l'Application EXAI sur Minikube

Maintenant que les outils sont pr√™ts, nous allons d√©marrer notre cluster local et y d√©ployer les composants d'EXAI.

=== 3.1 D√©marrer Minikube

Minikube va cr√©er une machine virtuelle (ou utiliser un conteneur Docker) pour h√©berger votre cluster Kubernetes.

. Ouvrez votre terminal (√† la racine du projet EXAI).
. Lancez la commande suivante :

[source,bash]
----
minikube start
# Astuce: Si vous avez plusieurs Go de RAM, vous pouvez allouer plus de ressources:
# minikube start --memory 4096 --cpus 2
----

Le premier d√©marrage peut prendre quelques minutes car Minikube t√©l√©charge les images n√©cessaires.

. Une fois termin√©, v√©rifiez que le cluster est bien d√©marr√© :

[source,bash]
----
minikube status
----

Vous devriez voir des informations indiquant que `minikube`, `apiserver`, et `kubeconfig` sont `Running` ou `Configured`.

=== 3.2 Cr√©er un Espace de Noms (Namespace)

Pour garder notre application organis√©e et isol√©e des autres composants syst√®me de Kubernetes, nous cr√©ons un "namespace" appel√© `exai`.

[source,bash]
----
kubectl create namespace exai
----

NOTE: Si vous voyez une erreur indiquant que le namespace existe d√©j√† (`Error from server (AlreadyExists)`), ce n'est pas grave, vous pouvez continuer.

=== 3.3 D√©ployer les Composants EXAI avec le Script Automatis√©

Pour simplifier le d√©ploiement de tous les composants n√©cessaires (PostgreSQL, API Gateway, Service Selection) sur votre cluster Minikube, un script Python multiplateforme a √©t√© pr√©par√©.

[TIP]
====
Ce script automatise l'application des fichiers de configuration Kubernetes (`kubectl apply`) pour chaque composant et v√©rifie ensuite si les pods correspondants d√©marrent. Il est compatible avec Windows, macOS et Linux.
====

. *Pr√©requis pour le script :*
+
--
* Assurez-vous que `kubectl` est install√© et configur√© pour pointer vers votre cluster Minikube (voir les √©tapes pr√©c√©dentes).
* Python 3.6+ doit √™tre install√© sur votre syst√®me. V√©rifiez avec:
+
[source,bash]
----
python --version
# ou
python3 --version
----
* (Facultatif mais recommand√©) Ouvrez le script `deploy_app.py` et v√©rifiez que les variables `POSTGRES_K8S_DIR`, `GATEWAY_K8S_DIR`, `SELECTION_K8S_DIR` ainsi que les `..._LABEL` correspondants pointent vers les bons r√©pertoires et utilisent les bons s√©lecteurs de labels pour votre configuration Kubernetes.
--

. *Ex√©cuter le script de d√©ploiement :*
+
Depuis la racine du projet EXAI, lancez le script :
+
[source,bash]
----
# Sur Windows
python deploy_app.py

# Sur Linux/macOS
python3 deploy_app.py
# ou rendez-le ex√©cutable d'abord puis ex√©cutez-le directement
# chmod +x deploy_app.py
# ./deploy_app.py
----
+
Le script va afficher la progression du d√©ploiement pour chaque composant (PostgreSQL, API Gateway, Service Selection) et terminera en montrant l'√©tat des pods pour chacun d'eux. Des messages color√©s facilitent la lecture des r√©sultats.

. *V√©rification :*
+
Le script ex√©cute automatiquement `kubectl get pods` √† la fin. Attendez que le statut de tous les pods (PostgreSQL, api-gateway-..., service-selection-...) passe √† `Running`. Cela peut prendre quelques minutes.
+
Vous pouvez toujours relancer manuellement la v√©rification pour tous les pods dans le namespace `exai` avec :
+
[source,bash]
----
kubectl get pods -n exai
----
+
Si des pods restent bloqu√©s sur `Pending` ou `ContainerCreating` pendant longtemps, consultez la section D√©pannage.

=== 3.4 Initialiser/Mettre √† jour le Sch√©ma de Base de Donn√©es (Alembic)

[IMPORTANT]
====
Le script `deploy_app.py` d√©ploie l'infrastructure (pods, services), mais *ne cr√©e pas ou ne met pas √† jour* le sch√©ma des tables dans la base de donn√©es PostgreSQL.
Cette √©tape doit √™tre effectu√©e *apr√®s* que le pod PostgreSQL soit `Running`.
====

Une fois que PostgreSQL est d√©ploy√© sur Minikube (confirm√© par le script ou `kubectl get pods`), le sch√©ma des tables requises par les microservices (`user`, `datasets`, etc.) doit √™tre cr√©√© ou mis √† jour.
Ce projet utilise **Alembic** pour g√©rer ces migrations de mani√®re versionn√©e.

[IMPORTANT]
====
Apr√®s le premier d√©ploiement de la base de donn√©es, ou lors d'une mise √† jour de l'application n√©cessitant des changements de sch√©ma, vous devez appliquer les migrations Alembic manuellement depuis votre environnement de d√©veloppement local connect√© √† Minikube.

Consultez le guide d√©taill√© sur les migrations pour les √©tapes pr√©cises et le contexte :
* xref:development/database-migrations.adoc[Gestion des Migrations de Base de Donn√©es avec Alembic]

En r√©sum√©, l'application initiale des migrations implique :

1.  **Lancer le tunnel r√©seau** vers la base de donn√©es Minikube (√† laisser tourner dans un terminal s√©par√©) :

[source,bash]
----
kubectl port-forward service/postgresql-service -n exai 5432:5432
----

2.  **Configurer la connexion locale :**

[source,bash]
----
# Copier le fichier d'exemple de configuration en fichier .env √† la racine du projet
cp .env.example .env

# Vous pouvez √©galement modifier ce fichier .env si n√©cessaire pour ajuster les param√®tres de connexion
----

S'assurer que le fichier `.env` √† la racine du projet contient la bonne `DATABASE_URL` pointant vers `localhost:5432` pour permettre aux migrations Alembic de se connecter √† la base de donn√©es.

3.  **Cr√©er et activer un environnement virtuel Python** pour isoler les d√©pendances (faites ceci pour `api-gateway` et `service-selection`) :

[source,bash]
----
# Depuis le r√©pertoire du service (par exemple api-gateway/)
python -m venv .venv

# Activation sur Linux/macOS
source .venv/bin/activate

# Activation sur Windows (PowerShell)
.\.venv\Scripts\Activate.ps1

# Activation sur Windows (CMD)
.\.venv\Scripts\activate.bat
----

4.  **Installer les d√©pendances** pour chaque service :

[source,bash]
----
# Dans l'environnement virtuel activ√© du service concern√©
pip install -r requirements.txt
----

5.  **Charger les variables d'environnement** du fichier `.env` (n√©cessaire dans le terminal o√π vous lancerez Alembic) :

[source,bash]
----
# Sur Linux/macOS
export $(grep -v '^#' .env | xargs)

# Sur Windows (PowerShell)
Get-Content .env | Where-Object {$_ -notmatch '^#' -and $_ -match '='} | ForEach-Object { $var = $_.Split('=', 2); Set-Item "env:$($var[0])" $var[1] }

# Alternative: installer et utiliser python-dotenv si ce n'est pas d√©j√† fait
# pip install python-dotenv
----

6.  **Appliquer les migrations** pour chaque service (depuis le r√©pertoire du service respectif, avec l'environnement virtuel activ√© et les variables d'env charg√©es) :

[source,bash]
----
# Depuis le r√©pertoire api-gateway/
alembic upgrade head

# Depuis le r√©pertoire service-selection/
alembic upgrade head
----
====

=== 3.5 Acc√©der √† l'Application

Une fois que tous les pods sont `Running`, vous pouvez acc√©der √† l'application. L'acc√®s principal se fait g√©n√©ralement via le Frontend.

. Obtenez l'URL d'acc√®s au service frontend :
[source,bash]
----
minikube service frontend --url -n exai
----
  Cette commande ouvrira peut-√™tre directement l'URL dans votre navigateur, ou affichera l'URL (ex: `http://127.0.0.1:xxxxx`) dans le terminal.

. Ouvrez l'URL retourn√©e dans votre navigateur web. Vous devriez voir l'interface utilisateur d'EXAI.

Pour explorer les API directement (par exemple, pour le d√©veloppement ou des tests avanc√©s) :

. Obtenez l'URL de l'API Gateway :
[source,bash]
----
minikube service api-gateway --url -n exai
----

. Acc√©dez √† la documentation interactive (Swagger UI) en ajoutant `/docs` √† l'URL obtenue : `http://127.0.0.1:yyyyy/docs`.

Voir la page xref:dev-guide/api-reference.adoc[R√©f√©rence API] pour plus de d√©tails sur l'utilisation des API.

F√©licitations ! Vous avez d√©ploy√© EXAI localement avec Minikube.

== (Optionnel) D√©pannage

*   **Minikube ne d√©marre pas :** V√©rifiez que Docker Desktop est lanc√©. Essayez `minikube delete` puis `minikube start`. V√©rifiez les logs avec `minikube logs`. Assurez-vous que la virtualisation est activ√©e dans le BIOS/UEFI de votre machine si vous n'utilisez pas le driver Docker.
*   **Pod bloqu√© en `Pending` :** Manque de ressources (CPU/M√©moire) ? Essayez d'allouer plus de ressources √† Minikube (`minikube stop`, `minikube config set memory 4096`, `minikube start`). Probl√®me de r√©seau ? V√©rifiez la sortie de `kubectl describe pod <nom-du-pod> -n exai`.
*   **Pod bloqu√© en `ImagePullBackOff` ou `ErrImagePull`:** L'image Docker n'a pas pu √™tre trouv√©e. Avez-vous bien ex√©cut√© `eval $(minikube -p minikube docker-env)` (ou √©quivalent) *avant* de lancer `docker build` ? Le nom et le tag de l'image dans `k8s/deployment.yaml` correspondent-ils exactement √† ceux utilis√©s lors du `docker build` ? Avez-vous mis `imagePullPolicy: IfNotPresent` ou `Never` dans le `deployment.yaml` pour les images locales ?
*   **`minikube service ... --url` ne fonctionne pas :** Assurez-vous que le service Kubernetes existe (`kubectl get services -n exai`). V√©rifiez l'√©tat du pod associ√©.

== Arr√™ter l'environnement

Pour arr√™ter l'application et lib√©rer les ressources :

[source,bash]
----
minikube stop
----

Pour supprimer compl√®tement le cluster Minikube (attention, supprime toutes les donn√©es) :
[source,bash]
----
minikube delete
---- 