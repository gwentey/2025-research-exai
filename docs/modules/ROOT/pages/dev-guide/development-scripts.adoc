= Scripts de D√©veloppement IBIS-X
:navtitle: Scripts D√©veloppement
:toc:
:toc-title: Table des mati√®res
:toclevels: 3
:icons: font

== Vue d'ensemble

Ce guide documente les scripts Python essentiels pour le d√©veloppement local d'IBIS-X. Ces scripts sont int√©gr√©s dans le Makefile et g√®rent automatiquement les port-forwards, la validation des datasets et la gestion des secrets.

== Scripts Essentiels

=== fix-portforwards-permanent.py

**Utilisation :** Script principal int√©gr√© dans `make dev`

**Fonctionnalit√©s :**
* ‚úÖ Nettoie automatiquement les processus `kubectl` zombies
* ‚úÖ Red√©marre tous les port-forwards n√©cessaires
* ‚úÖ V√©rifie la connectivit√© de chaque service
* ‚úÖ G√®re les conflits de ports sur Windows

**Int√©gration :**
[source,bash]
----
# Utilis√© automatiquement par make dev
make dev
----

**Services g√©r√©s :**
* Frontend (port 8080)
* API Gateway (port 9000)
* MinIO (port 6700)
* PostgreSQL (port 5432)
* Redis (port 6379)

=== fix-portforwards-dev-safe.py

**Utilisation :** Version "safe" pour `make dev-data`

**Fonctionnalit√©s :**
* ‚úÖ D√©marre uniquement les port-forwards manquants
* ‚úÖ Ne tue PAS les processus existants (comme les logs)
* ‚úÖ Compatible avec `make dev` en cours d'ex√©cution

**Int√©gration :**
[source,bash]
----
# Utilis√© automatiquement par make dev-data
make dev-data
----

=== validate-kaggle-datasets.py

**Utilisation :** Validation des datasets import√©s depuis Kaggle

**Fonctionnalit√©s :**
* ‚úÖ V√©rifie que les datasets sont stock√©s avec des UUIDs
* ‚úÖ Valide la structure MinIO
* ‚úÖ Confirme que les fichiers sont au format Parquet
* ‚úÖ D√©tecte les fausses donn√©es

**Int√©gration :**
[source,bash]
----
# Utilis√© automatiquement par make dev-data
make dev-data
----

**Exemple de sortie :**
[source,bash]
----
üìä Dataset: student_performance
   ID: e76ac7f2-5351-446d-9471-97482e60393d
   ‚úÖ Storage path contient un UUID
   ‚úÖ Fichiers Parquet trouv√©s
   ‚úÖ Taille totale raisonnable (0.07 MB)
   ‚úÖ DATASET VALIDE
----

=== update-local-secrets.py

**Utilisation :** Configuration des secrets depuis fichier `.env`

**Fonctionnalit√©s :**
* ‚úÖ Lit les variables depuis `.env`
* ‚úÖ Encode automatiquement en base64
* ‚úÖ Met √† jour les fichiers YAML secrets
* ‚úÖ Pr√©pare l'environnement pour `make dev`

**Utilisation :**
[source,bash]
----
# Apr√®s avoir cr√©√© votre fichier .env
python scripts/development/update-local-secrets.py
----

**Fichier .env requis :**
[source,bash]
----
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/ibis_x_dev
JWT_SECRET_KEY=dev-secret-key-12345
GOOGLE_CLIENT_ID=votre-google-client-id
GOOGLE_CLIENT_SECRET=votre-google-client-secret
OAUTH_REDIRECT_URL=http://localhost:4200/auth/callback
KAGGLE_USERNAME=votre-username-kaggle
KAGGLE_KEY=votre-cle-kaggle
----

=== reset-placeholders.py

**Utilisation :** Nettoyage des secrets avant commit Git

**Fonctionnalit√©s :**
* ‚úÖ Trouve tous les fichiers `*secrets*.yaml`
* ‚úÖ Remplace les vraies valeurs par des placeholders
* ‚úÖ √âvite de committer des secrets sensibles

**Utilisation :**
[source,bash]
----
# Nettoyer les secrets avant commit
python scripts/development/reset-placeholders.py
----

**Exemple :**
[source,yaml]
----
# AVANT (dangereux pour Git)
secret-key: ma-vraie-cle-secrete-123
google-client-id: 123456789-abc.apps.googleusercontent.com

# APR√àS (s√ªr pour Git)
secret-key: REPLACE_WITH_SECRET_KEY
google-client-id: REPLACE_WITH_GOOGLE_CLIENT_ID
----

== Workflow de D√©veloppement

=== Setup Initial

[source,bash]
----
# 1. Cr√©er le fichier .env avec vos credentials
cp .env.example .env
# √âditer .env avec vos vraies valeurs

# 2. Configurer les secrets
python scripts/development/update-local-secrets.py

# 3. Lancer le d√©veloppement local
make dev
----

=== Avant Chaque Commit

[source,bash]
----
# Nettoyer les secrets
python scripts/development/reset-placeholders.py

# Commit s√©curis√©
git add .
git commit -m "votre message"
----

=== Apr√®s Pull/Merge

[source,bash]
----
# Reconfigurer les secrets locaux
python scripts/development/update-local-secrets.py
----

== D√©pannage

=== Probl√®me : "Variables manquantes dans .env"

[source,bash]
----
# V√©rifier votre fichier .env
cat .env

# Copier depuis l'exemple
cp .env.example .env
# Puis √©diter avec vos valeurs
----

=== Probl√®me : "Fichiers secrets non trouv√©s"

[source,bash]
----
# V√©rifier la structure
ls -la k8s/base/*/secrets*.yaml
ls -la k8s/overlays/*/secrets*.yaml
----

=== Probl√®me : Secrets non appliqu√©s en local

[source,bash]
----
# Re-ex√©cuter la configuration
python scripts/development/update-local-secrets.py

# Relancer le d√©veloppement
make dev-clean  # si n√©cessaire
make dev
----

== R√®gles de S√©curit√©

=== ‚úÖ √Ä FAIRE
* **TOUJOURS** ex√©cuter `reset-placeholders.py` avant commit
* Garder le fichier `.env` en local uniquement
* Utiliser des credentials de d√©veloppement/test
* V√©rifier que `.env` est dans `.gitignore`

=== ‚ùå √Ä NE JAMAIS FAIRE
* **JAMAIS** committer le fichier `.env`
* **JAMAIS** committer des secrets r√©els dans les YAML
* **JAMAIS** utiliser des credentials de production en local
* **JAMAIS** partager le fichier `.env` publiquement

== Fichiers G√©r√©s

Ces scripts modifient automatiquement :
* `k8s/base/api-gateway/gateway-secrets.yaml`
* `k8s/base/service-selection/kaggle-secrets.yaml`
* `k8s/overlays/azure/oauth-redirect-patch.yaml`

== Int√©gration avec Makefile

Les scripts sont int√©gr√©s dans le Makefile pour une utilisation transparente :

[source,makefile]
----
# Int√©gration automatique dans make dev
dev-logs: stop-portforwards
	@python scripts/development/fix-portforwards-permanent.py

# Int√©gration automatique dans make dev-data
dev-data: check-prerequisites
	@python scripts/development/fix-portforwards-dev-safe.py
	@python scripts/development/validate-kaggle-datasets.py

# Commande manuelle pour corriger les port-forwards
fix-portforwards:
	@python scripts/development/fix-portforwards-permanent.py
----

TIP: **Conseil :** Automatisez avec un hook Git pour ex√©cuter `reset-placeholders.py` avant chaque commit !
