= S√©curit√© des Projets Utilisateur
:description: Documentation sur la s√©curisation des projets par utilisateur
:keywords: s√©curit√©, authentification, autorisation, projets, user_id
:page-navtitle: S√©curit√© Projets

== Vue d'ensemble

Cette page documente la mise en place de la s√©curisation des projets utilisateur dans l'architecture IBIS-X, garantissant que chaque utilisateur ne peut acc√©der qu'√† ses propres projets.

IMPORTANT: Cette fonctionnalit√© corrige un **trou de s√©curit√© critique** o√π tous les projets √©taient accessibles √† tous les utilisateurs.

== Probl√®me de s√©curit√© identifi√© (2025-01-25)

=== Description du probl√®me

**Vuln√©rabilit√© critique :**
- ‚ùå Tous les projets √©taient accessibles √† tous les utilisateurs connect√©s
- ‚ùå Les endpoints de projets n'avaient aucune v√©rification d'appartenance
- ‚ùå L'`user_id` √©tait g√©n√©r√© al√©atoirement au lieu d'utiliser l'utilisateur connect√©
- ‚ùå Possible acc√®s aux projets d'autres utilisateurs en devinant les IDs

**Endpoints vuln√©rables :**
- `GET /projects` - Listait TOUS les projets
- `POST /projects` - Cr√©ait des projets avec `user_id` al√©atoire
- `GET /projects/{id}` - Acc√®s √† n'importe quel projet
- `PUT /projects/{id}` - Modification de n'importe quel projet  
- `DELETE /projects/{id}` - Suppression de n'importe quel projet
- `GET /projects/{id}/recommendations` - Recommandations de n'importe quel projet

=== Impact de la vuln√©rabilit√©

- **üî¥ Confidentialit√© :** Acc√®s aux projets priv√©s d'autres utilisateurs
- **üî¥ Int√©grit√© :** Possibilit√© de modifier/supprimer les projets d'autrui
- **üî¥ Disponibilit√© :** Risque de suppression accidentelle ou malveillante
- **üî¥ Conformit√© RGPD :** Violation des donn√©es personnelles

== Solution mise en place

=== Architecture de s√©curit√©

[source,mermaid]
----
graph TD
    A[Frontend Angular] -->|JWT Token| B[API Gateway]
    B -->|Authentification| C{Utilisateur valide?}
    C -->|Non| D[Erreur 401]
    C -->|Oui| E[Extraction user_id]
    E -->|Header X-User-ID| F[Service Selection]
    F -->|Filtrage par user_id| G[Base de donn√©es]
    G -->|Projets de l'utilisateur uniquement| H[R√©ponse s√©curis√©e]
----

=== M√©canisme d'authentification

==== 1. API Gateway (Transmission de l'user_id)

**Fichier :** `api-gateway/app/main.py`

```python
# Fonction proxy_request modifi√©e
headers = {
    "Content-Type": "application/json",
    "User-Agent": "API-Gateway-Proxy/1.0",
    "X-User-ID": str(current_user.id),      # ‚úÖ ID utilisateur transmis
    "X-User-Email": current_user.email      # ‚úÖ Email pour debug
}
```

**M√©canisme :**
- L'API Gateway extrait l'utilisateur connect√© via `current_active_user`
- L'`user_id` est transmis au service-selection via le header `X-User-ID`
- Tous les endpoints de projets n√©cessitent une authentification

==== 2. Service Selection (V√©rification de l'user_id)

**Fichier :** `service-selection/app/main.py`

```python
# D√©pendance d'authentification
def get_current_user_id(x_user_id: str = Header(..., alias="X-User-ID")) -> UUID4:
    try:
        user_id = uuid.UUID(x_user_id)
        return user_id
    except ValueError:
        raise HTTPException(status_code=401, detail="ID utilisateur invalide")
```

**Fonctionnement :**
- Extraction automatique de l'`user_id` depuis les headers
- Validation du format UUID
- Erreur 401 si header manquant ou invalide

=== Endpoints s√©curis√©s

==== GET /projects - Liste des projets

**Avant (vuln√©rable) :**
```python
# ‚ùå Tous les projets de tous les utilisateurs
query = db.query(models.Project)
```

**Apr√®s (s√©curis√©) :**
```python
# ‚úÖ Seulement les projets de l'utilisateur connect√©
current_user_id: UUID4 = Depends(get_current_user_id)
query = db.query(models.Project).filter(models.Project.user_id == current_user_id)
```

==== POST /projects - Cr√©ation de projet

**Avant (vuln√©rable) :**
```python
# ‚ùå user_id g√©n√©r√© al√©atoirement
user_id = uuid.uuid4()  # Temporaire
```

**Apr√®s (s√©curis√©) :**
```python
# ‚úÖ user_id de l'utilisateur connect√©
current_user_id: UUID4 = Depends(get_current_user_id)
db_project = models.Project(user_id=current_user_id, ...)
```

==== GET/PUT/DELETE /projects/{id} - Op√©rations sur projet

**Avant (vuln√©rable) :**
```python
# ‚ùå N'importe quel projet accessible
project = db.query(models.Project).filter(models.Project.id == project_id).first()
```

**Apr√®s (s√©curis√©) :**
```python
# ‚úÖ Seulement les projets de l'utilisateur connect√©
project = db.query(models.Project).filter(
    models.Project.id == project_id,
    models.Project.user_id == current_user_id  # ‚úÖ V√©rification obligatoire
).first()
```

==== Gestion des erreurs de s√©curit√©

```python
if not project:
    # ‚úÖ Ne pas r√©v√©ler l'existence du projet √† d'autres utilisateurs
    raise HTTPException(status_code=404, detail="Projet non trouv√©")
```

**Principe :** Retourner 404 (non trouv√©) plut√¥t que 403 (interdit) pour ne pas r√©v√©ler l'existence de projets d'autres utilisateurs.

=== Logging de s√©curit√©

Tous les endpoints incluent maintenant des logs de s√©curit√© :

```python
logger.info(f"‚úÖ Utilisateur {current_user_id} - Action sur projet: {project_id}")
```

**Types de logs :**
- Cr√©ation de projet
- Acc√®s √† un projet  
- Modification de projet
- Suppression de projet
- G√©n√©ration de recommandations

== Tests de s√©curit√©

=== Sc√©narios de test

==== Test 1 : Isolation des projets par utilisateur

1. **Utilisateur A** se connecte et cr√©e un projet
2. **Utilisateur B** se connecte 
3. **Utilisateur B** tente d'acc√©der au projet de A
4. **R√©sultat attendu :** Erreur 404 "Projet non trouv√©"

==== Test 2 : Authentification requise

1. Requ√™te vers `/projects` sans token JWT
2. **R√©sultat attendu :** Erreur 401 "Non autoris√©"

==== Test 3 : Header X-User-ID requis

1. Requ√™te avec token JWT valide mais sans header `X-User-ID`
2. **R√©sultat attendu :** Erreur 401 "ID utilisateur invalide"

=== Validation en logs

```
‚úÖ Utilisateur 123e4567-e89b-12d3-a456-426614174000 - Liste de 3 projets sur 3
‚úÖ Utilisateur 123e4567-e89b-12d3-a456-426614174000 - Nouveau projet cr√©√©: proj-456 'Mon Projet'
‚úÖ Utilisateur 123e4567-e89b-12d3-a456-426614174000 - Acc√®s au projet: proj-456
```

== Consid√©rations de performance

=== Impact des filtres de s√©curit√©

- **Index recommand√© :** `CREATE INDEX idx_projects_user_id ON projects(user_id);`
- **Requ√™tes optimis√©es :** Filtrage au niveau SQL plut√¥t qu'application
- **Cache utilisateur :** Possibilit√© de mise en cache des projets par utilisateur

=== Monitoring

Surveiller dans les logs :
- Tentatives d'acc√®s avec headers invalides
- Pics de requ√™tes 404 (tentatives d'acc√®s non autoris√©)
- Performance des requ√™tes filtr√©es par user_id

== Conformit√© et audit

=== Conformit√© RGPD

- ‚úÖ **Minimisation des donn√©es :** Chaque utilisateur ne voit que ses donn√©es
- ‚úÖ **Confidentialit√© :** Isolation stricte entre utilisateurs
- ‚úÖ **Tra√ßabilit√© :** Logs d√©taill√©s de tous les acc√®s

=== Audit de s√©curit√©

- ‚úÖ Tous les endpoints de projets s√©curis√©s
- ‚úÖ Validation des entr√©es utilisateur (UUID)
- ‚úÖ Gestion des erreurs s√©curis√©e (pas de fuite d'information)
- ‚úÖ Logging complet des op√©rations

== Migration et d√©ploiement

=== Donn√©es existantes

Si des projets existaient avant la correction :

```sql
-- Identifier les projets avec user_id incorrect
SELECT id, name, user_id FROM projects WHERE user_id NOT IN (SELECT id FROM users);

-- Option 1: Supprimer les projets orphelins
DELETE FROM projects WHERE user_id NOT IN (SELECT id FROM users);

-- Option 2: R√©assigner √† un utilisateur administrateur
UPDATE projects SET user_id = 'admin-uuid' WHERE user_id NOT IN (SELECT id FROM users);
```

=== D√©ploiement sans interruption

1. D√©ployer l'API Gateway modifi√©e (transmission headers)
2. D√©ployer le service-selection s√©curis√©
3. V√©rifier les logs de s√©curit√©
4. Nettoyer les donn√©es existantes si n√©cessaire

== Fichiers modifi√©s

=== API Gateway

- `api-gateway/app/main.py` : Transmission user_id via headers

=== Service Selection

- `service-selection/app/main.py` : 
  - Ajout d√©pendance `get_current_user_id()`
  - S√©curisation de tous les endpoints de projets
  - Ajout logs de s√©curit√©

=== Documentation

- `docs/dev-guide/project-security.adoc` : Cette documentation
- `memory-bank/architecture.md` : Mise √† jour architecture

== Prochaines √©tapes

=== Am√©liorations possibles

1. **Rate limiting** par utilisateur pour √©viter les abus
2. **Audit trail** d√©taill√© avec horodatage pr√©cis  
3. **Chiffrement** des donn√©es sensibles dans les projets
4. **Permissions granulaires** (lecture/√©criture/partage)
5. **Partage de projets** entre utilisateurs autoris√©s

=== Monitoring recommand√©

- Alertes sur tentatives d'acc√®s non autoris√©
- M√©triques de performance des requ√™tes filtr√©es
- Tableau de bord de s√©curit√© en temps r√©el 
