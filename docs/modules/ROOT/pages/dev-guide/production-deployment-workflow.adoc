= Workflow de DÃ©ploiement Production AutomatisÃ©
:navtitle: DÃ©ploiement Production

== Vue d'ensemble

Le workflow de dÃ©ploiement production IBIS-X est maintenant **100% automatisÃ©** avec gestion intelligente de l'IP publique statique. Ce guide explique le processus optimisÃ© pour supprimer et recrÃ©er l'infrastructure complÃ¨te.

== Workflow Utilisateur Standard

=== ğŸ”„ Processus Complet

[source,bash]
----
# 1. Supprimer complÃ¨tement le cluster Kubernetes sur Azure
# (via Azure Portal ou Azure CLI)

# 2. ExÃ©cuter le script de dÃ©ploiement
bash scripts/deploy-to-azure.sh

# 3. DÃ©clencher la pipeline GitHub Actions
# (push sur branch 'production' ou manuel)
----

=== âœ… Automatisations Incluses

Le script `deploy-to-azure.sh` gÃ¨re automatiquement :

* **ğŸ“¡ IP Publique Statique** : Configuration automatique via Terraform
* **ğŸŒ NGINX Ingress** : Utilisation de l'IP statique (plus de changement d'IP !)
* **ğŸ” Secrets Kubernetes** : CrÃ©ation automatique avec vraies valeurs Azure
* **ğŸ³ Images Docker** : Build et push automatiques vers ACR
* **ğŸ—ï¸ Infrastructure** : CrÃ©ation/dÃ©tection automatique via Terraform

== Configuration IP Statique Automatique

=== ğŸ¯ ProblÃ¨me RÃ©solu

**Avant :** L'IP publique changeait Ã  chaque redÃ©ploiement â†’ Configuration DNS requise Ã  chaque fois

**Maintenant :** IP statique automatique â†’ DNS configurÃ© une seule fois !

=== ğŸ”§ Fonctionnement Technique

[source,bash]
----
# Le script configure automatiquement :
# 1. RÃ©cupÃ©ration IP statique depuis Terraform
# 2. DÃ©tection du Resource Group AKS automatique  
# 3. Mise Ã  jour nginx-ingress-values.yaml
# 4. Installation NGINX avec IP statique
----

.Configuration automatique nginx-ingress-values.yaml
[source,yaml]
----
controller:
  service:
    type: LoadBalancer
    annotations:
      # âœ… ConfigurÃ© automatiquement par deploy-to-azure.sh
      service.beta.kubernetes.io/azure-load-balancer-static-ip: "20.172.234.65"
      service.beta.kubernetes.io/azure-load-balancer-resource-group: "MC_ibis-x-prod-rg_ibis-x-prod-aks_eastus"
----

== Avantages du Nouveau Workflow

=== ğŸš€ Pour l'Utilisateur

* **Zero Configuration** : Aucune modification manuelle requise
* **IP Stable** : Configurez DNS **une seule fois**
* **Reproductible** : Suppression/recrÃ©ation â†’ mÃªme IP publique
* **Robust** : Gestion automatique des Ã©checs et rollbacks

=== ğŸ› ï¸ Pour le DÃ©veloppeur

* **Sauvegarde Automatique** : Backup des fichiers modifiÃ©s
* **Restauration d'Erreur** : Rollback automatique en cas d'Ã©chec  
* **Logs DÃ©taillÃ©s** : VisibilitÃ© complÃ¨te du processus
* **Multi-OS** : Fonctionne Windows, Linux, macOS

== Utilisation Pratique

=== ğŸ“‹ DÃ©ploiement Complet

[source,bash]
----
# Workflow typique utilisateur :

# 1. Supprimer infrastructure (Azure Portal)
az aks delete --name ibis-x-prod-aks --resource-group ibis-x-prod-rg

# 2. DÃ©ploiement automatique
bash scripts/deploy-to-azure.sh

# 3. VÃ©rification IP statique
kubectl get svc -n ingress-nginx
# â†’ L'IP sera identique Ã  avant la suppression !

# 4. GitHub Actions (optionnel)
git push origin production
----

=== ğŸŒ Configuration DNS (Une Seule Fois)

```dns
# Configurez chez votre registrar :
Type: A
Nom: @
Valeur: [IP_STATIQUE_TERRAFORM]  # Ne change jamais !

Type: A  
Nom: www
Valeur: [IP_STATIQUE_TERRAFORM]

Type: A
Nom: api
Valeur: [IP_STATIQUE_TERRAFORM]
```

WARNING: L'IP statique reste **identique** aprÃ¨s suppression/recrÃ©ation. Configurez vos DNS **une seule fois** !

== DÃ©pannage

=== ğŸ” VÃ©rification IP Statique

[source,bash]
----
# VÃ©rifier IP configurÃ©e dans NGINX
kubectl get svc ingress-nginx-controller -n ingress-nginx

# VÃ©rifier IP Terraform
cd terraform/azure-infrastructure
terraform output public_ip_address

# Les deux doivent Ãªtre identiques !
----

=== ğŸ§¹ Nettoyage Manuel

[source,bash]
----
# Si problÃ¨me pendant dÃ©ploiement :
# Les fichiers sont automatiquement restaurÃ©s

# Nettoyage manuel force :
find k8s/ -name "*.backup-*" -delete
git checkout k8s/helm-values/nginx-ingress-values.yaml
----

== Monitoring

=== ğŸ“Š Commandes Utiles

[source,bash]
----
# Ã‰tat du dÃ©ploiement
kubectl get pods -n ibis-x
kubectl get ingress -n ibis-x  
kubectl get certificates -n ibis-x

# Logs des applications
kubectl logs -f deployment/api-gateway -n ibis-x
kubectl logs -f deployment/frontend -n ibis-x

# Test connectivitÃ©
curl -I https://ibisx.fr
curl -I https://api.ibisx.fr/health
----

== Migration depuis Ancien Workflow

Si vous utilisiez l'ancien systÃ¨me avec IP dynamique :

1. **RÃ©cupÃ©rez votre nouvelle IP statique** : `terraform output public_ip_address`
2. **Mettez Ã  jour vos DNS** avec cette IP  
3. **Supprimez/recrÃ©ez l'infrastructure** â†’ L'IP reste identique !

TIP: L'IP statique est crÃ©Ã©e par Terraform au premier dÃ©ploiement et **ne change jamais**, mÃªme aprÃ¨s suppression complÃ¨te du cluster. 