<!-- Header de la page -->
<div class="d-flex justify-content-between align-items-center m-b-20">
  <div>
    <h2 class="mat-h2 m-b-0 d-flex align-items-center">
      <mat-icon class="m-r-8">{{ isEditMode ? 'edit' : 'add' }}</mat-icon>
      {{ getPageTitle() }}
    </h2>
    <p class="mat-body-1 text-muted m-t-8">{{ isEditMode ? 'Modifiez les param√®tres de votre projet' : 'Cr√©ez un nouveau projet d\'analyse ML avec scoring automatique' }}</p>
  </div>
  <div class="d-flex gap-8">
    <button mat-stroked-button (click)="onCancel()" [disabled]="isSaving">
      <mat-icon>close</mat-icon>
      Annuler
    </button>
    <button mat-flat-button color="primary" (click)="onSave()" [disabled]="projectForm.invalid || isSaving">
      <mat-icon>{{ isSaving ? 'hourglass_empty' : 'save' }}</mat-icon>
      {{ isEditMode ? 'Mettre √† jour' : 'Cr√©er le projet' }}
    </button>
  </div>
</div>

<!-- Contenu principal -->
<div *ngIf="!isLoading">
  <!-- Premi√®re ligne - Informations du projet et Aper√ßu -->
  <div class="row">
    <!-- Colonne gauche - Informations -->
    <div class="col-lg-8">
      <!-- Informations du projet -->
      <mat-card class="cardWithShadow theme-card m-b-20">
        <mat-card-header>
          <mat-card-title class="m-b-0 d-flex align-items-center">
            <mat-icon class="m-r-8">info</mat-icon>
            Informations du Projet
          </mat-card-title>
        </mat-card-header>
        <mat-card-content class="b-t-1">
          <form [formGroup]="projectForm">
            <div class="row">
              <div class="col-lg-12">
                <mat-label class="mat-subtitle-2 f-w-600 m-b-8 d-block">Nom du projet</mat-label>
                <mat-form-field appearance="outline" class="w-100" color="primary">
                  <input matInput formControlName="name" placeholder="Ex: Analyse des performances √©tudiantes" required>
                  <mat-icon matSuffix>title</mat-icon>
                  <mat-error *ngIf="projectForm.get('name')?.hasError('required')">
                    Le nom du projet est obligatoire
                  </mat-error>
                  <mat-error *ngIf="projectForm.get('name')?.hasError('maxlength')">
                    Le nom ne peut pas d√©passer 255 caract√®res
                  </mat-error>
                </mat-form-field>
              </div>
            </div>
            
            <div class="row">
              <div class="col-lg-12">
                <mat-label class="mat-subtitle-2 f-w-600 m-b-8 d-block">Description (optionnelle)</mat-label>
                <mat-form-field appearance="outline" class="w-100" color="primary">
                  <textarea matInput formControlName="description" rows="3" 
                           placeholder="D√©crivez l'objectif et le contexte de votre projet..."></textarea>
                  <mat-icon matSuffix>description</mat-icon>
                </mat-form-field>
              </div>
            </div>
          </form>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Colonne droite - Aper√ßu -->
    <div class="col-lg-4">
      <mat-card class="cardWithShadow theme-card">
        <mat-card-header>
          <mat-card-title class="m-b-0 d-flex align-items-center">
            <mat-icon class="m-r-8">visibility</mat-icon>
            Aper√ßu
          </mat-card-title>
          <mat-card-subtitle>
            {{ previewCount }} dataset{{ previewCount > 1 ? 's' : '' }} trouv√©{{ previewCount > 1 ? 's' : '' }}
          </mat-card-subtitle>
        </mat-card-header>
        <mat-card-content class="b-t-1">
          
          <!-- Loading preview -->
          <div *ngIf="isLoadingPreview" class="text-center p-20">
            <mat-spinner diameter="40"></mat-spinner>
            <p class="mat-body-2 m-t-12">Calcul des recommandations...</p>
          </div>

          <!-- Aucun r√©sultat -->
          <div *ngIf="!isLoadingPreview && previewCount === 0" class="text-center p-20">
            <mat-icon class="icon-48 text-muted">search_off</mat-icon>
            <h4 class="mat-h4 m-t-12">Aucun dataset trouv√©</h4>
            <p class="mat-body-2 text-muted">Ajustez vos crit√®res pour obtenir des recommandations</p>
          </div>

          <!-- R√©sultats -->
          <div *ngIf="!isLoadingPreview && previewDatasets.length > 0">
            <div class="d-flex align-items-center m-b-16 p-12 bg-light-primary rounded">
              <mat-icon class="text-primary m-r-8">insights</mat-icon>
              <span class="mat-subtitle-2 text-primary f-w-600">Top {{ previewDatasets.length }} recommand√©s</span>
            </div>
            
            <!-- Explication rapide des scores -->
            <div class="score-explanation m-b-16 p-12 bg-light-accent rounded">
              <div class="d-flex align-items-start">
                <mat-icon class="text-accent m-r-8 m-t-2" style="font-size: 16px;">info</mat-icon>
                <div class="flex-1">
                  <h6 class="mat-subtitle-2 f-w-600 m-b-4 text-accent">Comment sont calcul√©s les scores ?</h6>
                  <p class="mat-caption text-muted">
                    Le score combine <strong>3 crit√®res</strong> : 
                    √âthique ({{ getWeightPercent('ethical_score') }}%), 
                    Technique ({{ getWeightPercent('technical_score') }}%), 
                    Popularit√© ({{ getWeightPercent('popularity_score') }}%).
                  </p>
                  <button mat-button color="accent" class="mat-caption p-0" style="height: auto; min-height: auto; line-height: 1.2;">
                    <mat-icon style="font-size: 14px; width: 14px; height: 14px;" class="m-r-4">help_outline</mat-icon>
                    Voir formules d√©taill√©es
                  </button>
                </div>
              </div>
            </div>
            
            <div class="preview-list">
              <div *ngFor="let dataset of previewDatasets" class="d-flex align-items-start p-12 border-bottom">
                <div class="flex-1">
                  <h6 class="mat-subtitle-2 f-w-600 m-b-4">{{ dataset.dataset_name }}</h6>
                  <p class="mat-body-2 text-muted m-b-8">{{ dataset.objective || 'Objectif non sp√©cifi√©' }}</p>
                  <div class="d-flex gap-12">
                    <span class="mat-caption d-flex align-items-center">
                      <mat-icon class="icon-16 m-r-4">storage</mat-icon>
                      {{ dataset.instances_number | number }}
                    </span>
                    <span *ngIf="dataset.features_number" class="mat-caption d-flex align-items-center">
                      <mat-icon class="icon-16 m-r-4">view_column</mat-icon>
                      {{ dataset.features_number }}
                    </span>
                  </div>
                </div>
                <div class="text-center m-l-12">
                  <div class="score-badge rounded-circle d-flex align-items-center justify-content-center" 
                       [style.background-color]="getScoreColor(dataset.score)"
                       style="width: 40px; height: 40px;"
                       [matTooltip]="getScoreTooltip(dataset)">
                    <span class="mat-caption f-w-700 text-white">{{ (dataset.score * 100) | number:'1.0-0' }}%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Deuxi√®me ligne - Crit√®res de s√©lection (largeur 100%) -->
  <div class="row">
    <div class="col-lg-12">
      <!-- Crit√®res de s√©lection -->
      <mat-card class="cardWithShadow theme-card m-b-20">
      <mat-card-header>
        <mat-card-title class="m-b-0 d-flex align-items-center">
          <mat-icon class="m-r-8">filter_list</mat-icon>
          Crit√®res de S√©lection
        </mat-card-title>
        <mat-card-subtitle>D√©finissez les crit√®res pour filtrer les datasets</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content class="b-t-1">
        <form [formGroup]="projectForm">
          <div formGroupName="criteria">
            
            <!-- Section 1: Contexte et objectif -->
            <div class="criteria-section m-b-24">
              <h6 class="mat-h6 m-b-16 d-flex align-items-center text-primary">
                <mat-icon class="m-r-8">assignment</mat-icon>
                Contexte du Projet
              </h6>
              <div class="row">
                <div class="col-lg-12">
                  <mat-form-field appearance="outline" class="w-100" color="primary">
                    <mat-label>Description ou mots-cl√©s de l'objectif</mat-label>
                    <textarea matInput formControlName="objective" rows="2" 
                             placeholder="Ex: analyse pr√©dictive, classification √©tudiants, d√©tection anomalies..."></textarea>
                    <mat-icon matSuffix>description</mat-icon>
                    <mat-hint>D√©crivez le type d'analyse ou d'objectif recherch√©</mat-hint>
                  </mat-form-field>
                </div>
              </div>
            </div>

            <!-- Section 2: Domaine d'application -->
            <div class="criteria-section m-b-24">
              <h6 class="mat-h6 m-b-16 d-flex align-items-center text-primary">
                <mat-icon class="m-r-8">category</mat-icon>
                Domaine d'Application
              </h6>
              <div class="row">
                <div class="col-lg-6">
                  <mat-form-field appearance="outline" class="w-100" color="primary">
                    <mat-label>Secteurs d'activit√©</mat-label>
                    <mat-select formControlName="domain" multiple>
                      <mat-option value="education">üéì √âducation</mat-option>
                      <mat-option value="health">üè• Sant√©</mat-option>
                      <mat-option value="finance">üí∞ Finance</mat-option>
                      <mat-option value="transport">üöó Transport</mat-option>
                      <mat-option value="retail">üõí Commerce</mat-option>
                    </mat-select>
                    <mat-hint>S√©lectionnez un ou plusieurs secteurs</mat-hint>
                  </mat-form-field>
                </div>
                <div class="col-lg-6">
                  <mat-form-field appearance="outline" class="w-100" color="primary">
                    <mat-label>Type de t√¢che ML</mat-label>
                    <mat-select formControlName="task" multiple>
                      <mat-option value="classification">üéØ Classification</mat-option>
                      <mat-option value="regression">üìà R√©gression</mat-option>
                      <mat-option value="clustering">üîÑ Clustering</mat-option>
                      <mat-option value="nlp">üí¨ NLP</mat-option>
                      <mat-option value="computer_vision">üëÅÔ∏è Vision</mat-option>
                    </mat-select>
                    <mat-hint>Types d'algorithmes envisag√©s</mat-hint>
                  </mat-form-field>
                </div>
              </div>
            </div>

            <!-- Section 3: Exigences techniques (repliable) -->
            <div class="criteria-section m-b-24">
              <h6 class="mat-h6 m-b-16 d-flex align-items-center text-primary">
                <mat-icon class="m-r-8">settings</mat-icon>
                Exigences Techniques
                <span class="mat-caption text-muted m-l-8">(optionnel)</span>
              </h6>
              
              <!-- Taille du dataset -->
              <div class="row m-b-16">
                <div class="col-lg-6">
                  <mat-label class="mat-subtitle-2 m-b-8 d-block">Nombre d'instances</mat-label>
                  <div class="d-flex gap-8 align-items-center">
                    <mat-form-field appearance="outline" class="flex-1">
                      <mat-label>Min</mat-label>
                      <input matInput type="number" formControlName="instances_number_min" placeholder="1000">
                    </mat-form-field>
                    <span class="text-muted">√†</span>
                    <mat-form-field appearance="outline" class="flex-1">
                      <mat-label>Max</mat-label>
                      <input matInput type="number" formControlName="instances_number_max" placeholder="1M+">
                    </mat-form-field>
                  </div>
                </div>
                <div class="col-lg-6">
                  <mat-label class="mat-subtitle-2 m-b-8 d-block">Nombre de variables</mat-label>
                  <div class="d-flex gap-8 align-items-center">
                    <mat-form-field appearance="outline" class="flex-1">
                      <mat-label>Min</mat-label>
                      <input matInput type="number" formControlName="features_number_min" placeholder="5">
                    </mat-form-field>
                    <span class="text-muted">√†</span>
                    <mat-form-field appearance="outline" class="flex-1">
                      <mat-label>Max</mat-label>
                      <input matInput type="number" formControlName="features_number_max" placeholder="100">
                    </mat-form-field>
                  </div>
                </div>
              </div>

              <!-- P√©riode et qualit√© -->
              <div class="row">
                <div class="col-lg-4">
                  <mat-label class="mat-subtitle-2 m-b-8 d-block">P√©riode de cr√©ation</mat-label>
                  <div class="d-flex gap-8 align-items-center">
                    <mat-form-field appearance="outline" class="flex-1">
                      <input matInput type="number" formControlName="year_min" placeholder="2015">
                    </mat-form-field>
                    <span class="text-muted">-</span>
                    <mat-form-field appearance="outline" class="flex-1">
                      <input matInput type="number" formControlName="year_max" placeholder="2024">
                    </mat-form-field>
                  </div>
                </div>
                <div class="col-lg-4">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Score √©thique minimum</mat-label>
                    <mat-select formControlName="ethical_score_min">
                      <mat-option [value]="null">Aucune exigence</mat-option>
                      <mat-option [value]="0.3">30% - Acceptable</mat-option>
                      <mat-option [value]="0.5">50% - Bon</mat-option>
                      <mat-option [value]="0.7">70% - Tr√®s bon</mat-option>
                      <mat-option [value]="0.9">90% - Excellent</mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
                <div class="col-lg-4">
                  <mat-label class="mat-subtitle-2 m-b-8 d-block">Caract√©ristiques</mat-label>
                  <div class="d-flex flex-column gap-8">
                    <mat-checkbox formControlName="is_split" color="primary" class="mat-caption">
                      D√©j√† divis√© (train/test)
                    </mat-checkbox>
                    <mat-checkbox formControlName="is_anonymized" color="primary" class="mat-caption">
                      Anonymis√©
                    </mat-checkbox>
                    <mat-checkbox formControlName="is_public" color="primary" class="mat-caption">
                      Acc√®s public
                    </mat-checkbox>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </form>
      </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Troisi√®me ligne - Configuration des poids (largeur 100%) -->
  <div class="row">
    <div class="col-lg-12">
      <!-- Configuration des poids -->
      <mat-card class="cardWithShadow theme-card">
      <mat-card-header>
        <mat-card-title class="m-b-0 d-flex align-items-center">
          <mat-icon class="m-r-8">tune</mat-icon>
          Pond√©ration des Crit√®res
        </mat-card-title>
        <mat-card-subtitle>Ajustez l'importance de chaque crit√®re de scoring</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content class="b-t-1">
        <div class="d-flex justify-content-end m-b-16">
          <button mat-stroked-button (click)="resetWeights()">
            <mat-icon>refresh</mat-icon>
            Valeurs par d√©faut
          </button>
        </div>

        <div class="row">
          <div *ngFor="let weight of defaultWeights; index as i" class="col-lg-6 m-b-12">
            <div class="p-12 border rounded">
              <div class="d-flex justify-content-between align-items-center m-b-12">
                <div class="d-flex align-items-center flex-1">
                  <mat-icon [color]="weight.weight > 0 ? 'primary' : 'disabled'" class="m-r-8">{{ weight.icon }}</mat-icon>
                  <span class="mat-subtitle-2 f-w-600">{{ weight.label }}</span>
                </div>
                <div class="text-right" style="min-width: 50px;">
                  <span class="mat-h6 text-primary f-w-700">{{ (weight.weight * 100) | number:'1.0-0' }}%</span>
                </div>
              </div>
              <div style="width: 100%; padding: 0 8px;">
                <mat-slider min="0" max="1" step="0.1" style="width: 100%;" color="primary">
                  <input matSliderThumb [value]="weight.weight" (change)="onWeightChange(i, $any($event.target).value)" style="width: 100%;" />
                </mat-slider>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="currentWeights.length > 0" class="m-t-20">
          <mat-divider class="m-b-16"></mat-divider>
          <h5 class="mat-subtitle-2 f-w-600 m-b-12">Crit√®res actifs :</h5>
          <mat-chip-set>
            <mat-chip *ngFor="let weight of currentWeights" color="primary" selected>
              {{ weight.criterion_name }} ({{ (weight.weight * 100) | number:'1.0-0' }}%)
            </mat-chip>
          </mat-chip-set>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>

<!-- Quatri√®me ligne - Heat Map des recommandations (largeur 100%) -->
<div class="row" *ngIf="previewDatasets.length > 0">
  <div class="col-lg-12">
    <app-recommendation-heatmap 
      [datasets]="previewDatasets" 
      [weights]="currentWeights">
    </app-recommendation-heatmap>
  </div>
</div>

<!-- √âtats de chargement et d'erreur -->
<div *ngIf="isLoading" class="text-center p-40">
  <mat-spinner diameter="60"></mat-spinner>
  <p class="mat-body-1 m-t-16">Chargement du projet...</p>
</div>

<div *ngIf="error" class="text-center p-40">
  <mat-icon class="icon-48 text-warn">error</mat-icon>
  <p class="mat-body-1 m-t-12">{{ error }}</p>
</div> 