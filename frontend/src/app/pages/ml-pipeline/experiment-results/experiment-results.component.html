<div class="experiment-results-dashboard" *ngIf="results; else loadingTemplate" [@fadeIn]>

  <!-- Clean Navigation Header -->
  <header class="page-header">
    <div class="header-content">
      <button class="back-button" (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
        <span>Retour au Wizard</span>
      </button>
      
      <div class="header-title">
        <h1>Résultats d'Expérimentation</h1>
        <p>Analyse détaillée de votre modèle d'apprentissage automatique</p>
      </div>
      
      <div class="header-actions">
        <button mat-stroked-button (click)="runNewExperiment()">
          <mat-icon>refresh</mat-icon>
          <span>Nouvelle Expérience</span>
        </button>
        <button mat-raised-button color="primary" (click)="downloadModel()" [disabled]="!results.model_uri">
          <mat-icon>download</mat-icon>
          <span>Télécharger le Modèle</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Experiment Summary Card -->
  <section class="experiment-summary" [@slideUp]>
    <mat-card class="summary-card">
      <div class="summary-content">
        <div class="experiment-badge">
          <mat-icon>{{getAlgorithmIcon()}}</mat-icon>
          <span class="algorithm-name">{{getAlgorithmDisplay()}}</span>
          <div class="status-indicator" [ngClass]="getStatusClass()">
            <mat-icon>{{getStatusIcon()}}</mat-icon>
          </div>
        </div>
        
        <div class="quick-stats">
          <div class="stat-item">
            <div class="stat-value">{{getOverallScore()}}%</div>
            <div class="stat-label">Performance Globale</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">{{getMetricsArray().length}}</div>
            <div class="stat-label">Métriques Calculées</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">{{getRelativeTime()}}</div>
            <div class="stat-label">Terminé</div>
          </div>
        </div>
      </div>
    </mat-card>
  </section>

  <!-- Performance Dashboard - Cards Modernes -->
  <section class="performance-dashboard" [@slideUp]>
    <div class="section-header">
      <div class="header-content">
        <div class="header-text">
          <h2>Métriques de Performance</h2>
          <p>Analyse des métriques de votre modèle {{getAlgorithmDisplay()}}</p>
        </div>
        <button mat-icon-button (click)="toggleMetricsExplanation()" 
                [class.active]="showMetricsExplanation" 
                class="help-button"
                matTooltip="Guide d'interprétation">
          <mat-icon>help_outline</mat-icon>
        </button>
      </div>
    </div>

    <!-- Guide pour novices -->
    <mat-card class="novice-guide" *ngIf="showMetricsExplanation" [@slideUp]>
      <mat-card-header>
        <mat-card-title>
          <mat-icon>school</mat-icon>
          Guide pour Comprendre les Métriques
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="guide-grid">
          <div class="guide-item" *ngFor="let metric of getMetricsExplanations()">
            <div class="guide-icon">
              <mat-icon>{{metric.icon}}</mat-icon>
            </div>
            <div class="guide-content">
              <h4>{{metric.name}}</h4>
              <p>{{metric.description}}</p>
              <div class="scale-indicators">
                <span class="scale-item poor">{{metric.scale.poor}} Faible</span>
                <span class="scale-item good">{{metric.scale.good}} Bon</span>
                <span class="scale-item excellent">{{metric.scale.excellent}} Excellent</span>
              </div>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Metrics Cards Grid - Style Linear/Stripe -->
    <div class="metrics-grid">
      <div class="metric-card" *ngFor="let metric of getMetricsArray()" [@slideUp]>
        <div class="metric-header">
          <div class="metric-icon">
            <mat-icon>{{getMetricIcon(metric.key)}}</mat-icon>
          </div>
          <div class="metric-trend" [ngClass]="getMetricTrendClass(metric.value)">
            <mat-icon>{{getMetricTrendIcon(metric.value)}}</mat-icon>
          </div>
        </div>
        
        <div class="metric-content">
          <div class="metric-value" [ngClass]="getMetricColor(metric.value)">
            {{formatMetricValue(metric.key, metric.value)}}
          </div>
          <div class="metric-label">{{getMetricLabel(metric.key)}}</div>
          <div class="metric-description">{{getMetricShortDescription(metric.key)}}</div>
        </div>
        
        <div class="metric-footer">
          <div class="performance-badge" [ngClass]="getMetricColor(metric.value)">
            {{getPerformanceLabel(metric.value)}}
          </div>
          <div class="metric-benchmark">
            vs benchmark: {{getBenchmarkComparison(metric.key, metric.value)}}
          </div>
        </div>
      </div>
    </div>

    <!-- Performance Summary Card -->
    <div class="performance-summary" [@slideUp]>
      <mat-card class="summary-card">
        <mat-card-content>
          <div class="summary-header">
            <div class="summary-icon" [ngClass]="getOverallPerformanceClass()">
              <mat-icon>{{getOverallPerformanceIcon()}}</mat-icon>
            </div>
            <div class="summary-content">
              <h3>Performance Globale</h3>
              <div class="overall-score" [ngClass]="getOverallPerformanceClass()">
                {{getOverallScore()}}%
              </div>
              <div class="overall-description">
                {{getOverallPerformanceDescription()}}
              </div>
            </div>
          </div>
          
          <div class="summary-insights">
            <div class="insight-item" *ngFor="let insight of getKeyInsights()">
              <mat-icon class="insight-icon" [ngClass]="insight.type">{{insight.icon}}</mat-icon>
              <span class="insight-text">{{insight.message}}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions" [@slideUp]>
      <button mat-flat-button color="primary" class="action-button primary">
        <mat-icon>download</mat-icon>
        Télécharger le Modèle
      </button>
      <button mat-stroked-button class="action-button secondary">
        <mat-icon>refresh</mat-icon>
        Nouvelle Expérience  
      </button>
      <button mat-stroked-button class="action-button secondary" *ngIf="showMetricsExplanation">
        <mat-icon>analytics</mat-icon>
        Analyse Détaillée
      </button>
    </div>
  </section>


  <!-- AI Insights avec style Jupyter -->
  <section class="insights-section" [@slideUp]>
    <div class="section-header">
      <h2>Analyse Intelligente</h2>
      <p>Insights générés automatiquement sur la performance de votre modèle</p>
      <button mat-icon-button (click)="toggleInsightsPanel()" 
              [class.active]="showInsightsPanel">
        <mat-icon>{{showInsightsPanel ? 'expand_less' : 'expand_more'}}</mat-icon>
      </button>
    </div>

    <div class="insights-container" *ngIf="showInsightsPanel">
      <!-- Jupyter Notebook Style Analysis -->
      <mat-card class="jupyter-notebook">
        <mat-card-header>
          <div class="notebook-header">
            <div class="notebook-controls">
              <span class="dot red"></span>
              <span class="dot yellow"></span>
              <span class="dot green"></span>
            </div>
            <span class="notebook-title">model_analysis.ipynb</span>
          </div>
        </mat-card-header>
        
        <mat-card-content>
          <!-- Cellule 1: Analyse générale -->
          <div class="jupyter-cell">
            <div class="cell-input">
              <span class="cell-prompt">In [1]:</span>
              <div class="cell-code">
                <span class="comment"># Analyse des métriques de performance</span><br>
                <span class="variable">model_performance</span> = <span class="function">evaluate_model</span>()<br>
                <span class="variable">model_performance</span>.<span class="method">describe</span>()
              </div>
            </div>
            <div class="cell-output">
              <div class="performance-table">
                <div class="table-row header">
                  <span>Métrique</span>
                  <span>Valeur</span>
                  <span>Évaluation</span>
                  <span>Recommandation</span>
                </div>
                <div class="table-row" *ngFor="let metric of getMetricsArray()">
                  <span class="metric-name">{{getMetricLabel(metric.key)}}</span>
                  <span class="metric-value" [ngClass]="getMetricColor(metric.value)">
                    {{formatMetricValue(metric.key, metric.value)}}
                  </span>
                  <span class="metric-eval" [ngClass]="getMetricColor(metric.value)">
                    {{getPerformanceLabel(metric.value)}}
                  </span>
                  <span class="metric-advice">{{getAdvancedInterpretation(metric.key, metric.value)}}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Cellule 2: Points forts -->
          <div class="jupyter-cell">
            <div class="cell-input">
              <span class="cell-prompt">In [2]:</span>
              <div class="cell-code">
                <span class="comment"># Identifier les points forts du modèle</span><br>
                <span class="variable">strengths</span> = <span class="function">analyze_strengths</span>(<span class="variable">model_performance</span>)<br>
                <span class="keyword">for</span> <span class="variable">strength</span> <span class="keyword">in</span> <span class="variable">strengths</span>:<br>
                &nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">print</span>(<span class="string">"✅ Points forts détectés"</span>)
              </div>
            </div>
            <div class="cell-output">
              <div class="strength-list">
                <div class="insight-item positive" *ngFor="let strength of getModelStrengths()">
                  <mat-icon>check_circle</mat-icon>
                  <span>{{strength}}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Cellule 3: Améliorations -->
          <div class="jupyter-cell">
            <div class="cell-input">
              <span class="cell-prompt">In [3]:</span>
              <div class="cell-code">
                <span class="comment"># Suggestions d'amélioration</span><br>
                <span class="variable">recommendations</span> = <span class="function">get_improvement_suggestions</span>()<br>
                <span class="variable">recommendations</span>.<span class="method">display</span>()
              </div>
            </div>
            <div class="cell-output">
              <div class="recommendations-grid">
                <div class="recommendation-card" *ngFor="let rec of getRecommendations()">
                  <div class="rec-header">
                    <mat-icon class="rec-icon" [ngClass]="rec.type">{{rec.icon}}</mat-icon>
                    <h4>{{rec.title}}</h4>
                  </div>
                  <p>{{rec.description}}</p>
                </div>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </section>

  <!-- Visualisations Interactives -->
  <section class="visualizations-section" [@slideUp]>
    <div class="section-header">
      <h2>Visualisations du Modèle</h2>
      <p>Explorez le comportement de votre modèle avec des graphiques interactifs</p>
    </div>

    <div class="visualizations-grid">
      <!-- Arbre de Décision/Forêt Aléatoire -->
      <mat-card class="visualization-card primary" *ngIf="getAlgorithm() === 'decision_tree' || getAlgorithm() === 'random_forest'">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>{{getAlgorithmIcon()}}</mat-icon>
            Structure du {{getAlgorithmStructureLabel()}}
          </mat-card-title>
          <mat-card-subtitle>Visualisation de la logique de prédiction</mat-card-subtitle>
          <div class="card-actions">
            <button mat-icon-button matTooltip="Plein écran">
              <mat-icon>fullscreen</mat-icon>
            </button>
            <button mat-icon-button matTooltip="Télécharger">
              <mat-icon>download</mat-icon>
            </button>
          </div>
        </mat-card-header>
        <mat-card-content>
          <app-echarts-container
            [visualizationType]="VisualizationType.DECISION_TREE"
            [data]="getTreeStructureData(getAlgorithm())"
            [algorithm]="getAlgorithm()"
            [taskType]="getTaskType()"
            [experimentId]="experimentId">
          </app-echarts-container>
        </mat-card-content>
        <mat-card-footer>
          <div class="chart-insight">
            <mat-icon>lightbulb</mat-icon>
            <span>Ce graphique montre comment votre modèle prend ses décisions étape par étape</span>
          </div>
        </mat-card-footer>
      </mat-card>

      <!-- Importance des Variables -->
      <mat-card class="visualization-card" *ngIf="hasFeatureImportance()">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>tune</mat-icon>
            Importance des Variables
          </mat-card-title>
          <mat-card-subtitle>Quelles variables influencent le plus les prédictions</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <app-echarts-container
            [visualizationType]="VisualizationType.FEATURE_IMPORTANCE"
            [data]="results.feature_importance"
            [algorithm]="getAlgorithm()"
            [taskType]="getTaskType()"
            [experimentId]="experimentId">
          </app-echarts-container>
        </mat-card-content>
        <mat-card-footer>
          <div class="chart-insight">
            <mat-icon>psychology</mat-icon>
            <span>Les variables en haut ont plus d'impact sur les prédictions</span>
          </div>
        </mat-card-footer>
      </mat-card>

      <!-- Distribution des Prédictions -->
      <mat-card class="visualization-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>bar_chart</mat-icon>
            Distribution des Prédictions
          </mat-card-title>
          <mat-card-subtitle>Comment se répartissent les résultats de votre modèle</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <app-echarts-container
            [visualizationType]="VisualizationType.PREDICTIONS_DISTRIBUTION"
            [data]="getPredictionsDistributionData()"
            [algorithm]="getAlgorithm()"
            [taskType]="getTaskType()"
            [experimentId]="experimentId">
          </app-echarts-container>
        </mat-card-content>
      </mat-card>

      <!-- Graphique de Régression -->
      <mat-card class="visualization-card" *ngIf="getTaskType() === 'regression'">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>linear_scale</mat-icon>
            Prédictions vs Réalité
          </mat-card-title>
          <mat-card-subtitle>Comparaison entre prédictions et valeurs réelles</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <app-echarts-container
            [visualizationType]="VisualizationType.REGRESSION_PLOT"
            [data]="getRegressionPlotData()"
            [algorithm]="getAlgorithm()"
            [taskType]="getTaskType()"
            [experimentId]="experimentId">
          </app-echarts-container>
        </mat-card-content>
        <mat-card-footer>
          <div class="chart-insight">
            <mat-icon>trending_up</mat-icon>
            <span>Plus les points sont proches de la ligne, meilleures sont les prédictions</span>
          </div>
        </mat-card-footer>
      </mat-card>
    </div>
  </section>

  <!-- Actions d'Export -->
  <section class="export-section" [@slideUp]>
    <mat-card class="export-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>share</mat-icon>
          Partager et Exporter
        </mat-card-title>
        <mat-card-subtitle>Sauvegardez ou partagez vos résultats</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="export-buttons">
          <button mat-stroked-button class="export-btn">
            <mat-icon>picture_as_pdf</mat-icon>
            <span>Rapport PDF</span>
          </button>
          <button mat-stroked-button class="export-btn">
            <mat-icon>table_chart</mat-icon>
            <span>Données CSV</span>
          </button>
          <button mat-stroked-button class="export-btn">
            <mat-icon>code</mat-icon>
            <span>Notebook Python</span>
          </button>
          <button mat-raised-button color="primary" class="export-btn primary">
            <mat-icon>link</mat-icon>
            <span>Partager</span>
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </section>

</div>

<!-- Loading Template -->
<ng-template #loadingTemplate>
  <div class="modern-loading-container">
    <div class="loading-content">
      <div class="loading-animation">
        <div class="loading-spinner"></div>
        <div class="loading-pulse"></div>
      </div>
      <h2 class="loading-title">{{'EXPERIMENT_RESULTS.LOADING_RESULTS' | translate}}</h2>
      <p class="loading-subtitle">
        {{'EXPERIMENT_RESULTS.LOADING_EXPERIMENT' | translate}} 
        <strong>{{experimentId.substring(0, 8)}}...</strong>
      </p>
      <div class="loading-progress">
        <mat-progress-bar mode="indeterminate" class="modern-progress"></mat-progress-bar>
      </div>
    </div>
  </div>
</ng-template>