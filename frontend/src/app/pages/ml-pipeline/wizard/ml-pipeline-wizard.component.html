<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <mat-card>
        <mat-card-header>
          <mat-card-title>
            <h2>{{ 'ML_PIPELINE.TITLE' | translate }}</h2>
          </mat-card-title>
        </mat-card-header>
        
        <mat-card-content>
          <mat-stepper #stepper linear>
            <!-- Step 1: Dataset Overview -->
            <mat-step [stepControl]="datasetForm">
              <form [formGroup]="datasetForm">
                <ng-template matStepLabel>{{ 'ML_PIPELINE.STEPS.DATASET_OVERVIEW' | translate }}</ng-template>
                
                <div class="step-content">
                  <h3>{{ 'ML_PIPELINE.DATASET.TITLE' | translate }}</h3>
                  
                  <div *ngIf="dataset" class="dataset-info">
                    <mat-card class="dataset-card">
                      <mat-card-header>
                        <mat-card-title>{{ dataset.dataset_name }}</mat-card-title>
                        <mat-card-subtitle>{{ dataset.domain?.join(', ') }} - {{ dataset.task?.join(', ') }}</mat-card-subtitle>
                      </mat-card-header>
                      
                      <mat-card-content>
                        <p>{{ dataset.objective || 'Aucune description disponible' }}</p>
                        
                        <div class="dataset-stats">
                          <mat-chip-set>
                            <mat-chip *ngIf="dataset.instances_number">
                              <mat-icon>table_rows</mat-icon>
                              {{ dataset.instances_number | number }} {{ 'ML_PIPELINE.DATASET.ROWS' | translate }}
                            </mat-chip>
                            <mat-chip *ngIf="dataset.features_number">
                              <mat-icon>view_column</mat-icon>
                              {{ dataset.features_number }} {{ 'ML_PIPELINE.DATASET.FEATURES' | translate }}
                            </mat-chip>
                            <mat-chip *ngIf="dataset.year">
                              <mat-icon>calendar_today</mat-icon>
                              {{ dataset.year }}
                            </mat-chip>
                          </mat-chip-set>
                        </div>
                      </mat-card-content>
                    </mat-card>
                  </div>
                  
                  <mat-checkbox formControlName="confirmed" class="mt-3">
                    {{ 'ML_PIPELINE.DATASET.CONFIRM' | translate }}
                  </mat-checkbox>
                </div>
                
                <div class="step-actions">
                  <button mat-button (click)="goBack()">{{ 'COMMON.CANCEL' | translate }}</button>
                  <button mat-button matStepperNext [disabled]="!datasetForm.valid" color="primary">
                    {{ 'COMMON.NEXT' | translate }}
                  </button>
                </div>
              </form>
            </mat-step>
            
            <!-- Step 2: Data Quality Analysis -->
            <mat-step [stepControl]="dataQualityForm">
              <form [formGroup]="dataQualityForm">
                <ng-template matStepLabel>{{ 'ML_PIPELINE.STEPS.DATA_QUALITY' | translate }}</ng-template>
                
                <div class="step-content">
                  <h3>{{ 'ML_PIPELINE.DATA_QUALITY.TITLE' | translate }}</h3>
                  
                  <div class="row">
                    <div class="col-md-6">
                      <mat-form-field appearance="outline" class="w-100">
                        <mat-label>{{ 'ML_PIPELINE.DATA_QUALITY.TARGET_COLUMN' | translate }}</mat-label>
                        <mat-select formControlName="targetColumn">
                          <mat-option *ngFor="let col of getDatasetColumns()" [value]="col.column_name">
                            {{ col.column_name }} ({{ col.data_type_interpreted || col.data_type_original }})
                          </mat-option>
                        </mat-select>
                      </mat-form-field>
                    </div>
                    
                    <div class="col-md-6">
                      <mat-form-field appearance="outline" class="w-100">
                        <mat-label>{{ 'ML_PIPELINE.DATA_QUALITY.TASK_TYPE' | translate }}</mat-label>
                        <mat-select formControlName="taskType">
                          <mat-option value="classification">{{ 'ML_PIPELINE.DATA_QUALITY.CLASSIFICATION' | translate }}</mat-option>
                          <mat-option value="regression">{{ 'ML_PIPELINE.DATA_QUALITY.REGRESSION' | translate }}</mat-option>
                        </mat-select>
                      </mat-form-field>
                    </div>
                  </div>
                  
                  <div class="row">
                    <div class="col-md-6">
                      <mat-form-field appearance="outline" class="w-100">
                        <mat-label>{{ 'ML_PIPELINE.DATA_QUALITY.MISSING_VALUES' | translate }}</mat-label>
                        <mat-select formControlName="missingValueStrategy">
                          <mat-option value="drop">{{ 'ML_PIPELINE.DATA_QUALITY.DROP' | translate }}</mat-option>
                          <mat-option value="mean">{{ 'ML_PIPELINE.DATA_QUALITY.MEAN' | translate }}</mat-option>
                          <mat-option value="median">{{ 'ML_PIPELINE.DATA_QUALITY.MEDIAN' | translate }}</mat-option>
                          <mat-option value="forward_fill">{{ 'ML_PIPELINE.DATA_QUALITY.FORWARD_FILL' | translate }}</mat-option>
                        </mat-select>
                      </mat-form-field>
                    </div>
                    
                    <div class="col-md-6">
                      <mat-form-field appearance="outline" class="w-100">
                        <mat-label>{{ 'ML_PIPELINE.DATA_QUALITY.TEST_SIZE' | translate }}</mat-label>
                        <input matInput type="number" formControlName="testSize" min="0.1" max="0.5" step="0.05">
                        <mat-hint>{{ 'ML_PIPELINE.DATA_QUALITY.TEST_SIZE_HINT' | translate }}</mat-hint>
                      </mat-form-field>
                    </div>
                  </div>
                  
                  <div class="preprocessing-options">
                    <mat-checkbox formControlName="featureScaling">
                      {{ 'ML_PIPELINE.DATA_QUALITY.FEATURE_SCALING' | translate }}
                    </mat-checkbox>
                    
                    <mat-radio-group formControlName="categoricalEncoding" class="encoding-options">
                      <mat-label>{{ 'ML_PIPELINE.DATA_QUALITY.ENCODING' | translate }}:</mat-label>
                      <mat-radio-button value="onehot">One-Hot Encoding</mat-radio-button>
                      <mat-radio-button value="label">Label Encoding</mat-radio-button>
                    </mat-radio-group>
                  </div>
                </div>
                
                <div class="step-actions">
                  <button mat-button matStepperPrevious>{{ 'COMMON.BACK' | translate }}</button>
                  <button mat-button matStepperNext [disabled]="!dataQualityForm.valid" color="primary">
                    {{ 'COMMON.NEXT' | translate }}
                  </button>
                </div>
              </form>
            </mat-step>
            
            <!-- Step 3: Algorithm Selection -->
            <mat-step [stepControl]="algorithmForm">
              <form [formGroup]="algorithmForm">
                <ng-template matStepLabel>{{ 'ML_PIPELINE.STEPS.ALGORITHM' | translate }}</ng-template>
                
                <div class="step-content">
                  <h3>{{ 'ML_PIPELINE.ALGORITHM.TITLE' | translate }}</h3>
                  
                  <div class="algorithm-cards">
                    <mat-card *ngFor="let algo of algorithms" 
                              class="algorithm-card" 
                              [class.selected]="algorithmForm.get('algorithm')?.value === algo.name"
                              (click)="algorithmForm.patchValue({algorithm: algo.name}); onAlgorithmSelected()">
                      <mat-card-header>
                        <mat-card-title>{{ algo.display_name }}</mat-card-title>
                      </mat-card-header>
                      <mat-card-content>
                        <p>{{ algo.description }}</p>
                        <mat-chip-set>
                          <mat-chip *ngIf="algo.supports_classification" color="primary">
                            {{ 'ML_PIPELINE.ALGORITHM.CLASSIFICATION' | translate }}
                          </mat-chip>
                          <mat-chip *ngIf="algo.supports_regression" color="accent">
                            {{ 'ML_PIPELINE.ALGORITHM.REGRESSION' | translate }}
                          </mat-chip>
                        </mat-chip-set>
                      </mat-card-content>
                    </mat-card>
                  </div>
                </div>
                
                <div class="step-actions">
                  <button mat-button matStepperPrevious>{{ 'COMMON.BACK' | translate }}</button>
                  <button mat-button matStepperNext [disabled]="!algorithmForm.valid" color="primary">
                    {{ 'COMMON.NEXT' | translate }}
                  </button>
                </div>
              </form>
            </mat-step>
            
            <!-- Step 4: Hyperparameter Configuration -->
            <mat-step [stepControl]="hyperparametersForm">
              <form [formGroup]="hyperparametersForm">
                <ng-template matStepLabel>{{ 'ML_PIPELINE.STEPS.HYPERPARAMETERS' | translate }}</ng-template>
                
                <div class="step-content">
                  <h3>{{ 'ML_PIPELINE.HYPERPARAMETERS.TITLE' | translate }}</h3>
                  
                  <div class="hyperparameters" *ngIf="selectedAlgorithm">
                    <div *ngFor="let param of objectKeys(selectedAlgorithm.hyperparameters)" class="parameter-control">
                      <ng-container [ngSwitch]="selectedAlgorithm.hyperparameters[param].type">
                        <!-- Number input -->
                        <mat-form-field *ngSwitchCase="'number'" appearance="outline" class="w-100">
                          <mat-label>{{ param }}</mat-label>
                          <input matInput type="number" [formControlName]="param"
                                 [min]="selectedAlgorithm.hyperparameters[param].min ?? null"
                                 [max]="selectedAlgorithm.hyperparameters[param].max ?? null">
                          <mat-hint>{{ selectedAlgorithm.hyperparameters[param].description }}</mat-hint>
                        </mat-form-field>
                        
                        <!-- Select input -->
                        <mat-form-field *ngSwitchCase="'select'" appearance="outline" class="w-100">
                          <mat-label>{{ param }}</mat-label>
                          <mat-select [formControlName]="param">
                            <mat-option *ngFor="let option of selectedAlgorithm.hyperparameters[param].options" 
                                        [value]="option">
                              {{ option }}
                            </mat-option>
                          </mat-select>
                          <mat-hint>{{ selectedAlgorithm.hyperparameters[param].description }}</mat-hint>
                        </mat-form-field>
                        
                        <!-- Boolean input -->
                        <div *ngSwitchCase="'boolean'" class="boolean-param">
                          <mat-checkbox [formControlName]="param">
                            {{ param }}
                          </mat-checkbox>
                          <p class="param-description">{{ selectedAlgorithm.hyperparameters[param].description }}</p>
                        </div>
                      </ng-container>
                    </div>
                  </div>
                </div>
                
                <div class="step-actions">
                  <button mat-button matStepperPrevious>{{ 'COMMON.BACK' | translate }}</button>
                  <button mat-button matStepperNext [disabled]="!hyperparametersForm.valid" color="primary">
                    {{ 'COMMON.NEXT' | translate }}
                  </button>
                </div>
              </form>
            </mat-step>
            
            <!-- Step 5: Training Summary & Launch -->
            <mat-step [stepControl]="summaryForm">
              <form [formGroup]="summaryForm">
                <ng-template matStepLabel>{{ 'ML_PIPELINE.STEPS.SUMMARY' | translate }}</ng-template>
                
                <div class="step-content">
                  <h3>{{ 'ML_PIPELINE.SUMMARY.TITLE' | translate }}</h3>
                  
                  <div class="summary-section" *ngIf="!isTraining && !experimentResults">
                    <mat-card>
                      <mat-card-content>
                        <h4>{{ 'ML_PIPELINE.SUMMARY.CONFIGURATION' | translate }}</h4>
                        <div class="summary-item">
                          <strong>{{ 'ML_PIPELINE.SUMMARY.DATASET' | translate }}:</strong> {{ dataset?.dataset_name }}
                        </div>
                        <div class="summary-item">
                          <strong>{{ 'ML_PIPELINE.SUMMARY.ALGORITHM' | translate }}:</strong> {{ selectedAlgorithm?.display_name }}
                        </div>
                        <div class="summary-item">
                          <strong>{{ 'ML_PIPELINE.SUMMARY.TARGET' | translate }}:</strong> {{ dataQualityForm.get('targetColumn')?.value }}
                        </div>
                        <div class="summary-item">
                          <strong>{{ 'ML_PIPELINE.SUMMARY.TASK_TYPE' | translate }}:</strong> {{ dataQualityForm.get('taskType')?.value }}
                        </div>
                      </mat-card-content>
                    </mat-card>
                    
                    <mat-checkbox formControlName="confirmed" class="mt-3">
                      {{ 'ML_PIPELINE.SUMMARY.CONFIRM' | translate }}
                    </mat-checkbox>
                  </div>
                  
                  <!-- Training Progress -->
                  <div class="training-section" *ngIf="isTraining">
                    <div class="text-center">
                      <mat-spinner diameter="60"></mat-spinner>
                      <h4 class="mt-3">{{ 'ML_PIPELINE.TRAINING.IN_PROGRESS' | translate }}</h4>
                      <mat-progress-bar mode="determinate" [value]="trainingProgress" class="mt-3"></mat-progress-bar>
                      <p class="mt-2">{{ trainingProgress }}% {{ 'ML_PIPELINE.TRAINING.COMPLETE' | translate }}</p>
                      <p *ngIf="experimentStatus?.status">
                        {{ 'ML_PIPELINE.TRAINING.STATUS' | translate }}: {{ experimentStatus.status }}
                      </p>
                    </div>
                  </div>
                  
                  <!-- Results -->
                  <div class="results-section" *ngIf="experimentResults">
                    <h4>{{ 'ML_PIPELINE.RESULTS.TITLE' | translate }}</h4>
                    
                    <mat-card class="metrics-card">
                      <mat-card-header>
                        <mat-card-title>{{ 'ML_PIPELINE.RESULTS.METRICS' | translate }}</mat-card-title>
                      </mat-card-header>
                      <mat-card-content>
                        <div class="metrics-grid">
                          <div *ngFor="let metric of objectKeys(experimentResults.metrics)" class="metric-item">
                            <strong>{{ metric }}:</strong>
                            <span>{{ experimentResults.metrics[metric] | number:'1.2-4' }}</span>
                          </div>
                        </div>
                      </mat-card-content>
                    </mat-card>
                    
                    <!-- Visualizations will be rendered here -->
                    <div class="visualizations mt-4">
                      <canvas id="confusion-matrix"></canvas>
                      <canvas id="feature-importance"></canvas>
                    </div>
                  </div>
                </div>
                
                <div class="step-actions">
                  <button mat-button matStepperPrevious *ngIf="!isTraining && !experimentResults">
                    {{ 'COMMON.BACK' | translate }}
                  </button>
                  <button mat-raised-button color="primary" 
                          *ngIf="!isTraining && !experimentResults"
                          [disabled]="!isFormValid()" 
                          (click)="startTraining()">
                    <mat-icon>play_arrow</mat-icon>
                    {{ 'ML_PIPELINE.TRAINING.START' | translate }}
                  </button>
                  <button mat-raised-button color="primary" 
                          *ngIf="experimentResults"
                          (click)="goBack()">
                    {{ 'ML_PIPELINE.RESULTS.BACK_TO_PROJECT' | translate }}
                  </button>
                </div>
              </form>
            </mat-step>
          </mat-stepper>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div> 