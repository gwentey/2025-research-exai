<div class="dataset-listing-container">
  <!-- Header compact avec recherche et actions intégrées -->
  <div class="page-header">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-16">
      <!-- Titre et stats compacts -->
      <div class="title-section">
        <h1 class="f-w-600 m-0 f-s-24">Datasets</h1>
        <span class="text-muted f-s-14" *ngIf="!isLoading">
          {{ totalCount }} résultat{{ totalCount > 1 ? 's' : '' }}
          <span *ngIf="totalCount > 0 && hasActiveFilters()" class="text-primary"> • filtré{{ totalCount > 1 ? 's' : '' }}</span>
        </span>
      </div>

      <!-- Actions rapides -->
      <div class="d-flex align-items-center gap-8">
        <button 
          mat-icon-button 
          (click)="refreshDatasets()"
          matTooltip="Actualiser"
          [disabled]="isLoading">
          <mat-icon [class.rotating]="isLoading">refresh</mat-icon>
        </button>
        
        <mat-button-toggle-group 
          [value]="viewMode" 
          (change)="setViewMode($event.value)"
          class="view-toggle-compact">
          <mat-button-toggle value="grid" matTooltip="Grille">
            <mat-icon>grid_view</mat-icon>
          </mat-button-toggle>
          <mat-button-toggle value="list" matTooltip="Liste">
            <mat-icon>view_list</mat-icon>
          </mat-button-toggle>
        </mat-button-toggle-group>
      </div>
    </div>

    <!-- Barre de recherche moderne avec filtres intégrés -->
    <div class="search-bar-container d-flex align-items-center gap-12 m-t-16">
      <!-- Recherche principale -->
      <div class="search-input-wrapper flex-fill">
        <mat-form-field appearance="outline" class="search-field-modern">
          <mat-icon matPrefix class="text-muted">search</mat-icon>
          <input 
            matInput 
            [formControl]="searchControl"
            placeholder="Rechercher par nom, description, domaine..."
            autocomplete="off">
          <button 
            mat-icon-button 
            matSuffix 
            *ngIf="getCurrentSearchTerm()"
            (click)="clearSearch()"
            matTooltip="Effacer">
            <mat-icon>clear</mat-icon>
          </button>
        </mat-form-field>
      </div>

      <!-- Dropdown des filtres -->
      <button 
        mat-stroked-button 
        [matMenuTriggerFor]="filtersMenu"
        [class.active-filters]="hasActiveFilters()"
        class="filters-button">
        <mat-icon>tune</mat-icon>
        Filtres
        <span *ngIf="hasActiveFilters()" class="filter-count">{{ getActiveFiltersCount() }}</span>
      </button>
      
      <mat-menu #filtersMenu="matMenu" class="filters-dropdown" [hasBackdrop]="true">
        <div class="filters-content" (click)="$event.stopPropagation()">
          <div class="filters-header">
            <h4 class="m-0 f-w-600">Filtres avancés</h4>
            <button 
              mat-button 
              color="warn" 
              *ngIf="hasActiveFilters()"
              (click)="onFiltersReset()"
              class="reset-button">
              Réinitialiser
            </button>
          </div>
          
                  <app-dataset-filters
          [initialFilters]="currentFilters"
          [autoApply]="true"
          [showApplyButton]="false"
          [collapsible]="false"
          (filtersChange)="onFiltersChange($event)"
          (filtersReset)="onFiltersReset()">
        </app-dataset-filters>
        </div>
      </mat-menu>

      <!-- Tri -->
      <mat-form-field appearance="outline" class="sort-field-compact">
        <mat-select [value]="currentSort" (selectionChange)="onSortChange($event.value)" placeholder="Trier">
          <mat-option *ngFor="let option of sortOptions" [value]="option">
            {{ option.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Filtres actifs compacts -->
    <div class="active-filters-compact m-t-12" *ngIf="hasActiveFilters()">
      <mat-chip-set>
        <mat-chip 
          *ngIf="getCurrentSearchTerm()"
          [removable]="true"
          (removed)="clearSearch()">
          "{{ getCurrentSearchTerm() }}"
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>
        
        <mat-chip 
          *ngIf="hasDomainFilter()"
          [removable]="true"
          (removed)="removeDomainFilter()">
          {{ getDomainCount() }} domaine{{ getDomainCount() > 1 ? 's' : '' }}
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>
        
        <mat-chip 
          *ngIf="hasTaskFilter()"
          [removable]="true"
          (removed)="removeTaskFilter()">
          {{ getTaskCount() }} tâche{{ getTaskCount() > 1 ? 's' : '' }}
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>
      </mat-chip-set>
    </div>
  </div>

  <!-- Contenu principal -->
  <div class="main-content">
    <!-- États de chargement et d'erreur (compacts) -->
    <div class="content-states" *ngIf="isLoading || hasError || (!isLoading && !hasError && datasets.length === 0)">
      <!-- Chargement -->
      <div class="loading-state" *ngIf="isLoading">
        <mat-spinner diameter="32"></mat-spinner>
        <span class="m-l-12 text-muted">Chargement...</span>
      </div>

      <!-- Erreur -->
      <div class="error-state" *ngIf="hasError && !isLoading">
        <mat-icon class="text-error">error_outline</mat-icon>
        <div class="m-l-12">
          <div class="f-w-600">Erreur de chargement</div>
          <div class="text-muted f-s-14">{{ errorMessage }}</div>
        </div>
        <button mat-button color="primary" (click)="refreshDatasets()" class="m-l-12">
          Réessayer
        </button>
      </div>

      <!-- Aucun résultat -->
      <div class="no-results-state" *ngIf="!isLoading && !hasError && datasets.length === 0">
        <mat-icon class="text-muted">search_off</mat-icon>
        <div class="m-l-12">
          <div class="f-w-600">Aucun dataset trouvé</div>
          <div class="text-muted f-s-14">Essayez de modifier vos critères de recherche</div>
        </div>
        <button 
          mat-button 
          color="primary" 
          *ngIf="hasActiveFilters()"
          (click)="onFiltersReset()" 
          class="m-l-12">
          Effacer les filtres
        </button>
      </div>
    </div>

    <!-- Grille/Liste des datasets -->
    <div class="datasets-section" *ngIf="!isLoading && !hasError && datasets.length > 0">
      <div 
        class="datasets-container"
        [ngClass]="{
          'grid-layout': viewMode === 'grid',
          'list-layout': viewMode === 'list'
        }">
        <app-dataset-card
          *ngFor="let dataset of datasets; trackBy: trackByDatasetId"
          [dataset]="dataset"
          [compact]="viewMode === 'list'"
          [showActions]="true"
          [modern]="true"
          (onView)="onViewDataset($event)"
          (onSelect)="onSelectDataset($event)"
          (onFavorite)="onFavoriteDataset($event)">
        </app-dataset-card>
      </div>

      <!-- Pagination compacte -->
      <div class="pagination-wrapper" *ngIf="totalCount > pageSize">
        <mat-paginator
          [length]="totalCount"
          [pageSize]="pageSize"
          [pageSizeOptions]="availablePageSizes"
          [pageIndex]="currentPage"
          (page)="onPageChange($event)"
          showFirstLastButtons="true"
          class="pagination-modern">
        </mat-paginator>
      </div>
    </div>
  </div>
</div>

<!-- Fonction de tracking pour le ngFor -->
<ng-container>
  <!-- Cette fonction sera définie dans le composant TypeScript -->
</ng-container> 