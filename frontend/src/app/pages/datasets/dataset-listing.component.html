<div class="dataset-listing-container">
  <!-- Header principal simple et clair -->
  <div class="main-header">
    <div class="header-left">
      <h1>{{ 'DATASETS.TITLE' | translate }}</h1>
      <span class="results-count" *ngIf="datasets.length > 0">
        {{ 'DATASETS.LISTING.TOTAL_DATASETS' | translate: {count: datasets.length} }}
        <span *ngIf="hasActiveFilters()" class="filtered-indicator">• {{ 'DATASETS.LISTING.FILTERED' | translate }}</span>
      </span>
    </div>

    <div class="header-controls">
      <!-- Barre de recherche rapide -->
      <div class="quick-search">
        <mat-form-field appearance="outline" class="search-field">
          <input 
            matInput 
            [(ngModel)]="quickSearchTerm"
            (input)="onQuickSearch($event)"
            [placeholder]="'DATASETS.LISTING.SEARCH_PLACEHOLDER' | translate"
            autocomplete="off">
          <mat-icon matPrefix>search</mat-icon>
          <button 
            *ngIf="quickSearchTerm" 
            mat-icon-button 
            matSuffix 
            (click)="clearQuickSearch()"
            [matTooltip]="'COMMON.CLEAR' | translate">
            <mat-icon>clear</mat-icon>
          </button>
        </mat-form-field>
      </div>

      <!-- Bouton Filtres avec indicateur -->
      <button 
        mat-raised-button 
        color="primary"
        (click)="openFiltersModal()"
        class="filters-button"
        [class.has-filters]="hasActiveFilters()">
        <mat-icon>tune</mat-icon>
        {{ 'COMMON.FILTER' | translate }}
        <mat-chip *ngIf="hasActiveFilters()" class="filters-count">
          {{ getActiveFiltersCount() }}
        </mat-chip>
      </button>

      <!-- Contrôles d'affichage -->
      <div class="view-controls">
        <mat-button-toggle-group 
          [(value)]="viewMode" 
          (change)="onViewChange($event)"
          class="view-toggle">
          <mat-button-toggle value="grid" [matTooltip]="'DATASETS.LISTING.GRID_VIEW' | translate">
            <mat-icon>grid_view</mat-icon>
          </mat-button-toggle>
          <mat-button-toggle value="list" [matTooltip]="'DATASETS.LISTING.LIST_VIEW' | translate">
            <mat-icon>view_list</mat-icon>
          </mat-button-toggle>
        </mat-button-toggle-group>

        <!-- Tri -->
        <mat-form-field appearance="outline" class="sort-field">
          <mat-label>{{ 'DATASETS.LISTING.SORT_BY' | translate }}</mat-label>
          <mat-select [(value)]="currentSort" (selectionChange)="onSortChange($event)">
            <mat-option value="relevance">{{ 'DATASETS.SORT.RELEVANCE' | translate }}</mat-option>
            <mat-option value="name">{{ 'DATASETS.LISTING.SORT_NAME' | translate }}</mat-option>
            <mat-option value="year">{{ 'DATASETS.SORT.YEAR' | translate }}</mat-option>
            <mat-option value="instances">{{ 'DATASETS.SORT.INSTANCES' | translate }}</mat-option>
            <mat-option value="updated">{{ 'DATASETS.LISTING.SORT_DATE' | translate }}</mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Refresh -->
        <button 
          mat-icon-button 
          (click)="refreshDatasets()"
          [matTooltip]="'COMMON.REFRESH' | translate"
          class="refresh-btn">
          <mat-icon>refresh</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- Filtres actifs compacts (si présents) -->
  <div class="active-filters-bar" *ngIf="hasActiveFilters()">
    <div class="filters-summary">
      <mat-icon>filter_list</mat-icon>
      <span>{{ 'DATASETS.FILTERS.ACTIVE_FILTERS_COUNT' | translate: {count: getActiveFiltersCount()} }}</span>
    </div>
    <div class="filters-chips">
      <mat-chip 
        *ngFor="let filter of getActiveFiltersChips()" 
        [removable]="true"
        (removed)="removeFilter(filter)"
        class="active-filter-chip">
        <mat-icon matChipAvatar>{{ filter.icon }}</mat-icon>
        {{ filter.label }}
        <mat-icon matChipRemove>cancel</mat-icon>
      </mat-chip>
    </div>
    <button 
      mat-button 
      color="warn"
      (click)="clearAllFilters()"
      class="clear-all-btn">
      <mat-icon>clear_all</mat-icon>
      {{ 'DATASETS.FILTERS.CLEAR' | translate }}
    </button>
  </div>

  <!-- Zone principale des datasets -->
  <div class="content-area">
    <!-- Loading -->
    <div class="loading-state" *ngIf="isLoading">
      <mat-spinner diameter="40"></mat-spinner>
      <p>{{ 'DATASETS.LISTING.LOADING' | translate }}</p>
    </div>

    <!-- Erreur -->
    <div class="error-state" *ngIf="error && !isLoading">
      <mat-icon color="warn">error_outline</mat-icon>
      <h3>{{ 'DATASETS.LISTING.ERROR_TITLE' | translate }}</h3>
      <p>{{ error }}</p>
      <button mat-raised-button color="primary" (click)="refreshDatasets()">
        <mat-icon>refresh</mat-icon>
        {{ 'COMMON.RETRY' | translate }}
      </button>
    </div>

    <!-- Pas de résultats -->
    <div class="no-results-state" *ngIf="!isLoading && !error && datasets.length === 0">
      <mat-icon>search_off</mat-icon>
      <h3>{{ 'DATASETS.LISTING.NO_RESULTS' | translate }}</h3>
      <p>{{ 'DATASETS.LISTING.NO_RESULTS_MESSAGE' | translate }}</p>
      <div class="no-results-actions">
        <button mat-raised-button color="primary" (click)="clearAllFilters()" *ngIf="hasActiveFilters()">
          <mat-icon>clear_all</mat-icon>
          {{ 'DATASETS.FILTERS.CLEAR' | translate }}
        </button>
        <button mat-button (click)="openFiltersModal()">
          <mat-icon>tune</mat-icon>
          {{ 'DATASETS.FILTERS.MODIFY' | translate }}
        </button>
      </div>
    </div>

    <!-- Grille des datasets -->
    <div 
      class="datasets-grid" 
      *ngIf="!isLoading && !error && datasets.length > 0"
      [class.list-view]="viewMode === 'list'">
      <app-dataset-card
        *ngFor="let dataset of datasets; trackBy: trackByDataset"
        [dataset]="dataset"
        [compact]="viewMode === 'list'"
        [showActions]="true"
        (onSelect)="onSelectDataset($event)"
        (onView)="onViewDataset($event)"
        (onFavorite)="onToggleFavorite($event)"
        class="dataset-card-item">
      </app-dataset-card>
    </div>

    <!-- Pagination -->
    <div class="pagination-container" *ngIf="!isLoading && !error && datasets.length > 0">
      <mat-paginator
        [length]="totalDatasets"
        [pageSize]="pageSize"
        [pageSizeOptions]="[12, 24, 48, 96]"
        [pageIndex]="currentPage"
        (page)="onPageChange($event)"
        showFirstLastButtons>
      </mat-paginator>
    </div>
  </div>
</div>

<!-- Modal de Filtrage -->
<div class="filters-modal-overlay" *ngIf="showFiltersModal" (click)="closeFiltersModal()">
  <div class="filters-modal" (click)="$event.stopPropagation()">
    <!-- Header de la modal -->
    <div class="modal-header">
      <div class="modal-title">
        <mat-icon>tune</mat-icon>
        <h2>{{ 'DATASETS.FILTERS.TITLE' | translate }}</h2>
      </div>
      <button mat-icon-button (click)="closeFiltersModal()" class="close-btn">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Corps de la modal -->
    <div class="modal-body">
      <app-dataset-filters
        [initialFilters]="tempFilters"
        [autoApply]="false"
        [showApplyButton]="false"
        (filtersChange)="onFiltersPreview($event)"
        class="modal-filters">
      </app-dataset-filters>
    </div>

    <!-- Aperçu des résultats -->
    <div class="modal-preview" *ngIf="previewCount !== null">
      <mat-icon>info</mat-icon>
      <span>{{ previewCount }} dataset{{ previewCount > 1 ? 's' : '' }} trouvé{{ previewCount > 1 ? 's' : '' }}</span>
    </div>

    <!-- Footer avec actions -->
    <div class="modal-footer">
      <div class="modal-actions-left">
        <button 
          mat-button 
          color="warn"
          (click)="resetFiltersModal()"
          [disabled]="!hasActiveFilters()">
          <mat-icon>clear_all</mat-icon>
          Tout effacer
        </button>
      </div>
      
      <div class="modal-actions-right">
        <button mat-button (click)="closeFiltersModal()">
          Annuler
        </button>
        <button 
          mat-raised-button 
          color="primary"
          (click)="applyFiltersModal()"
          [disabled]="!hasFilterChanges()">
          <mat-icon>check</mat-icon>
          Appliquer
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Fonction de tracking pour le ngFor -->
<ng-container>
  <!-- Cette fonction sera définie dans le composant TypeScript -->
</ng-container> 