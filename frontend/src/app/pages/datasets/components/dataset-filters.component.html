<form [formGroup]="filterForm" class="dataset-filters">
  <!-- En-tête des filtres -->
  <div class="filters-header">
    <div class="header-left">
      <mat-icon>filter_alt</mat-icon>
      <h3>Filtres</h3>
      <mat-chip 
        *ngIf="hasActiveFilters()" 
        class="active-filters-count"
        color="primary">
        {{ getActiveFiltersCount() }}
      </mat-chip>
    </div>
    <div class="header-actions">
      <button 
        mat-icon-button 
        *ngIf="hasActiveFilters()"
        (click)="resetFilters()"
        matTooltip="Réinitialiser tous les filtres">
        <mat-icon>clear_all</mat-icon>
      </button>
      <button 
        mat-icon-button 
        *ngIf="collapsible"
        (click)="toggleExpansion()"
        matTooltip="Masquer/Afficher les filtres">
        <mat-icon>{{ isExpanded ? 'expand_less' : 'expand_more' }}</mat-icon>
      </button>
    </div>
  </div>

  <!-- Contenu des filtres -->
  <div class="filters-content" [ngClass]="{'collapsed': !isExpanded}">
    
    <!-- Section Recherche textuelle -->
    <mat-expansion-panel class="filter-section" expanded="true">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>search</mat-icon>
          Recherche textuelle
        </mat-panel-title>
        <mat-panel-description>
          Nom et description du dataset
        </mat-panel-description>
      </mat-expansion-panel-header>
      
      <div class="filter-section-content">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Nom du dataset</mat-label>
          <input 
            matInput 
            formControlName="dataset_name"
            placeholder="Ex: EdNet, MNIST, etc."
            autocomplete="off">
          <mat-icon matSuffix>label</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Description/Objectif</mat-label>
          <input 
            matInput 
            formControlName="objective"
            placeholder="Ex: prédiction, classification, etc."
            autocomplete="off">
          <mat-icon matSuffix>description</mat-icon>
        </mat-form-field>

        <div class="section-actions">
          <button 
            mat-button 
            color="warn"
            (click)="resetSection('text')"
            [disabled]="!filterForm.get('dataset_name')?.value && !filterForm.get('objective')?.value">
            <mat-icon>clear</mat-icon>
            Effacer
          </button>
        </div>
      </div>
    </mat-expansion-panel>

    <!-- Section Domaines et Tâches -->
    <mat-expansion-panel class="filter-section" expanded="false">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>category</mat-icon>
          Domaines et Tâches ML
        </mat-panel-title>
        <mat-panel-description>
          Filtrer par domaine d'application et type de tâche
        </mat-panel-description>
      </mat-expansion-panel-header>
      
      <div class="filter-section-content">
        <!-- Domaines -->
        <div class="subsection">
          <h4>Domaines d'application</h4>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Sélectionner des domaines</mat-label>
            <mat-select 
              formControlName="domain"
              multiple
              placeholder="Choisir des domaines">
              <mat-option *ngFor="let domain of availableDomains" [value]="domain">
                {{ domain }}
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>domain</mat-icon>
          </mat-form-field>

          <!-- Chips des domaines sélectionnés -->
          <div class="selected-chips" *ngIf="getSelectedDomains().length > 0">
            <mat-chip 
              *ngFor="let domain of getSelectedDomains()"
              [removable]="true"
              (removed)="removeDomain(domain)"
              [color]="getDomainColor(domain)">
              {{ domain }}
              <mat-icon matChipRemove>cancel</mat-icon>
            </mat-chip>
          </div>
        </div>

        <!-- Tâches ML -->
        <div class="subsection">
          <h4>Types de tâches ML</h4>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Sélectionner des tâches</mat-label>
            <mat-select 
              formControlName="task"
              multiple
              placeholder="Choisir des tâches">
              <mat-option *ngFor="let task of availableTasks" [value]="task">
                <mat-icon>{{ getTaskIcon(task) }}</mat-icon>
                {{ task }}
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>psychology</mat-icon>
          </mat-form-field>

          <!-- Chips des tâches sélectionnées -->
          <div class="selected-chips" *ngIf="getSelectedTasks().length > 0">
            <mat-chip 
              *ngFor="let task of getSelectedTasks()"
              [removable]="true"
              (removed)="removeTask(task)"
              color="primary">
              <mat-icon matChipAvatar>{{ getTaskIcon(task) }}</mat-icon>
              {{ task }}
              <mat-icon matChipRemove>cancel</mat-icon>
            </mat-chip>
          </div>
        </div>

        <div class="section-actions">
          <button 
            mat-button 
            color="warn"
            (click)="resetSection('category')"
            [disabled]="getSelectedDomains().length === 0 && getSelectedTasks().length === 0">
            <mat-icon>clear</mat-icon>
            Effacer
          </button>
        </div>
      </div>
    </mat-expansion-panel>

    <!-- Section Caractéristiques numériques -->
    <mat-expansion-panel class="filter-section" expanded="false">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>bar_chart</mat-icon>
          Caractéristiques numériques
        </mat-panel-title>
        <mat-panel-description>
          Taille, nombre de features, année
        </mat-panel-description>
      </mat-expansion-panel-header>
      
      <div class="filter-section-content">
        <!-- Nombre d'instances -->
        <div class="subsection">
          <h4>Nombre d'instances</h4>
          <div class="range-inputs">
            <mat-form-field appearance="outline" class="range-field">
              <mat-label>Minimum</mat-label>
              <input 
                matInput 
                type="number"
                formControlName="instances_number_min"
                [min]="instancesRange.min"
                [max]="instancesRange.max"
                [step]="instancesRange.step"
                placeholder="0">
              <mat-icon matSuffix>storage</mat-icon>
            </mat-form-field>
            <span class="range-separator">-</span>
            <mat-form-field appearance="outline" class="range-field">
              <mat-label>Maximum</mat-label>
              <input 
                matInput 
                type="number"
                formControlName="instances_number_max"
                [min]="instancesRange.min"
                [max]="instancesRange.max"
                [step]="instancesRange.step"
                placeholder="∞">
              <mat-icon matSuffix>storage</mat-icon>
            </mat-form-field>
          </div>
        </div>

        <!-- Nombre de features -->
        <div class="subsection">
          <h4>Nombre de features</h4>
          <div class="range-inputs">
            <mat-form-field appearance="outline" class="range-field">
              <mat-label>Minimum</mat-label>
              <input 
                matInput 
                type="number"
                formControlName="features_number_min"
                [min]="featuresRange.min"
                [max]="featuresRange.max"
                [step]="featuresRange.step"
                placeholder="0">
              <mat-icon matSuffix>view_column</mat-icon>
            </mat-form-field>
            <span class="range-separator">-</span>
            <mat-form-field appearance="outline" class="range-field">
              <mat-label>Maximum</mat-label>
              <input 
                matInput 
                type="number"
                formControlName="features_number_max"
                [min]="featuresRange.min"
                [max]="featuresRange.max"
                [step]="featuresRange.step"
                placeholder="∞">
              <mat-icon matSuffix>view_column</mat-icon>
            </mat-form-field>
          </div>
        </div>

        <!-- Année -->
        <div class="subsection">
          <h4>Année de publication</h4>
          <div class="range-inputs">
            <mat-form-field appearance="outline" class="range-field">
              <mat-label>Depuis</mat-label>
              <input 
                matInput 
                type="number"
                formControlName="year_min"
                [min]="yearRange.min"
                [max]="yearRange.max"
                [step]="yearRange.step"
                placeholder="1990">
              <mat-icon matSuffix>calendar_today</mat-icon>
            </mat-form-field>
            <span class="range-separator">-</span>
            <mat-form-field appearance="outline" class="range-field">
              <mat-label>Jusqu'à</mat-label>
              <input 
                matInput 
                type="number"
                formControlName="year_max"
                [min]="yearRange.min"
                [max]="yearRange.max"
                [step]="yearRange.step"
                [placeholder]="yearRange.max.toString()">
              <mat-icon matSuffix>calendar_today</mat-icon>
            </mat-form-field>
          </div>
        </div>

        <div class="section-actions">
          <button 
            mat-button 
            color="warn"
            (click)="resetSection('numeric')">
            <mat-icon>clear</mat-icon>
            Effacer
          </button>
        </div>
      </div>
    </mat-expansion-panel>

    <!-- Section Critères de qualité -->
    <mat-expansion-panel class="filter-section" expanded="false">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>verified</mat-icon>
          Critères de qualité
        </mat-panel-title>
        <mat-panel-description>
          Propriétés et critères éthiques
        </mat-panel-description>
      </mat-expansion-panel-header>
      
      <div class="filter-section-content">
        <!-- Propriétés techniques -->
        <div class="subsection">
          <h4>Propriétés techniques</h4>
          <div class="checkbox-group">
            <mat-checkbox 
              formControlName="has_missing_values"
              [indeterminate]="filterForm.get('has_missing_values')?.value === null">
              <mat-icon class="checkbox-icon">warning</mat-icon>
              Contient des valeurs manquantes
            </mat-checkbox>
            <mat-checkbox 
              formControlName="split"
              [indeterminate]="filterForm.get('split')?.value === null">
              <mat-icon class="checkbox-icon">call_split</mat-icon>
              Déjà divisé (train/test)
            </mat-checkbox>
          </div>
        </div>

        <!-- Critères éthiques -->
        <div class="subsection">
          <h4>Critères éthiques</h4>
          <div class="checkbox-group">
            <mat-checkbox 
              formControlName="anonymization_applied"
              [indeterminate]="filterForm.get('anonymization_applied')?.value === null">
              <mat-icon class="checkbox-icon">privacy_tip</mat-icon>
              Anonymisation appliquée
            </mat-checkbox>
            <mat-checkbox 
              formControlName="informed_consent"
              [indeterminate]="filterForm.get('informed_consent')?.value === null">
              <mat-icon class="checkbox-icon">how_to_reg</mat-icon>
              Consentement éclairé
            </mat-checkbox>
            <mat-checkbox 
              formControlName="transparency"
              [indeterminate]="filterForm.get('transparency')?.value === null">
              <mat-icon class="checkbox-icon">visibility</mat-icon>
              Transparence des données
            </mat-checkbox>
          </div>
        </div>

        <div class="section-actions">
          <button 
            mat-button 
            color="warn"
            (click)="resetSection('boolean')">
            <mat-icon>clear</mat-icon>
            Effacer
          </button>
        </div>
      </div>
    </mat-expansion-panel>

  </div>

  <!-- Actions principales -->
  <div class="filters-actions" *ngIf="showApplyButton && !autoApply">
    <button 
      mat-raised-button 
      color="primary"
      (click)="applyFilters()"
      [disabled]="!hasActiveFilters()">
      <mat-icon>search</mat-icon>
      Appliquer les filtres
    </button>
    <button 
      mat-button 
      color="warn"
      (click)="resetFilters()"
      [disabled]="!hasActiveFilters()">
      <mat-icon>clear_all</mat-icon>
      Réinitialiser
    </button>
  </div>
</form> 