# EXAI : Stack Technologique D√©taill√©e (PoC & Production Azure v2)

**Version :** 0.2
**Date :** 26 avril 2025
**Objectif :** D√©finir pr√©cis√©ment la stack technologique pour le projet EXAI (PoC et vision Production), en fournissant des d√©tails exploitables pour le d√©veloppement assist√© par IA. Ce document vise un √©quilibre entre une mise en ≈ìuvre fonctionnelle et maintenable pour la PoC (Minikube) et la robustesse/scalabilit√© pour la production (Azure AKS).

## Principes Directeurs (Rappel)

1.  **Architecture Microservices Stricte :** S√©paration claire des responsabilit√©s (`gateway`, `service-selection`, `ml-pipeline`, `xai-engine`).
2.  **Fonctionnalit√© Compl√®te PoC :** Validation du flux complet sur Minikube.
3.  **Maintenabilit√© & Conventions :** Code propre, typage, modularit√©, migrations BDD contr√¥l√©es (Alembic), gestion de configuration (Kustomize).
4.  **Pragmatisme Local :** Outils g√©rables localement (Helm pour BDD/Redis).
5.  **Robustesse & Scalabilit√© Prod :** Services manag√©s Azure (AKS, BDD, Cache, Monitor, Blob Storage).
6.  **Coh√©rence Backend :** FastAPI pour tous les services Python.
7.  **Rigueur PoC :** La PoC doit √©tablir des fondations solides, maintenables et extensibles, pas un prototype jetable.

## Stack Technologique D√©taill√©e

| Composant                        | Technologie Sp√©cifique (Local/Prod)         | D√©tails Techniques, Justifications & Statut (PoC)                                                                                                                                                                                                                                                                                                                                                     | Alternatives √âcart√©es / Notes Cl√©s                                                                                                                                                                                                                                                           |
| :------------------------------- | :------------------------------------------ | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Frontend (`frontend/`)** | Angular + **Angular Material** | **Choix Final : Angular Material**. Interface web riche. Angular Material sera utilis√© pour l'ensemble des composants UI (tables, formulaires, dialogues, etc.) pour acc√©l√©rer le d√©veloppement et assurer la coh√©rence. Tailwind CSS peut √™tre utilis√© *en compl√©ment* pour layout/ajustements fins si n√©cessaire. D√©ploiement via conteneur Nginx. *Statut: ‚¨ú √Ä d√©marrer.* | Tailwind CSS seul (jug√© trop lent pour composants complexes). Autres librairies UI (PrimeNG, etc.) - Angular Material privil√©gi√© pour int√©gration officielle.                                                                                                                                   |
| **API Gateway (`gateway/`)** | FastAPI + **fastapi-users** (JWT Backend) | **Maintenu**. Point d'entr√©e unique. **R√¥le : Simple Reverse Proxy** bas√© sur pr√©fixes API (`/api/v1/...`) vers les services backend correspondants (configur√© via `httpx` ou lib proxy). **G√®re l'authentification/autorisation** via `fastapi-users` (JWT) avant de relayer les requ√™tes. *Statut: ‚úÖ Auth fonctionnelle, üöß Routage pending.* | Logique m√©tier dans la gateway (√† √©viter). Agr√©gation de services (complexit√© inutile pour PoC).                                                                                                                                                                                          |
| **Service S√©lection (`service-selection/`)** | FastAPI + SQLAlchemy + Pydantic + **Alembic** | **Maintenu**. Gestion m√©tadonn√©es datasets. **Mod√®le BDD `datasets`** (cf. PRD v2). **Migrations via Alembic obligatoires**. **Scoring** via `POST /datasets/score` (somme pond√©r√©e, focus PoC: bool√©ens + `num_citations` normalis√©). **Recherche** via `GET /datasets` (filtres dynamiques). **Preview** via `GET /.../preview` (approche robuste recommand√©e: extrait stock√© sur PV/Blob). **R√©f√©rence fichier** (`file_reference`) pointe vers PV (PoC) / Blob (Prod). *Statut: üöß Advanced.* | Stockage de fichiers dans PostgreSQL (non). Pas de migrations (non maintenable). Scoring simpliste.                                                                                                                                                                                        |
| **ML Pipeline Service (`ml-pipeline/`)** | FastAPI + Celery + Scikit-learn + Pydantic | **Maintenu**. Orchestration async entra√Ænement. **Mod√®le BDD `PipelineRun`** (g√©r√© via Alembic). **Sauvegarde mod√®les** (`.joblib`/`.h5`) sur PV (PoC) / Blob (Prod) via `model_reference`. **Transmission donn√©es aux workers via r√©f√©rence** (`dataset_reference`). T√¢che Celery `run_ml_pipeline_task` (chargement, pr√©traitement simple, train, eval, save). *Statut: ‚¨ú √Ä d√©marrer.* | Transmission donn√©es par valeur (limit√©). Stockage mod√®le en BDD (non pratique).                                                                                                                                                                                                             |
| **XAI Service (`xai-engine/`)** | FastAPI + Celery + SHAP / LIME              | **Maintenu**. G√©n√©ration async explications. **Mod√®le BDD `ExplanationRequest`** (g√©r√© via Alembic). **Stockage r√©sultats XAI** (JSON/PNG) sur PV (PoC) / Blob (Prod) via `results_reference` (JSONB/TEXT[] listant les chemins/URLs). **Adaptation sortie √† l'audience** (novice/expert/d√©cideur) dans la t√¢che Celery `generate_explanation_task`. M√©thode XAI de base (SHAP/LIME) pour PoC. *Statut: ‚¨ú √Ä d√©marrer.* | Stockage r√©sultats XAI directement en BDD (moins flexible pour images/gros JSON). Recommandation XAI complexe (hors scope PoC).                                                                                                                                                            |
| **Base de donn√©es** | PostgreSQL                                  | **Maintenu**. **Prod Azure:** Azure Database for PostgreSQL (service manag√©). **Local:** Instance d√©ploy√©e via Helm chart Bitnami sur Minikube avec PVC. **Sch√©ma g√©r√© via Alembic** (initialis√© dans `service-selection`, potentiellement partag√© ou sch√©mas s√©par√©s pour autres services si besoin). *Statut: ‚úÖ Base d√©ploy√©e (local), ‚¨ú Alembic init pending.* | SQLite (Inadapt√© pour relations complexes et concurrence). MySQL (PostgreSQL souvent pr√©f√©r√© pour fonctionnalit√©s avanc√©es comme ARRAY/JSONB).                                                                                                                                             |
| **Message Broker / Backend**| Redis                                       | **Maintenu**. Standard pour Celery. **Prod Azure:** Azure Cache for Redis (service manag√©). **Local:** Instance d√©ploy√©e via Helm chart Bitnami sur Minikube. *Statut: ‚¨ú √Ä d√©ployer (local).* | RabbitMQ (Plus complexe √† g√©rer pour ce besoin). Kafka (Surdimensionn√© pour simple task queue).                                                                                                                                                                                                 |
| **Task Queue Workers** | Celery                                      | **Maintenu**. Ex√©cution asynchrone ML/XAI. **Prod Azure:** **Pools de workers distincts** (Deployments K8s s√©par√©s) pour ML et XAI avec queues d√©di√©es (`ml_queue`, `xai_queue`) pour scalabilit√©/ressources sp√©cifiques (GPU). **Local PoC:** Pool unique √©coutant toutes les queues pour simplifier. *Statut: ‚¨ú √Ä d√©ployer (worker de base).* | Ex√©cution synchrone (bloquant). Alternatives moins int√©gr√©es √† Python/FastAPI.                                                                                                                                                                                                           |
| **Orchestration** | Docker + K8s (Minikube / AKS) + **Skaffold** + **Kustomize** | **Maintenu**. **Local:** Minikube. **Prod:** AKS. **Utilisation active de Skaffold** (`skaffold.yaml`) pour le workflow de dev local (build/deploy auto). **Utilisation active de Kustomize** (`k8s/base/`, `k8s/overlays/minikube/`, `k8s/overlays/azure/`) pour g√©rer les configurations K8s par environnement. *Statut: ‚úÖ Base K8s pr√™te, ‚¨ú Skaffold/Kustomize config pending.* | Docker Compose (limit√© au local, moins repr√©sentatif). D√©ploiement manuel K8s (fastidieux, erreurs).                                                                                                                                                                                   |
| **Ingress** | **NGINX Ingress Controller** / Azure AGIC   | **Maintenu**. **Local/Prod D√©part:** NGINX Ingress Controller (d√©ploy√© via Helm sur Minikube/AKS). G√®re l'exposition des services (Gateway, Frontend) via une ressource `Ingress` K8s. **Prod Azure Option:** AGIC si int√©gration avanc√©e avec Azure Application Gateway requise (WAF, etc.). *Statut: ‚¨ú √Ä configurer (NGINX).* | Services K8s de type `LoadBalancer` (co√ªteux, un par service). `NodePort` (difficile √† g√©rer). `kubectl port-forward` (manuel, pour debug seulement).                                                                                                                                     |
| **Documentation** | Antora (Asciidoc)                           | **Maintenu (Obligatoire)**. Contrainte projet pour g√©n√©ration de documentation structur√©e √† partir de sources Asciidoc. *Statut: ‚úÖ Base structure ready.* | Documentation manuelle non structur√©e. Autres g√©n√©rateurs (Sphinx, MkDocs) - Antora impos√© ici.                                                                                                                                                                                          |
| **Stockage Fichiers** | **Volume Persistant K8s (Local)** / **Azure Blob Storage (Prod)** | **Clarifi√©**. Stockage externe aux conteneurs pour datasets r√©f√©renc√©s, mod√®les ML, r√©sultats XAI. **Local:** PVC K8s (ex: `ReadWriteOnce` mont√© sur les pods n√©cessaires). **Prod:** Azure Blob Storage (acc√®s via SDK Azure et credentials/Managed Identity). La BDD contient seulement les *r√©f√©rences* (`file_reference`, `model_reference`, `results_reference`). *Statut: ‚¨ú PVC definition / Blob integration pending.* | Stockage dans l'image Docker (non persistant). Stockage direct en BDD (inefficace pour gros fichiers).                                                                                                                                                                                          |

## Points Cl√©s et Justifications Additionnelles

* **Angular Material vs Tailwind :** Le choix d'Angular Material comme biblioth√®que UI principale vise √† maximiser la productivit√© du d√©veloppement frontend pour la PoC en fournissant des composants pr√™ts √† l'emploi et coh√©rents, tout en permettant une personnalisation via Tailwind si n√©cessaire.
* **Alembic :** Son utilisation est non n√©gociable pour assurer la maintenabilit√© et la reproductibilit√© des √©volutions du sch√©ma de base de donn√©es. Doit √™tre int√©gr√© d√®s la premi√®re d√©finition de table.
* **Stockage Fichiers :** La strat√©gie de r√©f√©rence (stocker le chemin/URL en BDD, le fichier sur PV/Blob) est cruciale pour d√©coupler les services et g√©rer des volumes de donn√©es potentiellement importants.
* **Workers Celery Distincts (Prod) :** Essentiel pour la performance et la gestion des ressources en production, permettant d'allouer par exemple des n≈ìuds GPU sp√©cifiquement aux workers ML.
* **Skaffold/Kustomize :** Ces outils sont activement int√©gr√©s au workflow pour automatiser le d√©veloppement local et g√©rer proprement les configurations multi-environnements K8s, conform√©ment aux bonnes pratiques DevOps modernes.
* **NGINX Ingress :** Choix pragmatique et standard pour l'Ingress Controller, suffisant pour la PoC et de nombreuses applications en production.

Cette stack technologique d√©taill√©e et justifi√©e fournit une base solide et pr√©cise pour le d√©veloppement de la PoC EXAI, en tenant compte des exigences de maintenabilit√©, d'√©volutivit√© et des sp√©cificit√©s du d√©ploiement local et cloud.
