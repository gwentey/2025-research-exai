.PHONY: help install test-auth import-all import-dataset import-small force-refresh status clean

# Afficher l'aide
help:
	@echo "ğŸš€ SystÃ¨me d'Import Kaggle EXAI"
	@echo "================================="
	@echo ""
	@echo "Commandes disponibles :"
	@echo "  install      - Installer les dÃ©pendances"
	@echo "  test-auth    - Tester l'authentification Kaggle"
	@echo "  import-all   - Importer tous les datasets"
	@echo "  import-small - Importer seulement les petits datasets"
	@echo "  import-dataset DATASET=nom - Importer un dataset spÃ©cifique"
	@echo "  force-refresh - Forcer le re-tÃ©lÃ©chargement (ignore cache)"
	@echo "  status       - Afficher l'Ã©tat des imports"
	@echo "  clean        - Nettoyer les fichiers temporaires"
	@echo ""
	@echo "Configuration requise :"
	@echo "  - Kaggle API credentials dans ~/.kaggle/kaggle.json"
	@echo "  - Variables d'environnement pour BDD et stockage"
	@echo ""
	@echo "Exemples :"
	@echo "  make import-dataset DATASET=student_performance"
	@echo "  make import-small"
	@echo "  make force-refresh"

# Installer les dÃ©pendances
install:
	@echo "ğŸ“¦ Installation des dÃ©pendances..."
	pip install -r requirements.txt

# Tester l'authentification Kaggle
test-auth:
	@echo "ğŸ”‘ Test de l'authentification Kaggle..."
	python -c "import kaggle; kaggle.api.authenticate(); print('âœ… Authentification rÃ©ussie')"

# Importer tous les datasets
import-all:
	@echo "ğŸš€ Import de tous les datasets depuis Kaggle..."
	python kaggle_importer.py

# Importer seulement les petits datasets (exclut riiid et oulad)
import-small:
	@echo "âš¡ Import des datasets de taille modÃ©rÃ©e..."
	python kaggle_importer.py --dataset student_performance
	python kaggle_importer.py --dataset student_stress
	python kaggle_importer.py --dataset student_depression
	python kaggle_importer.py --dataset social_media_addiction
	python kaggle_importer.py --dataset academic_performance

# Importer un dataset spÃ©cifique
import-dataset:
	@if [ -z "$(DATASET)" ]; then \
		echo "âŒ Erreur: SpÃ©cifiez DATASET=nom_dataset"; \
		echo "Datasets disponibles:"; \
		python -c "import yaml; config=yaml.safe_load(open('kaggle_datasets_config.yaml')); [print(f'  - {name}') for name in config['datasets'].keys()]"; \
		exit 1; \
	fi
	@echo "ğŸ“¥ Import du dataset: $(DATASET)"
	python kaggle_importer.py --dataset $(DATASET)

# Forcer le re-tÃ©lÃ©chargement
force-refresh:
	@echo "ğŸ”„ Re-tÃ©lÃ©chargement forcÃ© de tous les datasets..."
	python kaggle_importer.py --force-refresh

# Afficher l'Ã©tat des imports
status:
	@echo "ğŸ“Š Ã‰tat des imports Kaggle"
	@echo "=========================="
	@echo ""
	@echo "Cache disponible :"
	@ls -la cache/ 2>/dev/null || echo "  Aucun cache trouvÃ©"
	@echo ""
	@echo "Logs rÃ©cents :"
	@tail -n 10 kaggle_import.log 2>/dev/null || echo "  Aucun log trouvÃ©"
	@echo ""
	@echo "Configuration :"
	@python -c "import yaml; config=yaml.safe_load(open('kaggle_datasets_config.yaml')); print(f'  Datasets configurÃ©s: {len(config[\"datasets\"])}')"

# Nettoyer les fichiers temporaires
clean:
	@echo "ğŸ§¹ Nettoyage des fichiers temporaires..."
	rm -rf cache/
	rm -f kaggle_import.log
	rm -rf __pycache__/
	rm -rf *.pyc
	@echo "âœ… Nettoyage terminÃ©"

# VÃ©rifier la configuration
check-config:
	@echo "ğŸ” VÃ©rification de la configuration..."
	@python -c "import yaml; yaml.safe_load(open('kaggle_datasets_config.yaml')); print('âœ… Configuration YAML valide')"
	@echo "Variables d'environnement requises :"
	@python -c "import os; required=['DATABASE_URL', 'STORAGE_BACKEND']; missing=[v for v in required if not os.getenv(v)]; print(f'âŒ Manquantes: {missing}' if missing else 'âœ… Toutes prÃ©sentes')"

# Lister les datasets disponibles
list-datasets:
	@echo "ğŸ“‹ Datasets configurÃ©s :"
	@python -c "import yaml; config=yaml.safe_load(open('kaggle_datasets_config.yaml')); [print(f'  - {name:25} ({info[\"domain\"]:15}) {info[\"kaggle_ref\"]}') for name, info in config['datasets'].items()]"

# Test de connexion aux services
test-services:
	@echo "ğŸ”— Test de connexion aux services..."
	@echo "Base de donnÃ©es :"
	@python -c "from service_selection.app.database import get_db_session; next(get_db_session()); print('âœ… Connexion BDD OK')" 2>/dev/null || echo "âŒ Connexion BDD Ã©chouÃ©e"
	@echo "Stockage d'objets :"
	@python -c "from common.storage_client import get_storage_client; client = get_storage_client(); print('âœ… Client stockage OK')" 2>/dev/null || echo "âŒ Client stockage Ã©chouÃ©" 