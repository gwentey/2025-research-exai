<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Gestion des Migrations de Base de Donn√©es avec Alembic :: Documentation 2025 Research EXAI</title>
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="/">Documentation 2025 Research EXAI</a>
      <button class="navbar-burger" aria-controls="topbar-nav" aria-expanded="false" aria-label="Toggle main menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="EXAI" data-version="1.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../index.html">Documentation Principale</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Accueil Projet EXAI</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../getting-started.html">üöÄ Installation &amp; D√©marrage</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Guide Utilisateur</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../user-guide/index.html">Pr√©sentation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../user-guide/dataset-selection.html">üìä S√©lection de Datasets</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../user-guide/ml-pipeline.html">üõ†Ô∏è Pipeline ML Interactif</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../user-guide/xai-recommendation.html">üí° Recommandations XAI</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Guide D√©veloppeur</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../dev-guide/index.html">Pr√©sentation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../dev-guide/architecture.html">Architecture Technique</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="database-migrations.html">Migrations Base de Donn√©es (Alembic)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../dev-guide/api-reference.html">R√©f√©rence API</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Documentation Principale</span>
    <span class="version">1.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <div class="title"><a href="../index.html">Documentation Principale</a></div>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Documentation Principale</a></li>
    <li>Guide D√©veloppeur</li>
    <li><a href="database-migrations.html">Migrations Base de Donn√©es (Alembic)</a></li>
  </ul>
</nav>
<div class="edit-this-page"><a href="file:///C:/xampp/htdocs/2025-research-exai/docs/modules/ROOT/pages/development/database-migrations.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Gestion des Migrations de Base de Donn√©es avec Alembic</h1>
<div class="sect1">
<h2 id="_contexte_et_objectif"><a class="anchor" href="#_contexte_et_objectif"></a>Contexte et Objectif</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ce projet utilise une base de donn√©es PostgreSQL potentiellement partag√©e par plusieurs microservices (<code>api-gateway</code>, <code>service-selection</code>, etc.).
Il est crucial que les modifications du sch√©ma de la base de donn√©es (ajout de tables, modification de colonnes&#8230;&#8203;) soient g√©r√©es de mani√®re :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Robuste et Fiable :</strong> Pour √©viter les erreurs et la corruption des donn√©es.</p>
</li>
<li>
<p><strong>Versionn√©e :</strong> Pour pouvoir suivre les changements et revenir en arri√®re si n√©cessaire.</p>
</li>
<li>
<p><strong>Reproductible :</strong> Pour garantir que l&#8217;√©tat de la base de donn√©es est coh√©rent entre les environnements (d√©veloppement, production).</p>
</li>
<li>
<p><strong>Adapt√©e aux Microservices :</strong> Pour que chaque service puisse g√©rer ind√©pendamment le sch√©ma des tables dont il est responsable.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Pour r√©pondre √† ces exigences, nous utilisons l&#8217;outil <strong>Alembic</strong>, un standard dans l&#8217;√©cosyst√®me SQLAlchemy.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Cette approche remplace les √©ventuels scripts d&#8217;initialisation SQL statiques, qui sont moins flexibles et plus difficiles √† maintenir √† long terme.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_approche_microservices_ind√©pendance_des_migrations"><a class="anchor" href="#_approche_microservices_ind√©pendance_des_migrations"></a>Approche Microservices : Ind√©pendance des Migrations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Principe fondamental : <strong>Chaque microservice qui interagit avec la base de donn√©es poss√®de son propre environnement Alembic ind√©pendant.</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>api-gateway</code> g√®re les migrations pour ses tables (ex: <code>user</code>).</p>
</li>
<li>
<p><code>service-selection</code> g√®re les migrations pour ses tables (ex: <code>datasets</code>).</p>
</li>
<li>
<p>Etc. pour les futurs services.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Cela garantit que les services restent faiblement coupl√©s et peuvent √©voluer ind√©pendamment.</p>
</div>
<div class="sect2">
<h3 id="_tables_dhistorique_s√©par√©es"><a class="anchor" href="#_tables_dhistorique_s√©par√©es"></a>Tables d&#8217;Historique S√©par√©es</h3>
<div class="paragraph">
<p>Pour que plusieurs environnements Alembic puissent coexister dans la <strong>m√™me base de donn√©es</strong>, chacun utilise une <strong>table d&#8217;historique distincte</strong> pour suivre les migrations appliqu√©es :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>api-gateway</code> utilise la table <code>alembic_version_gateway</code>.</p>
</li>
<li>
<p><code>service-selection</code> utilise la table <code>alembic_version_selection</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ces noms sont configur√©s dans le fichier <code>alembic.ini</code> de chaque service respectif, via l&#8217;option <code>version_table</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_processus_de_migration_d√©veloppement_local"><a class="anchor" href="#_processus_de_migration_d√©veloppement_local"></a>Processus de Migration (D√©veloppement Local)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Voici les √©tapes pour g√©n√©rer et appliquer des migrations lorsque vous d√©veloppez localement, en interagissant avec la base de donn√©es tournant sur Minikube.</p>
</div>
<div class="sect2">
<h3 id="_pr√©requis"><a class="anchor" href="#_pr√©requis"></a>Pr√©requis</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>D√©pendances Install√©es :</strong> Assurez-vous d&#8217;avoir install√© les d√©pendances Python pour le service concern√© en ex√©cutant <code>pip install -r requirements.txt</code> dans le r√©pertoire du service (ex: <code>api-gateway/</code> ou <code>service-selection/</code>) apr√®s avoir activ√© votre environnement virtuel (<code>.venv</code>).</p>
</li>
<li>
<p><strong>Base de Donn√©es Accessible :</strong> La base de donn√©es PostgreSQL doit √™tre d√©ploy√©e et fonctionnelle sur Minikube (voir guide d&#8217;installation).</p>
</li>
<li>
<p><strong>Tunnel R√©seau (Port Forwarding) :</strong> Comme Alembic s&#8217;ex√©cute sur votre machine locale, il a besoin d&#8217;un moyen d&#8217;atteindre la base de donn√©es √† l&#8217;int√©rieur de Minikube. Ouvrez un <strong>terminal distinct</strong> et lancez la commande suivante. <strong>Laissez ce terminal ouvert</strong> pendant que vous travaillez avec Alembic :</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl port-forward service/postgresql-service -n exai 5432:5432</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cela redirige le port <code>5432</code> de votre <code>localhost</code> vers le service PostgreSQL dans Minikube.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_de_la_connexion_locale_env"><a class="anchor" href="#_configuration_de_la_connexion_locale_env"></a>Configuration de la Connexion Locale (<code>.env</code>)</h3>
<div class="paragraph">
<p>Pour qu&#8217;Alembic (et votre application en local) sache comment se connecter √† la base de donn√©es via le tunnel, vous devez configurer l&#8217;URL de connexion. La m√©thode recommand√©e est d&#8217;utiliser un fichier <code>.env</code>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Cr√©ez (ou modifiez)</strong> un fichier nomm√© <code>.env</code> √† la racine du r√©pertoire de <strong>chaque service</strong> concern√© (ex: <code>api-gateway/.env</code>, <code>service-selection/.env</code>).</p>
</li>
<li>
<p>Ajoutez la ligne suivante dans chaque fichier <code>.env</code>, en adaptant les identifiants si n√©cessaire (ils doivent correspondre √† ceux configur√©s dans PostgreSQL) :</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Exemple de contenu pour <code>.env</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-dotenv hljs" data-lang="dotenv">DATABASE_URL="postgresql+asyncpg://exai_user:password@localhost:5432/exai_db"
SECRET_KEY="votre_cle_secrete_pour_api_gateway" # Uniquement pour api-gateway/.env</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>postgresql+asyncpg://</code> : Indique l&#8217;utilisation du pilote asynchrone <code>asyncpg</code>.</p>
</li>
<li>
<p><code>exai_user:password</code> : Remplacez par l&#8217;utilisateur et le mot de passe r√©els de votre base <code>exai_db</code>.</p>
</li>
<li>
<p><code>localhost:5432</code> : Pointe vers le tunnel cr√©√© par <code>kubectl port-forward</code>.</p>
</li>
<li>
<p><code>exai_db</code> : Le nom de votre base de donn√©es.</p>
</li>
<li>
<p><code>SECRET_KEY</code> : N√©cessaire pour <code>api-gateway</code>, utilisez une cl√© secr√®te forte (voir configuration JWT).</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Ne commitez JAMAIS</strong> votre fichier <code>.env</code> dans Git ! Ajoutez <code>.env</code> √† votre fichier <code>.gitignore</code> global ou √† celui de chaque service.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_g√©n√©ration_dune_nouvelle_migration"><a class="anchor" href="#_g√©n√©ration_dune_nouvelle_migration"></a>G√©n√©ration d&#8217;une Nouvelle Migration</h3>
<div class="paragraph">
<p>Chaque fois que vous modifiez un mod√®le SQLAlchemy (ex: ajout d&#8217;une colonne dans <code>app/models.py</code> du service concern√©), vous devez g√©n√©rer un script de migration.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ouvrez votre terminal principal.</p>
</li>
<li>
<p>Assurez-vous d&#8217;√™tre dans le r√©pertoire du <strong>service concern√©</strong> (ex: <code>cd api-gateway</code>).</p>
</li>
<li>
<p>Assurez-vous que votre environnement virtuel est activ√©.</p>
</li>
<li>
<p>Lancez la commande <code>autogenerate</code> :</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># Remplacez "Description concise du changement" par un message clair
alembic revision --autogenerate -m "Description concise du changement"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alembic va :
*   Lire la variable <code>DATABASE_URL</code> de votre environnement (priorit√© √† une variable d√©finie directement dans le terminal, sinon lecture du <code>.env</code>).
*   Se connecter √† la base de donn√©es via le tunnel <code>port-forward</code>.
*   Comparer l&#8217;√©tat actuel de la base avec les mod√®les d√©finis dans le code Python du service.
*   G√©n√©rer un nouveau fichier Python dans le sous-dossier <code>alembic/versions/</code> contenant les op√©rations <code>op.</code> n√©cessaires (ex: <code>op.add_column(&#8230;&#8203;)</code>).</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>V√©rifiez TOUJOURS</strong> le contenu du fichier de migration g√©n√©r√© ! <code>autogenerate</code> n&#8217;est pas parfait, surtout dans un contexte de base partag√©e. Assurez-vous qu&#8217;il ne contient pas d&#8217;op√©rations inattendues, notamment des <code>op.drop_table()</code> pour des tables appartenant √† d&#8217;autres services. Corrigez manuellement le script si n√©cessaire avant de l&#8217;appliquer.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_application_des_migrations"><a class="anchor" href="#_application_des_migrations"></a>Application des Migrations</h3>
<div class="paragraph">
<p>Pour appliquer les changements d√©finis dans les scripts de migration √† la base de donn√©es :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Assurez-vous que le tunnel <code>port-forward</code> est actif.</p>
</li>
<li>
<p>Depuis le r√©pertoire du service concern√© (avec <code>.venv</code> activ√©), lancez :</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">alembic upgrade head</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cela ex√©cute les fonctions <code>upgrade()</code> de toutes les migrations en attente (celles qui ne sont pas encore enregistr√©es dans la table d&#8217;historique du service : <code>alembic_version_gateway</code> ou <code>alembic_version_selection</code>).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_processus_de_migration_d√©ploiementproduction"><a class="anchor" href="#_processus_de_migration_d√©ploiementproduction"></a>Processus de Migration (D√©ploiement/Production)</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>L&#8217;application des migrations en production (ou sur des environnements de staging/pr√©-production) ne se fait <strong>PAS</strong> manuellement via <code>kubectl port-forward</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le processus standard dans un pipeline de d√©ploiement (CI/CD) est d&#8217;utiliser un <strong>Kubernetes Job</strong> :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Le pipeline construit la nouvelle image Docker du service.</p>
</li>
<li>
<p>Avant de d√©ployer le service lui-m√™me, le pipeline lance un Job Kubernetes.</p>
</li>
<li>
<p>Ce Job utilise la m√™me image Docker (ou une image d√©di√©e aux migrations) et ex√©cute la commande <code>alembic upgrade head</code> <strong>depuis l&#8217;int√©rieur du cluster</strong>.</p>
</li>
<li>
<p>Le Job r√©cup√®re l&#8217;URL de la base de donn√©es et les identifiants depuis les <strong>Secrets Kubernetes</strong>, lui permettant de se connecter directement au service PostgreSQL interne.</p>
</li>
<li>
<p>Le pipeline attend que le Job se termine avec succ√®s avant de d√©ployer la nouvelle version du service applicatif.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Cette approche garantit que les migrations sont appliqu√©es de mani√®re automatis√©e et s√©curis√©e, en utilisant les configurations de l&#8217;environnement cible.</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
